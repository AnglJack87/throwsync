<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="/pwa-icon-192.svg" type="image/svg+xml">
    <title>ThrowSync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #16161f;
            --bg-card-hover: #1c1c28;
            --bg-input: #1a1a25;
            --border: #2a2a3a;
            --border-bright: #3a3a55;
            --text-primary: #e8e8f0;
            --text-secondary: #9090a8;
            --text-dim: #606078;
            --accent: #6c5ce7;
            --accent-bright: #a29bfe;
            --accent-glow: rgba(108, 92, 231, 0.3);
            --success: #00d68f;
            --warning: #f0a030;
            --danger: #ff4757;
            --info: #00b4d8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-logo {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent-bright), #fd79a8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.3;
        }

        .sidebar-logo .version {
            font-size: 11px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 4px;
        }

        .nav-section {
            padding: 16px 12px 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            margin: 2px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 12px var(--accent-glow);
        }

        .nav-icon { font-size: 18px; width: 22px; text-align: center; }

        .sidebar-footer {
            margin-top: auto;
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.online { background: var(--success); box-shadow: 0 0 8px rgba(0, 214, 143, 0.5); }
        .status-dot.offline { background: var(--danger); }
        .status-dot.connecting { background: var(--warning); animation: pulse 1.5s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Main content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 32px;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-header h2 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }

        .card:hover { border-color: var(--border-bright); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

        /* Device card */
        .device-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .device-card .led-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }

        .device-card .device-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .device-card .device-ip {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .device-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-dim);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .btn:hover { border-color: var(--border-bright); background: var(--bg-card-hover); }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .btn-primary:hover {
            background: var(--accent-bright);
            border-color: var(--accent-bright);
            box-shadow: 0 2px 12px var(--accent-glow);
        }

        .btn-success { background: var(--success); border-color: var(--success); color: #0a0a0f; }
        .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .btn-icon { padding: 8px; min-width: 36px; justify-content: center; }

        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"], input[type="number"], input[type="password"], select, textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Range slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid white;
        }

        /* Toggle */
        .toggle {
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle.active { background: var(--accent); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
        }

        .toggle.active::after { transform: translateX(20px); }

        /* Color picker */
        .color-swatch {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }

        .color-swatch:hover { border-color: var(--accent); transform: scale(1.1); }

        input[type="color"] {
            width: 48px;
            height: 48px;
            padding: 2px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            cursor: pointer;
        }

        /* LED strip visualizer */
        .led-strip {
            display: flex;
            gap: 2px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .led-pixel {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .led-pixel:hover {
            transform: scale(1.3);
            z-index: 1;
            box-shadow: 0 0 8px currentColor;
        }

        .led-pixel.selected {
            border: 2px solid white;
            box-shadow: 0 0 12px currentColor;
        }

        /* Event mapping cards */
        .event-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .event-card:hover { border-color: var(--border-bright); }

        .event-preview {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .event-info { flex: 1; min-width: 0; }
        .event-info h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .event-info p { font-size: 12px; color: var(--text-dim); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-bright));
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-primary);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 18px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--accent); color: white; }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: rgba(0,214,143,0.15); color: var(--success); }
        .badge-danger { background: rgba(255,71,87,0.15); color: var(--danger); }
        .badge-info { background: rgba(0,180,216,0.15); color: var(--info); }
        .badge-warning { background: rgba(240,160,48,0.15); color: var(--warning); }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } }

        /* Mini Player */
        .mini-player {
            position: fixed; bottom: 0; left: 260px; right: 0;
            height: 56px; background: rgba(18,18,26,0.97);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            display: flex; align-items: center; gap: 12px; padding: 0 16px;
            z-index: 150; transition: transform 0.3s ease;
        }
        .mini-player.hidden { transform: translateY(100%); }
        .mini-player .mp-art { width: 40px; height: 40px; border-radius: 6px; background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        .mini-player .mp-art img { width: 100%; height: 100%; border-radius: 6px; object-fit: cover; }
        .mini-player .mp-info { flex: 1; min-width: 0; }
        .mini-player .mp-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-player .mp-artist { font-size: 11px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-player .mp-controls { display: flex; align-items: center; gap: 4px; }
        .mini-player .mp-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 16px; padding: 4px 6px; border-radius: 4px; transition: color 0.15s; }
        .mini-player .mp-btn:hover { color: var(--text-primary); }
        .mini-player .mp-btn.play { font-size: 22px; color: var(--accent); }
        .mini-player .mp-vol { width: 80px; accent-color: var(--accent); }
        .mini-player .mp-src { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; letter-spacing: 0.5px; }
        .mini-player .mp-src.local { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .mini-player .mp-src.spotify { background: rgba(30,215,96,0.2); color: #1ed760; }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: 1fr 1fr; }
            .grid-4 { grid-template-columns: repeat(3, 1fr); }
        }

        /* Tablet / iPad (641px - 1024px): Compact sidebar (icons only) */
        @media (min-width: 641px) and (max-width: 1024px) {
            .sidebar {
                width: 64px; padding: 12px 4px; gap: 2px;
            }
            .sidebar-logo h1 { font-size: 10px; letter-spacing: 1px; }
            .sidebar-logo .version { font-size: 8px; }
            .nav-section { font-size: 0; height: 8px; margin: 4px 0; }
            .nav-item { flex-direction: column; gap: 2px; padding: 8px 4px; border-radius: 8px; text-align: center; justify-content: center; }
            .nav-item .nav-icon { font-size: 18px; }
            .nav-item span:last-child { font-size: 8px; line-height: 1.1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 56px; }
            .sidebar-footer { font-size: 0; padding: 4px; }
            .sidebar-footer * { font-size: 0; }
            .sidebar-footer .status-dot { font-size: initial; }
            .main-content { margin-left: 64px; padding: 16px 16px 80px 16px; }
            .mini-player { left: 64px; }
            .grid-2, .grid-3 { grid-template-columns: 1fr 1fr; }
            .page-header h2 { font-size: 22px; }
        }

        /* Mobile (‚â§640px): Bottom nav bar */
        @media (max-width: 640px) {
            .sidebar {
                position: fixed; top: auto; left: 0; right: 0; bottom: 0;
                width: 100%; height: auto; flex-direction: row;
                border-right: none; border-top: 1px solid var(--border);
                overflow-x: auto; z-index: 200;
                padding: 0 4px; gap: 0;
                -webkit-overflow-scrolling: touch;
                background: rgba(18,18,26,0.95); backdrop-filter: blur(12px);
            }
            .sidebar-logo, .nav-section, .sidebar-footer { display: none; }
            .sidebar .nav-item {
                flex-direction: column; gap: 2px; padding: 8px 6px;
                min-width: 56px; text-align: center; flex-shrink: 0;
                font-size: 10px; border-radius: 8px; margin: 4px 2px;
            }
            .sidebar .nav-item .nav-icon { font-size: 18px; }
            .sidebar .nav-item span:last-child { font-size: 9px; line-height: 1.1; }
            .sidebar .nav-item.active { background: var(--accent); }
            .main-content {
                margin-left: 0; padding: 12px 12px 136px 12px;
            }
            .mini-player { left: 0; bottom: 58px; height: 48px; padding: 0 10px; gap: 8px; }
            .mini-player .mp-vol { display: none; }
            .mini-player .mp-src { display: none; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .page-header h2 { font-size: 22px; }
            .modal { margin: 8px; max-height: 88vh; }
            .modal-overlay { align-items: flex-end; }
            .card { padding: 14px; }
            .event-card { flex-wrap: wrap; gap: 8px; }
            .event-card .event-info { min-width: calc(100% - 60px); }
            .profile-bar { flex-wrap: wrap; }
        }

        @media (max-width: 380px) {
            .sidebar .nav-item { min-width: 48px; padding: 6px 4px; }
            .sidebar .nav-item span:last-child { display: none; }
            .main-content { padding: 8px 8px 72px 8px; }
        }

        /* LED Cards grid ‚Äî responsive */
        .led-cards-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;
        }
        @media (max-width: 640px) {
            .led-cards-grid { grid-template-columns: 1fr; }
        }

        /* Profile bar */
        .profile-bar {
            display: flex; gap: 8px; padding: 10px 0; margin-bottom: 16px;
            overflow-x: auto; -webkit-overflow-scrolling: touch;
        }
        .profile-chip {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            background: var(--bg-card); border: 1px solid var(--border);
            font-size: 13px; white-space: nowrap; transition: all 0.2s;
            flex-shrink: 0;
        }
        .profile-chip:hover { border-color: var(--accent); }
        .profile-chip.active {
            background: var(--accent); border-color: var(--accent);
            color: white; font-weight: 600;
        }

        /* Touch-friendly controls */
        @media (pointer: coarse) {
            .btn, button { min-height: 40px; min-width: 40px; }
            .toggle { transform: scale(1.1); }
            input[type=range] { height: 28px; }
            select, input[type=text], input[type=number], input[type=password] {
                min-height: 42px; font-size: 16px;
            }
        }

        /* Chain builder */
        .chain-step {
            display: flex; gap: 8px; align-items: center;
            padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;
            border: 1px solid var(--border);
        }
        .chain-step:hover { border-color: var(--accent); }

        /* Player color dots */
        .player-dot {
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: all 0.2s;
        }
        .player-dot.active { border-color: white; transform: scale(1.15); }

        /* Schedule timeline */
        .schedule-entry {
            display: flex; gap: 12px; align-items: center; padding: 10px 12px;
            background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo, createContext, useContext } = React;

// ‚îÄ‚îÄ‚îÄ API Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const API = {
    base: window.location.origin,

    async get(path) {
        try {
            const res = await fetch(`${this.base}${path}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            console.error(`GET ${path}:`, e);
            return null;
        }
    },

    async post(path, data = {}) {
        try {
            const res = await fetch(`${this.base}${path}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            console.error(`POST ${path}:`, e);
            return null;
        }
    },

    async del(path) {
        try {
            const res = await fetch(`${this.base}${path}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            console.error(`DELETE ${path}:`, e);
            return null;
        }
    },

    async put(path, data = {}) {
        try {
            const res = await fetch(`${this.base}${path}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            console.error(`PUT ${path}:`, e);
            return null;
        }
    }
};


// ‚îÄ‚îÄ‚îÄ Toast System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const ToastContext = createContext();

function ToastProvider({ children }) {
    const [toasts, setToasts] = useState([]);

    const addToast = useCallback((message, type = 'info') => {
        const id = Date.now();
        setToasts(t => [...t, { id, message, type }]);
        setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 4000);
    }, []);

    return (
        <ToastContext.Provider value={addToast}>
            {children}
            <div className="toast-container">
                {toasts.map(t => (
                    <div key={t.id} className="toast" style={{
                        borderLeftColor: t.type === 'success' ? 'var(--success)' :
                            t.type === 'error' ? 'var(--danger)' : 'var(--info)',
                        borderLeftWidth: 3
                    }}>
                        <span>{t.type === 'success' ? '‚úì' : t.type === 'error' ? '‚úó' : '‚Ñπ'}</span>
                        {t.message}
                    </div>
                ))}
            </div>
        </ToastContext.Provider>
    );
}

function useToast() { return useContext(ToastContext); }


// ‚îÄ‚îÄ‚îÄ i18n System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const I18nContext = createContext({ t: (k) => k, lang: 'de', setLang: () => {} });

function I18nProvider({ children }) {
    const [lang, setLangState] = useState('de');
    const [translations, setTranslations] = useState({});
    const [loaded, setLoaded] = useState(false);

    useEffect(() => {
        // Load current language from backend
        API.get('/api/i18n').then(data => {
            if (data?.current) {
                setLangState(data.current);
                API.get(`/api/i18n/${data.current}`).then(d => {
                    if (d?.translations) setTranslations(d.translations);
                    setLoaded(true);
                });
            } else {
                setLoaded(true);
            }
        }).catch(() => setLoaded(true));
    }, []);

    const setLang = useCallback((newLang) => {
        setLangState(newLang);
        API.post('/api/i18n', { language: newLang });
        API.get(`/api/i18n/${newLang}`).then(d => {
            if (d?.translations) setTranslations(d.translations);
        });
    }, []);

    const t = useCallback((key, fallback) => {
        return translations[key] || fallback || key;
    }, [translations]);

    return (
        <I18nContext.Provider value={{ t, lang, setLang, loaded }}>
            {children}
        </I18nContext.Provider>
    );
}

function useI18n() { return useContext(I18nContext); }


// ‚îÄ‚îÄ‚îÄ WebSocket Hook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function useWebSocket() {
    const [ws, setWs] = useState(null);
    const [lastMessage, setLastMessage] = useState(null);
    const reconnectRef = useRef(null);

    const connect = useCallback(() => {
        const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${proto}//${window.location.host}/ws`);
        socket.onmessage = (e) => setLastMessage(JSON.parse(e.data));
        socket.onopen = () => {
            console.log('WS connected');
            if (reconnectRef.current) {
                clearInterval(reconnectRef.current);
                reconnectRef.current = null;
                // Reload page on reconnect after update
                window.location.reload();
            }
        };
        socket.onclose = () => {
            console.log('WS disconnected, reconnecting...');
            setWs(null);
            if (!reconnectRef.current) {
                reconnectRef.current = setInterval(() => {
                    try { connect(); } catch(e) {}
                }, 3000);
            }
        };
        setWs(socket);
        return socket;
    }, []);

    useEffect(() => {
        const socket = connect();
        return () => {
            if (reconnectRef.current) clearInterval(reconnectRef.current);
            socket.close();
        };
    }, []);

    return { ws, lastMessage };
}


// ‚îÄ‚îÄ‚îÄ Global Music Context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const MusicContext = React.createContext(null);

function MusicProvider({ children }) {
    const [musicFiles, setMusicFiles] = useState([]);
    const [playlist, setPlaylist] = useState([]);
    const [currentTrack, setCurrentTrack] = useState(null);
    const [isPlaying, setIsPlaying] = useState(false);
    const [volume, setVolume] = useState(0.3);
    const [shuffle, setShuffle] = useState(false);
    const [repeat, setRepeat] = useState(false);
    const [duckOnEvent, setDuckOnEvent] = useState(true);
    const [duckLevel, setDuckLevel] = useState(0.1);
    const audioRef = useRef(null);
    // Spotify state
    const [spotifyState, setSpotifyState] = useState({ connected: false, playing: false, track: '', artist: '', album_art: '' });
    const [source, setSource] = useState('local'); // 'local' | 'spotify'
    const spotifyPollRef = useRef(null);

    // Load config + files on mount
    useEffect(() => {
        API.get('/api/music/files').then(d => setMusicFiles(d?.files || []));
        API.get('/api/music/config').then(d => {
            if (d) {
                setVolume(d.volume ?? 0.3);
                setShuffle(d.shuffle ?? false);
                setRepeat(d.repeat ?? false);
                setDuckOnEvent(d.duck_on_event ?? true);
                setDuckLevel(d.duck_level ?? 0.1);
                setPlaylist(d.playlist || []);
            }
        });
        // Check Spotify connection
        API.get('/api/spotify/config').then(d => {
            if (d?.connected) {
                setSource('spotify');
                pollSpotify();
            }
        });
    }, []);

    const saveConfig = (updates = {}) => {
        const cfg = { volume, shuffle, repeat, duck_on_event: duckOnEvent, duck_level: duckLevel, playlist, ...updates };
        API.post('/api/music/config', cfg);
    };

    // ‚îÄ‚îÄ Local playback ‚îÄ‚îÄ
    const playTrack = (filename) => {
        if (audioRef.current) audioRef.current.pause();
        setSource('local');
        const audio = new Audio('/music/' + filename);
        audio.volume = volume;
        audio.onended = () => playNext(filename);
        audio.play().catch(() => {});
        audioRef.current = audio;
        setCurrentTrack(filename);
        setIsPlaying(true);
    };

    const playNext = (currentFile) => {
        const list = playlist.length > 0 ? playlist : musicFiles.map(f => f.filename);
        if (list.length === 0) return;
        const idx = list.indexOf(currentFile);
        let nextIdx;
        if (shuffle) {
            nextIdx = Math.floor(Math.random() * list.length);
        } else {
            nextIdx = idx + 1;
            if (nextIdx >= list.length) {
                if (repeat) nextIdx = 0;
                else { setIsPlaying(false); setCurrentTrack(null); return; }
            }
        }
        playTrack(list[nextIdx]);
    };

    const togglePlay = () => {
        if (source === 'spotify') {
            if (spotifyState.playing) API.put('/api/spotify/pause').then(pollSpotify);
            else API.put('/api/spotify/play').then(pollSpotify);
            return;
        }
        if (!audioRef.current && musicFiles.length > 0) {
            const list = playlist.length > 0 ? playlist : musicFiles.map(f => f.filename);
            playTrack(list[0]);
            return;
        }
        if (audioRef.current) {
            if (isPlaying) { audioRef.current.pause(); setIsPlaying(false); }
            else { audioRef.current.play(); setIsPlaying(true); }
        }
    };

    const skipNext = () => {
        if (source === 'spotify') { API.post('/api/spotify/next').then(() => setTimeout(pollSpotify, 300)); return; }
        const list = playlist.length > 0 ? playlist : musicFiles.map(f => f.filename);
        playNext(currentTrack || list[0]);
    };

    const skipPrev = () => {
        if (source === 'spotify') { API.post('/api/spotify/prev').then(() => setTimeout(pollSpotify, 300)); return; }
        const list = playlist.length > 0 ? playlist : musicFiles.map(f => f.filename);
        const idx = list.indexOf(currentTrack);
        const prevIdx = idx > 0 ? idx - 1 : list.length - 1;
        playTrack(list[prevIdx]);
    };

    const changeVolume = (v) => {
        setVolume(v);
        if (source === 'spotify') { API.put('/api/spotify/volume/' + Math.round(v * 100)); return; }
        if (audioRef.current) audioRef.current.volume = v;
        saveConfig({ volume: v });
    };

    const stopLocal = () => {
        if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
        setIsPlaying(false); setCurrentTrack(null);
    };

    // ‚îÄ‚îÄ Spotify polling ‚îÄ‚îÄ
    const pollSpotify = () => {
        API.get('/api/spotify/playback').then(d => {
            if (d) {
                setSpotifyState(d);
                if (d.connected && d.playing) {
                    setIsPlaying(true);
                    setCurrentTrack(d.track);
                } else if (d.connected && !d.playing) {
                    setIsPlaying(false);
                }
            }
        });
    };

    // Poll Spotify every 3s when active
    useEffect(() => {
        if (source === 'spotify' && spotifyState.connected) {
            spotifyPollRef.current = setInterval(pollSpotify, 3000);
            return () => clearInterval(spotifyPollRef.current);
        }
    }, [source, spotifyState.connected]);

    // ‚îÄ‚îÄ Music Ducking: lower volume when caller speaks ‚îÄ‚îÄ
    const isDucked = useRef(false);
    const savedVolume = useRef(null);
    const restoreTimer = useRef(null);

    useEffect(() => {
        const handleDuck = () => {
            if (!duckOnEvent || isDucked.current) return;
            // Clear any pending restore
            if (restoreTimer.current) { clearTimeout(restoreTimer.current); restoreTimer.current = null; }
            
            isDucked.current = true;
            savedVolume.current = volume;
            const duckVol = duckLevel; // 0-1 for local, 0-100 for Spotify
            
            if (source === 'spotify' && spotifyState.connected) {
                API.put('/api/spotify/volume/' + Math.round(duckVol * 100)).catch(() => {});
            } else if (audioRef.current) {
                audioRef.current.volume = Math.max(0, duckVol);
            }
        };

        const handleRestore = () => {
            if (!isDucked.current) return;
            // Debounce restore by 300ms in case new sounds come quickly
            if (restoreTimer.current) clearTimeout(restoreTimer.current);
            restoreTimer.current = setTimeout(() => {
                const restoreVol = savedVolume.current ?? volume;
                if (source === 'spotify' && spotifyState.connected) {
                    API.put('/api/spotify/volume/' + Math.round(restoreVol * 100)).catch(() => {});
                } else if (audioRef.current) {
                    audioRef.current.volume = restoreVol;
                }
                isDucked.current = false;
                savedVolume.current = null;
                restoreTimer.current = null;
            }, 300);
        };

        window.addEventListener('throwsync-duck', handleDuck);
        window.addEventListener('throwsync-restore', handleRestore);
        return () => {
            window.removeEventListener('throwsync-duck', handleDuck);
            window.removeEventListener('throwsync-restore', handleRestore);
            if (restoreTimer.current) clearTimeout(restoreTimer.current);
        };
    }, [duckOnEvent, duckLevel, volume, source, spotifyState.connected]);

    const value = {
        musicFiles, setMusicFiles, playlist, setPlaylist,
        currentTrack, isPlaying, volume, shuffle, repeat,
        duckOnEvent, duckLevel, source, spotifyState,
        setShuffle, setRepeat, setDuckOnEvent, setDuckLevel, setSource,
        saveConfig, playTrack, playNext, togglePlay, skipNext, skipPrev,
        changeVolume, stopLocal, pollSpotify, audioRef,
    };

    return React.createElement(MusicContext.Provider, { value }, children);
}

function useMusicPlayer() { return useContext(MusicContext); }


// ‚îÄ‚îÄ‚îÄ Mini Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function MiniPlayer() {
    const m = useMusicPlayer();
    if (!m) return null;
    const { currentTrack, isPlaying, volume, source, spotifyState, togglePlay, skipPrev, skipNext, changeVolume } = m;

    // Hide if nothing is playing and never was
    const hasContent = currentTrack || (spotifyState.connected && spotifyState.track);
    if (!hasContent) return null;

    const trackName = source === 'spotify' ? spotifyState.track : (currentTrack ? currentTrack.replace(/\.[^.]+$/, '') : '');
    const artist = source === 'spotify' ? spotifyState.artist : '';
    const albumArt = source === 'spotify' ? spotifyState.album_art : '';

    return (
        <div className="mini-player">
            <div className="mp-art">
                {albumArt ? <img src={albumArt} alt="" /> : (isPlaying ? '\uD83C\uDFB6' : '\uD83C\uDFB5')}
            </div>
            <div className="mp-info">
                <div className="mp-title">{trackName || 'Kein Track'}</div>
                {artist && <div className="mp-artist">{artist}</div>}
            </div>
            <div className="mp-controls">
                <button className="mp-btn" onClick={skipPrev}>{'\u23EE'}</button>
                <button className="mp-btn play" onClick={togglePlay}>{isPlaying ? '\u23F8' : '\u25B6'}</button>
                <button className="mp-btn" onClick={skipNext}>{'\u23ED'}</button>
            </div>
            <input type="range" className="mp-vol" min="0" max="1" step="0.05" value={volume}
                onChange={e => changeVolume(parseFloat(e.target.value))} />
            <span className={'mp-src ' + source}>{source === 'spotify' ? 'SPOTIFY' : 'LOKAL'}</span>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function Sidebar({ activePage, setActivePage, autodartsStatus, boardCount, version }) {
    const { t } = useI18n();
    const sections = [
        { label: null, items: [
            { id: 'dashboard', icon: '\u25C8', label: 'Home' },
        ]},
        { label: 'Spiel', items: [
            { id: 'autodarts', icon: '\u25CE', label: 'Autodarts' },
            { id: 'events', icon: '\u26A1', label: 'Events' },
            { id: 'players', icon: '\uD83C\uDFAD', label: 'Spieler' },
            { id: 'stats', icon: '\uD83D\uDCCA', label: 'Stats' },
            { id: 'achievements', icon: '\uD83C\uDFC5', label: 'Badges' },
        ]},
        { label: 'LED & Audio', items: [
            { id: 'leds', icon: '\u25C6', label: 'LED' },
            { id: 'led-designer', icon: '\uD83D\uDCA1', label: 'Designer' },
            { id: 'music', icon: '\uD83C\uDFB5', label: 'Musik' },
        ]},
        { label: 'System', items: [
            { id: 'devices', icon: '\u2B21', label: t('nav.devices', 'Ger\u00e4te') },
            { id: 'presets', icon: '\u2605', label: 'Presets' },
            { id: 'integrations', icon: '\uD83D\uDD17', label: 'Integration' },
            { id: 'flash', icon: '\u21AF', label: 'Firmware' },
            { id: 'logs', icon: '\uD83D\uDCCB', label: 'Logs' },
            { id: 'settings', icon: '\u2699', label: t('nav.settings', 'Einstellungen') },
        ]},
    ];

    // Flat list for mobile bottom nav (most important items only)
    const mobileItems = [
        { id: 'dashboard', icon: '\u25C8', label: 'Home' },
        { id: 'autodarts', icon: '\u25CE', label: 'Autodarts' },
        { id: 'leds', icon: '\u25C6', label: 'LED' },
        { id: 'events', icon: '\u26A1', label: 'Events' },
        { id: 'music', icon: '\uD83C\uDFB5', label: 'Musik' },
        { id: 'players', icon: '\uD83C\uDFAD', label: 'Spieler' },
        { id: 'stats', icon: '\uD83D\uDCCA', label: 'Stats' },
        { id: 'settings', icon: '\u2699', label: 'Mehr' },
    ];

    // Detect mobile
    const [isMobile, setIsMobile] = useState(window.innerWidth <= 640);
    useEffect(() => {
        const handler = () => setIsMobile(window.innerWidth <= 640);
        window.addEventListener('resize', handler);
        return () => window.removeEventListener('resize', handler);
    }, []);

    if (isMobile) {
        return (
            <div className="sidebar">
                {mobileItems.map(p => (
                    <div key={p.id}
                        className={`nav-item ${activePage === p.id ? 'active' : ''}`}
                        onClick={() => setActivePage(p.id)}>
                        <span className="nav-icon">{p.icon}</span>
                        <span>{p.label}</span>
                    </div>
                ))}
            </div>
        );
    }

    return (
        <div className="sidebar">
            <div className="sidebar-logo">
                <h1>üéØ THROW<br/>SYNC</h1>
                <div className="version">v{version || '...'}</div>
            </div>

            {sections.map((sec, si) => (
                <React.Fragment key={si}>
                    {sec.label && <div className="nav-section">{sec.label}</div>}
                    {sec.items.map(p => (
                        <div key={p.id}
                            className={`nav-item ${activePage === p.id ? 'active' : ''}`}
                            onClick={() => setActivePage(p.id)}>
                            <span className="nav-icon">{p.icon}</span>
                            <span>{p.label}</span>
                        </div>
                    ))}
                </React.Fragment>
            ))}

            <div className="sidebar-footer">
                <div style={{fontSize: 12, color: 'var(--text-dim)'}}>
                    <span className={`status-dot ${autodartsStatus ? 'online' : 'offline'}`}></span>
                    <span>Autodarts {autodartsStatus ? 'verbunden' : 'getrennt'}</span>
                </div>
                {boardCount > 0 && (
                    <div style={{fontSize: 11, color: 'var(--text-dim)', marginTop: 4, marginLeft: 16}}>
                        {boardCount} Board(s) konfiguriert
                    </div>
                )}
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Dashboard Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function DashboardPage({ devices, autodartsConnected }) {
    const [modules, setModules] = useState([]);
    const [toggling, setToggling] = useState(null);
    const [profiles, setProfiles] = useState([]);
    const [activePlayer, setActivePlayer] = useState(null);
    const toast = useToast();
    const { t } = useI18n();

    const loadModules = () => API.get('/api/modules').then(d => { if (d?.modules) setModules(d.modules); });
    useEffect(() => {
        loadModules();
        const iv = setInterval(loadModules, 5000);
        API.get('/api/profiles/players').then(d => {
            const p = d?.profiles || [];
            setProfiles(p);
            const aid = d?.active;
            if (aid) setActivePlayer(p.find(x => x.id === aid));
        });
        return () => clearInterval(iv);
    }, []);

    const toggle = async (id) => {
        setToggling(id);
        const res = await API.post(`/api/modules/${id}/toggle`);
        if (res) toast(`${res.detail}`, 'success');
        await loadModules();
        setToggling(null);
    };

    const onlineDevices = devices.filter(d => d.online);
    const totalLeds = devices.reduce((sum, d) => sum + (d.led_count || 0), 0);
    const runningModules = modules.filter(m => m.running);

    // System health color
    const healthColor = autodartsConnected && onlineDevices.length > 0 ? 'var(--success)' :
                        onlineDevices.length > 0 || autodartsConnected ? 'var(--warning)' : 'var(--text-dim)';
    const healthText = autodartsConnected && onlineDevices.length > 0 ? 'Bereit zum Spielen' :
                       onlineDevices.length > 0 ? 'Autodarts nicht verbunden' :
                       autodartsConnected ? 'Keine WLED-Ger√§te' : 'Nicht verbunden';

    return (
        <div>
            {/* ‚ïê‚ïê‚ïê Hero Status Bar ‚ïê‚ïê‚ïê */}
            <div style={{
                display: 'flex', alignItems: 'center', gap: 16, padding: '20px 24px',
                background: 'linear-gradient(135deg, rgba(139,92,246,0.08), rgba(59,130,246,0.04))',
                borderRadius: 12, marginBottom: 20, border: '1px solid rgba(139,92,246,0.15)',
            }}>
                <div style={{
                    width: 48, height: 48, borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center',
                    background: `${healthColor}22`, fontSize: 24,
                }}>
                    {autodartsConnected && onlineDevices.length > 0 ? 'üéØ' : '‚è≥'}
                </div>
                <div style={{flex: 1}}>
                    <div style={{fontSize: 20, fontWeight: 800, letterSpacing: '-0.5px'}}>ThrowSync</div>
                    <div style={{fontSize: 13, color: healthColor, fontWeight: 600}}>{healthText}</div>
                </div>
                <div style={{display: 'flex', gap: 20, alignItems: 'center'}}>
                    {[
                        { value: `${onlineDevices.length}`, unit: onlineDevices.length === 1 ? 'Ger√§t' : 'Ger√§te', active: onlineDevices.length > 0 },
                        { value: totalLeds, unit: 'LEDs', active: totalLeds > 0 },
                        { value: runningModules.length, unit: `/ ${modules.length}`, active: runningModules.length > 0 },
                    ].map((s, i) => (
                        <div key={i} style={{textAlign: 'center', minWidth: 50}}>
                            <div style={{fontSize: 22, fontWeight: 700, fontVariantNumeric: 'tabular-nums', color: s.active ? 'var(--text)' : 'var(--text-dim)'}}>
                                {s.value}
                            </div>
                            <div style={{fontSize: 10, color: 'var(--text-dim)', textTransform: 'uppercase', letterSpacing: 1}}>{s.unit}</div>
                        </div>
                    ))}
                </div>
            </div>

            {/* ‚ïê‚ïê‚ïê Quick Action Cards ‚ïê‚ïê‚ïê */}
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: 10, marginBottom: 20}}>

                {/* LED Quick Control */}
                <div className="card" style={{padding: 16}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12}}>
                        <span style={{fontSize: 20}}>üí°</span>
                        <span style={{fontWeight: 700, fontSize: 14}}>LED Schnellsteuerung</span>
                    </div>
                    <div style={{display: 'flex', gap: 6, flexWrap: 'wrap'}}>
                        <button className="btn btn-sm" style={{background: 'var(--success)', color: '#000', border: 'none', fontWeight: 600}}
                            onClick={() => API.post('/api/devices/all/state', {on: true})}>An</button>
                        <button className="btn btn-sm" style={{background: 'var(--danger)', color: '#fff', border: 'none', fontWeight: 600}}
                            onClick={() => API.post('/api/devices/all/state', {on: false})}>Aus</button>
                        {[
                            {hex: '#ff0000', label: 'Rot'},
                            {hex: '#00ff00', label: 'Gr√ºn'},
                            {hex: '#0055ff', label: 'Blau'},
                            {hex: '#ffffff', label: 'Wei√ü'},
                            {hex: '#8b5cf6', label: 'Lila'},
                            {hex: '#ff8800', label: 'Orange'},
                        ].map(c => (
                            <button key={c.hex} className="btn btn-sm" style={{padding: '4px 8px', display: 'flex', alignItems: 'center', gap: 4}}
                                onClick={() => {
                                    const [r,g,b] = [parseInt(c.hex.slice(1,3),16), parseInt(c.hex.slice(3,5),16), parseInt(c.hex.slice(5,7),16)];
                                    devices.forEach(d => API.post(`/api/devices/${d.id}/color`, {color: [r,g,b]}));
                                }}>
                                <span style={{width: 10, height: 10, borderRadius: 3, background: c.hex, display: 'inline-block', border: '1px solid rgba(255,255,255,0.2)'}} />
                                <span style={{fontSize: 11}}>{c.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Active Player */}
                <div className="card" style={{padding: 16, cursor: 'pointer'}} onClick={() => window.__setPage && window.__setPage('players')}>
                    <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12}}>
                        <span style={{fontSize: 20}}>üé≠</span>
                        <span style={{fontWeight: 700, fontSize: 14}}>Aktiver Spieler</span>
                    </div>
                    {activePlayer ? (
                        <div style={{display: 'flex', alignItems: 'center', gap: 10}}>
                            <span style={{fontSize: 32}}>{activePlayer.avatar}</span>
                            <div>
                                <div style={{fontWeight: 700}}>{activePlayer.name}</div>
                                <div style={{fontSize: 12, color: 'var(--text-dim)'}}>
                                    Avg {activePlayer.stats?.avg_score || '‚Äî'} ¬∑ 180s: {activePlayer.stats?.total_180s || 0}
                                </div>
                            </div>
                            <div style={{marginLeft: 'auto', width: 18, height: 18, borderRadius: '50%', background: activePlayer.led_color || '#8b5cf6', border: '2px solid var(--border)'}} />
                        </div>
                    ) : (
                        <div style={{color: 'var(--text-dim)', fontSize: 13}}>
                            {profiles.length > 0 ? `${profiles.length} Profile verf√ºgbar` : 'Kein Profil erstellt'}
                        </div>
                    )}
                </div>

                {/* Autodarts Status */}
                <div className="card" style={{padding: 16}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12}}>
                        <span style={{fontSize: 20}}>üéØ</span>
                        <span style={{fontWeight: 700, fontSize: 14}}>Autodarts</span>
                        <span style={{
                            marginLeft: 'auto', width: 8, height: 8, borderRadius: '50%',
                            background: autodartsConnected ? 'var(--success)' : 'var(--danger)',
                        }} />
                    </div>
                    <div style={{fontSize: 13, color: autodartsConnected ? 'var(--success)' : 'var(--text-dim)'}}>
                        {autodartsConnected ? 'Verbunden ‚Äî Bereit' : 'Nicht verbunden'}
                    </div>
                    {!autodartsConnected && (
                        <button className="btn btn-sm" style={{marginTop: 8, fontSize: 11}}
                            onClick={() => window.__setPage && window.__setPage('autodarts')}>
                            Verbinden ‚Üí
                        </button>
                    )}
                </div>

                {/* Devices Overview */}
                <div className="card" style={{padding: 16, cursor: 'pointer'}} onClick={() => window.__setPage && window.__setPage('devices')}>
                    <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12}}>
                        <span style={{fontSize: 20}}>‚¨°</span>
                        <span style={{fontWeight: 700, fontSize: 14}}>WLED-Ger√§te</span>
                    </div>
                    {onlineDevices.length > 0 ? (
                        <div style={{display: 'flex', flexDirection: 'column', gap: 4}}>
                            {devices.slice(0, 3).map(d => (
                                <div key={d.id} style={{display: 'flex', alignItems: 'center', gap: 6, fontSize: 12}}>
                                    <span style={{width: 6, height: 6, borderRadius: '50%', background: d.online ? 'var(--success)' : 'var(--danger)'}} />
                                    <span style={{flex: 1, color: d.online ? 'var(--text)' : 'var(--text-dim)'}}>{d.name || d.ip}</span>
                                    <span style={{color: 'var(--text-dim)', fontSize: 11}}>{d.led_count || '?'} LEDs</span>
                                </div>
                            ))}
                            {devices.length > 3 && <span style={{fontSize: 11, color: 'var(--text-dim)'}}>+{devices.length - 3} weitere</span>}
                        </div>
                    ) : (
                        <div style={{fontSize: 13, color: 'var(--text-dim)'}}>Keine Ger√§te gefunden</div>
                    )}
                </div>
            </div>

            {/* ‚ïê‚ïê‚ïê Module Control (compact) ‚ïê‚ïê‚ïê */}
            <div className="card" style={{padding: 16, marginBottom: 16}}>
                <div style={{fontWeight: 700, fontSize: 14, marginBottom: 12}}>‚öô Module</div>
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: 8}}>
                    {modules.filter(m => m.can_toggle).map(m => (
                        <div key={m.id} style={{
                            display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px',
                            borderRadius: 8, background: m.running ? 'rgba(34,197,94,0.08)' : 'var(--bg)',
                            border: `1px solid ${m.running ? 'rgba(34,197,94,0.25)' : 'var(--border)'}`,
                        }}>
                            <span style={{fontSize: 16}}>{m.icon}</span>
                            <div style={{flex: 1, minWidth: 0}}>
                                <div style={{fontSize: 12, fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{m.name}</div>
                            </div>
                            <button
                                className={`btn btn-sm ${m.running ? '' : ''}`}
                                style={{
                                    fontSize: 10, padding: '3px 10px', minWidth: 50,
                                    background: m.running ? 'var(--success)' : 'transparent',
                                    color: m.running ? '#000' : 'var(--text-dim)',
                                    border: m.running ? 'none' : '1px solid var(--border)',
                                    fontWeight: 700,
                                }}
                                disabled={toggling === m.id}
                                onClick={() => toggle(m.id)}>
                                {toggling === m.id ? '...' : m.running ? 'AN' : 'AUS'}
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            {/* ‚ïê‚ïê‚ïê Leaderboard Teaser ‚ïê‚ïê‚ïê */}
            {profiles.length > 1 && (
                <div className="card" style={{padding: 16, cursor: 'pointer'}} onClick={() => window.__setPage && window.__setPage('stats')}>
                    <div style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10}}>
                        <span style={{fontSize: 16}}>üèÜ</span>
                        <span style={{fontWeight: 700, fontSize: 14}}>Leaderboard</span>
                        <span style={{marginLeft: 'auto', fontSize: 11, color: 'var(--accent)'}}>Details ‚Üí</span>
                    </div>
                    <div style={{display: 'flex', gap: 12}}>
                        {[...profiles].sort((a, b) => (b.stats?.avg_score || 0) - (a.stats?.avg_score || 0)).slice(0, 3).map((p, i) => (
                            <div key={p.id} style={{flex: 1, textAlign: 'center', padding: '8px 0'}}>
                                <div style={{fontSize: 10, marginBottom: 2}}>{i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}</div>
                                <div style={{fontSize: 22}}>{p.avatar}</div>
                                <div style={{fontSize: 12, fontWeight: 600, marginTop: 2}}>{p.name}</div>
                                <div style={{fontSize: 18, fontWeight: 700, color: 'var(--accent)', fontVariantNumeric: 'tabular-nums'}}>{p.stats?.avg_score || '‚Äî'}</div>
                                <div style={{fontSize: 10, color: 'var(--text-dim)'}}>Avg Score</div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Devices Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SetupWizard({ onClose, onAddDevice }) {
    const [step, setStep] = useState(0);
    const [checked, setChecked] = useState({});
    const toggle = (id) => setChecked(prev => ({...prev, [id]: !prev[id]}));

    const steps = [
        {
            title: 'üîå 1. Controller anschlie√üen',
            subtitle: 'Gledopto GL-C-008WL oder anderen WLED-Controller',
            items: [
                { id: 'power', label: 'LED-Strip am Controller angeschlossen (DATA + 5V/12V/24V + GND)', hint: 'Achte auf die richtige Spannung deines Strips! WS2812B = 5V, WS2811 = 12V' },
                { id: 'power_on', label: 'Netzteil eingesteckt und eingeschaltet', hint: 'Der Controller braucht ein passendes Netzteil (5‚Äì24V DC). Am Controller sollte eine LED leuchten.' },
                { id: 'strip_lights', label: 'LED-Strip zeigt ein Leuchten (oft orange/warm beim Start)', hint: 'Wenn nichts leuchtet: Verkabelung und Netzteil-Spannung pr√ºfen.' },
            ]
        },
        {
            title: 'üì° 2. Mit WLED-WiFi verbinden',
            subtitle: 'Der Controller erstellt sein eigenes WLAN',
            items: [
                { id: 'find_wifi', label: 'Auf Handy/Laptop WiFi-Liste √∂ffnen', hint: null },
                { id: 'connect_ap', label: 'Netzwerk "WLED-AP" gefunden und verbunden', hint: 'Standard-Passwort: wled1234\nWenn "WLED-AP" nicht auftaucht: Controller kurz vom Strom trennen und neu starten. Warte 30 Sekunden.' },
                { id: 'portal', label: 'Konfigurationsseite √∂ffnet sich (oder gehe zu 4.3.2.1)', hint: 'Manche Handys √∂ffnen automatisch eine "Anmeldeseite". Falls nicht: Browser √∂ffnen ‚Üí 4.3.2.1 eingeben' },
            ]
        },
        {
            title: 'üè† 3. Heim-WLAN einrichten',
            subtitle: 'Controller mit deinem normalen WiFi verbinden',
            items: [
                { id: 'wifi_settings', label: 'In WLED: "WiFi Settings" / WLAN-Einstellungen √∂ffnen', hint: null },
                { id: 'ssid', label: 'Dein Heim-WLAN Name (SSID) eingegeben', hint: 'Das WiFi-Netzwerk in dem auch dein Computer / Autodarts-Rechner ist!' },
                { id: 'password', label: 'WLAN-Passwort eingegeben', hint: null },
                { id: 'save_wifi', label: '"Save & Connect" / Speichern geklickt', hint: 'Der Controller startet neu und verbindet sich mit deinem Heim-WLAN. Die WLED-AP verschwindet.' },
                { id: 'find_ip', label: 'IP-Adresse des Controllers herausgefunden', hint: 'Methoden:\n‚Ä¢ Im Router nachschauen (Fritz!Box ‚Üí Heimnetz ‚Üí Netzwerk)\n‚Ä¢ In WLED-AP unter "WiFi Settings" wird die zugewiesene IP angezeigt\n‚Ä¢ Netzwerk-Scanner-App (z.B. "Fing" auf dem Handy)\n‚Ä¢ In diesem Programm: "Netzwerk scannen" Button' },
            ]
        },
        {
            title: 'üí° 4. LED-Strip konfigurieren',
            subtitle: 'Wichtig: LED-Anzahl muss stimmen!',
            items: [
                { id: 'open_wled', label: 'WLED Web-Interface im Browser √∂ffnen (http://[IP-Adresse])', hint: 'Jetzt mit dem normalen WLAN verbunden, nicht mehr WLED-AP!' },
                { id: 'led_prefs', label: 'In WLED: Config ‚Üí LED Preferences √∂ffnen', hint: null },
                { id: 'led_type', label: 'LED-Typ eingestellt (z.B. WS2812B, WS2811, SK6812)', hint: 'Gledopto unterst√ºtzt: WS2812B, WS2811, SK6812, SM16703P' },
                { id: 'led_count', label: 'LED-Anzahl eingegeben', hint: 'Z√§hle die LEDs deines Strips oder schau auf die Produktbeschreibung.\nBeispiele:\n‚Ä¢ 1m mit 60 LEDs/m ‚Üí 60\n‚Ä¢ 2m mit 60 LEDs/m ‚Üí 120\n‚Ä¢ 5m mit 30 LEDs/m ‚Üí 150' },
                { id: 'led_gpio', label: 'GPIO-Pin: Bei Gledopto ist es GPIO 2 (Standard)', hint: 'Bei den meisten Controllern ist der Standard schon richtig. Nur √§ndern wenn du wei√üt was du tust.' },
                { id: 'led_save', label: '"Save" / Speichern geklickt', hint: 'Der Controller startet eventuell neu. Danach sollte der gesamte Strip leuchten.' },
                { id: 'strip_works', label: 'Gesamter LED-Strip leuchtet und reagiert auf Farben/Effekte', hint: 'Teste in WLED: Farbe √§ndern, Effekt w√§hlen. Wenn nur ein Teil leuchtet: LED-Anzahl pr√ºfen!' },
            ]
        },
        {
            title: '‚öôÔ∏è 5. WLED Optimierungen',
            subtitle: 'F√ºr beste Ergebnisse mit Autodarts',
            items: [
                { id: 'transition', label: 'Transition Time auf 0 setzen (Config ‚Üí LED Preferences ‚Üí Transition)', hint: 'Damit reagieren die LEDs sofort ohne √úberblendung ‚Äî wichtig f√ºr schnelle Dart-Events!' },
                { id: 'sync_off', label: 'WLED Sync deaktivieren (Config ‚Üí Sync Interfaces)', hint: 'Nur n√∂tig wenn du MEHRERE WLED-Controller hast. Ansonsten st√∂ren sich die Controller gegenseitig.' },
                { id: 'brightness', label: 'Maximale Helligkeit testen (nicht zu hell f√ºr Kamera!)', hint: '‚ö† WICHTIG: Wenn du Autodarts-Kameras hast, teste ob die LEDs die Erkennung st√∂ren!\nAm besten: LEDs um das Surround, NICHT als Hauptbeleuchtung.' },
            ]
        },
        {
            title: 'üéØ 6. Im LED Manager hinzuf√ºgen',
            subtitle: 'Fast geschafft!',
            items: [
                { id: 'add_device', label: 'IP-Adresse in dieses Programm eingeben', hint: null },
                { id: 'set_name', label: 'Einen Namen vergeben (z.B. "Wohnzimmer Board")', hint: null },
                { id: 'set_leds', label: 'LED-Anzahl eingeben (gleiche Zahl wie in WLED!)', hint: null },
                { id: 'assign_board', label: 'Unter "Autodarts" ‚Üí Board anlegen ‚Üí Ger√§t zuweisen', hint: 'Board ID findest du auf autodarts.io ‚Üí My Boards. Nutze deinen Autodarts Benutzernamen + Passwort zum Einloggen.' },
                { id: 'test_events', label: 'Unter "Events & Effekte" ‚Üí einen Event testen (‚ñ∂ Button)', hint: 'Wenn die LEDs reagieren: Alles richtig! üéâ' },
            ]
        },
    ];

    const currentStep = steps[step];
    const stepChecks = currentStep.items.map(i => checked[i.id]);
    const allChecked = stepChecks.every(Boolean);
    const totalItems = steps.reduce((s, st) => s + st.items.length, 0);
    const totalChecked = Object.values(checked).filter(Boolean).length;

    return (
        <div className="modal-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
            <div className="modal" style={{maxWidth: 700, maxHeight: '90vh', overflow: 'auto'}}>
                {/* Progress bar */}
                <div style={{display: 'flex', gap: 4, marginBottom: 20}}>
                    {steps.map((s, i) => (
                        <div key={i} onClick={() => setStep(i)} style={{
                            flex: 1, height: 6, borderRadius: 3, cursor: 'pointer',
                            background: i < step ? 'var(--success)' : i === step ? 'var(--accent)' : 'var(--border)',
                            transition: 'background 0.3s',
                        }} />
                    ))}
                </div>

                <div style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 8}}>
                    Schritt {step + 1} von {steps.length} ¬∑ {totalChecked}/{totalItems} erledigt
                </div>

                <h3 style={{margin: '0 0 4px 0'}}>{currentStep.title}</h3>
                <p style={{color: 'var(--text-secondary)', fontSize: 14, margin: '0 0 20px 0'}}>{currentStep.subtitle}</p>

                <div style={{display: 'grid', gap: 12}}>
                    {currentStep.items.map(item => (
                        <div key={item.id} onClick={() => toggle(item.id)} style={{
                            display: 'flex', gap: 12, padding: '14px 16px', borderRadius: 10, cursor: 'pointer',
                            background: checked[item.id] ? 'rgba(0,200,100,0.08)' : 'rgba(255,255,255,0.03)',
                            border: `1px solid ${checked[item.id] ? 'rgba(0,200,100,0.3)' : 'var(--border)'}`,
                            transition: 'all 0.2s',
                        }}>
                            <div style={{
                                width: 24, height: 24, borderRadius: 6, flexShrink: 0, marginTop: 1,
                                border: checked[item.id] ? 'none' : '2px solid var(--border)',
                                background: checked[item.id] ? 'var(--success)' : 'transparent',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                color: 'white', fontSize: 14, fontWeight: 700,
                            }}>
                                {checked[item.id] && '‚úì'}
                            </div>
                            <div style={{flex: 1}}>
                                <div style={{
                                    fontWeight: 500, fontSize: 14,
                                    textDecoration: checked[item.id] ? 'line-through' : 'none',
                                    color: checked[item.id] ? 'var(--text-dim)' : 'var(--text-primary)',
                                }}>
                                    {item.label}
                                </div>
                                {item.hint && (
                                    <div style={{
                                        fontSize: 12, color: 'var(--text-dim)', marginTop: 6,
                                        lineHeight: 1.6, whiteSpace: 'pre-line',
                                        padding: '8px 10px', borderRadius: 6,
                                        background: 'rgba(108,92,231,0.06)',
                                    }}>
                                        üí° {item.hint}
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Navigation */}
                <div style={{display: 'flex', gap: 10, marginTop: 24, justifyContent: 'space-between', flexWrap: 'wrap'}}>
                    <div style={{display: 'flex', gap: 10}}>
                        {step > 0 && (
                            <button className="btn" onClick={() => setStep(step - 1)}>‚Üê Zur√ºck</button>
                        )}
                    </div>
                    <div style={{display: 'flex', gap: 10}}>
                        {step < steps.length - 1 ? (
                            <button className="btn btn-primary" onClick={() => setStep(step + 1)}>
                                Weiter ‚Üí
                            </button>
                        ) : (
                            <button className="btn btn-primary" onClick={() => onAddDevice('', '', '')}>
                                ‚úì Ger√§t jetzt hinzuf√ºgen
                            </button>
                        )}
                        <button className="btn" onClick={onClose}>Schlie√üen</button>
                    </div>
                </div>
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Devices Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function DevicesPage({ devices, refreshDevices }) {
    const [showAdd, setShowAdd] = useState(false);
    const [newIp, setNewIp] = useState('');
    const [newName, setNewName] = useState('');
    const [newLedCount, setNewLedCount] = useState('');
    const [scanning, setScanning] = useState(false);
    const [discovered, setDiscovered] = useState([]);
    // Firmware updates
    const [fwCheck, setFwCheck] = useState(null);
    const [fwChecking, setFwChecking] = useState(false);
    const [updating, setUpdating] = useState({});  // device_id ‚Üí true
    const toast = useToast();

    const addDevice = async () => {
        const result = await API.post('/api/devices', {
            ip: newIp, name: newName,
            led_count: parseInt(newLedCount) || 0
        });
        if (result?.success) {
            toast('Ger√§t hinzugef√ºgt!', 'success');
            setNewIp(''); setNewName(''); setNewLedCount(''); setShowAdd(false);
            refreshDevices();
        } else {
            toast('Ger√§t nicht erreichbar', 'error');
        }
    };

    const updateLedCount = async (deviceId, count) => {
        const result = await API.post(`/api/devices/${deviceId}/led-count`, { led_count: count });
        if (result?.success) {
            toast(`LED-Anzahl auf ${count} gesetzt!`, 'success');
            refreshDevices();
        } else {
            toast('Fehler beim Setzen der LED-Anzahl', 'error');
        }
    };

    const removeDevice = async (id) => {
        await API.del(`/api/devices/${id}`);
        toast('Ger√§t entfernt', 'success');
        refreshDevices();
    };

    const scanNetwork = async () => {
        setScanning(true);
        toast('Netzwerk wird gescannt...', 'info');
        const result = await API.get('/api/devices/discover');
        setDiscovered(result?.discovered || []);
        setScanning(false);
        toast(`${result?.discovered?.length || 0} Geraete gefunden`, 'success');
    };

    // Firmware update check
    const checkFirmware = async () => {
        setFwChecking(true);
        const result = await API.get('/api/firmware/check');
        setFwCheck(result);
        setFwChecking(false);
        if (result?.latest) {
            const updateCount = (result.devices || []).filter(d => d.needs_update).length;
            if (updateCount > 0) {
                toast(`${updateCount} Geraet(e) koennen aktualisiert werden! (Neueste: ${result.latest.version})`, 'warning');
            } else {
                toast(`Alle Geraete sind aktuell (${result.latest.version})`, 'success');
            }
        }
    };

    const updateDevice = async (deviceId) => {
        const dev = devices.find(d => d.id === deviceId);
        const fw = getFwStatus(deviceId);
        const chipInfo = fw?.arch || fw?.platform || 'unbekannt';
        const msg = [
            `WLED-Firmware auf "${dev?.name || deviceId}" aktualisieren?`,
            ``,
            `Aktuell: v${dev?.version || '?'}`,
            `Neu: ${fwCheck?.latest?.version}`,
            `Chip: ${chipInfo}`,
            ``,
            `‚ö† WICHTIG:`,
            `- WiFi-Einstellungen koennen verloren gehen!`,
            `- LED-Konfiguration wird auf Standard zurueckgesetzt`,
            `- Bei WiFi-only Controllern (kein USB) ist ein Recovery`,
            `  bei Problemen nur schwer moeglich!`,
            ``,
            `Wirklich updaten?`,
        ].join('\n');
        if (!confirm(msg)) return;
        setUpdating(prev => ({...prev, [deviceId]: true}));
        toast(`Update laeuft fuer ${dev?.name || deviceId} (${chipInfo})...`, 'info');
        try {
            const result = await API.post(`/api/devices/${deviceId}/update-firmware`);
            if (result?.success) {
                toast(`Update erfolgreich! ${result.old_version} -> ${result.new_version}`, 'success');
            } else {
                toast(`Update fehlgeschlagen: ${result?.error || result?.detail || 'Unbekannter Fehler'}`, 'error');
            }
        } catch (e) {
            toast('Update fehlgeschlagen', 'error');
        }
        setUpdating(prev => ({...prev, [deviceId]: false}));
        refreshDevices();
        checkFirmware();
    };

    // Check firmware on first load
    useEffect(() => { checkFirmware(); }, []);

    const getFwStatus = (deviceId) => {
        if (!fwCheck?.devices) return null;
        return fwCheck.devices.find(d => d.id === deviceId);
    };

    const [showSetup, setShowSetup] = useState(false);

    // Auto-scan if no devices on first load
    useEffect(() => {
        if (devices.length === 0 && !scanning && discovered.length === 0) {
            scanNetwork();
        }
    }, []);

    const addDiscovered = async (d) => {
        const result = await API.post('/api/devices', {
            ip: d.ip, name: d.name, led_count: d.led_count || 0
        });
        if (result?.success) {
            toast(`"${d.name}" hinzugefuegt!`, 'success');
            refreshDevices();
            setDiscovered(prev => prev.map(x => x.ip === d.ip ? {...x, already_managed: true} : x));
        }
    };

    const addAllDiscovered = async () => {
        const newDevices = discovered.filter(d => !d.already_managed);
        for (const d of newDevices) {
            await API.post('/api/devices', { ip: d.ip, name: d.name, led_count: d.led_count || 0 });
        }
        toast(`${newDevices.length} Geraete hinzugefuegt!`, 'success');
        refreshDevices();
        setDiscovered(prev => prev.map(d => ({...d, already_managed: true})));
    };

    return (
        <div>
            <div className="page-header">
                <h2>Ger√§te verwalten</h2>
                <p>WLED-Ger√§te hinzuf√ºgen, entdecken und verwalten</p>
            </div>

            <div style={{display: 'flex', gap: 12, marginBottom: 24, flexWrap: 'wrap'}}>
                <button className="btn btn-primary" onClick={() => setShowAdd(true)}>+ Ger√§t hinzuf√ºgen</button>
                <button className="btn" style={{background: 'rgba(108,92,231,0.2)', borderColor: 'var(--accent)'}}
                    onClick={() => setShowSetup(true)}>üìã Einrichtungs-Assistent</button>
                <button className="btn" onClick={scanNetwork} disabled={scanning}>
                    {scanning ? '‚ü≥ Scanne...' : 'üì° Netzwerk scannen'}
                </button>
                <button className="btn" onClick={checkFirmware} disabled={fwChecking}
                    style={{background: fwCheck?.devices?.some(d => d.needs_update) ? 'rgba(240,160,48,0.15)' : undefined,
                        borderColor: fwCheck?.devices?.some(d => d.needs_update) ? 'rgba(240,160,48,0.4)' : undefined}}>
                    {fwChecking ? '‚ü≥ Pruefe...' : 'üîÑ Firmware pruefen'}
                    {fwCheck?.devices?.filter(d => d.needs_update).length > 0 &&
                        ` (${fwCheck.devices.filter(d => d.needs_update).length} Updates)`}
                </button>
                <button className="btn" onClick={refreshDevices}>‚Üª Aktualisieren</button>
            </div>

            {showSetup && <SetupWizard onClose={() => setShowSetup(false)} onAddDevice={(ip, name, leds) => {
                setNewIp(ip); setNewName(name); setNewLedCount(String(leds || ''));
                setShowSetup(false); setShowAdd(true);
            }} />}

            {/* Firmware Update Summary */}
            {fwCheck?.latest && fwCheck.devices?.some(d => d.needs_update) && (
                <div style={{
                    padding: '12px 16px', marginBottom: 16, borderRadius: 10,
                    background: 'rgba(240,160,48,0.08)', border: '1px solid rgba(240,160,48,0.25)',
                    display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap',
                }}>
                    <span style={{fontSize: 20}}>üîÑ</span>
                    <div style={{flex: 1}}>
                        <div style={{fontWeight: 600, fontSize: 14}}>
                            WLED {fwCheck.latest.version} verfuegbar
                        </div>
                        <div style={{fontSize: 12, color: 'var(--text-dim)'}}>
                            {fwCheck.devices.filter(d => d.needs_update).length} Geraet(e) koennen aktualisiert werden
                        </div>
                    </div>
                    <button className="btn btn-sm" onClick={async () => {
                        const toUpdate = fwCheck.devices.filter(d => d.needs_update && d.online);
                        if (toUpdate.length === 0) { toast('Keine online Geraete zum Updaten', 'error'); return; }
                        if (!confirm(`Alle ${toUpdate.length} Geraete auf ${fwCheck.latest.version} aktualisieren?`)) return;
                        for (const d of toUpdate) { await updateDevice(d.id); }
                    }} style={{
                        background: 'rgba(240,160,48,0.2)', borderColor: 'rgba(240,160,48,0.4)',
                        fontSize: 12,
                    }}>
                        üîÑ Alle aktualisieren
                    </button>
                </div>
            )}

            {showAdd && (
                <div className="card" style={{borderColor: 'var(--accent)', marginBottom: 20}}>
                    <h4 style={{marginBottom: 16}}>Neues Ger√§t hinzuf√ºgen</h4>
                    <div className="grid-2">
                        <div className="input-group">
                            <label>IP-Adresse</label>
                            <input type="text" value={newIp} onChange={e => setNewIp(e.target.value)}
                                placeholder="z.B. 192.168.1.100" />
                        </div>
                        <div className="input-group">
                            <label>Name (optional)</label>
                            <input type="text" value={newName} onChange={e => setNewName(e.target.value)}
                                placeholder="z.B. Dartboard LED" />
                        </div>
                    </div>
                    <div className="input-group">
                        <label>Anzahl LEDs im Strip</label>
                        <input type="number" value={newLedCount} onChange={e => setNewLedCount(e.target.value)}
                            placeholder="z.B. 60, 144, 300 ‚Äî wird an WLED √ºbertragen" min="1" max="1500" />
                        <div style={{fontSize: 12, color: 'var(--text-dim)', marginTop: 4}}>
                            ‚ö† Wichtig: Muss zur tats√§chlichen Anzahl der LEDs im Strip passen, sonst funktionieren Effekte nicht korrekt.
                            Wird direkt an WLED √ºbertragen. Leer lassen = bestehende Einstellung behalten.
                        </div>
                    </div>
                    <div style={{display: 'flex', gap: 10}}>
                        <button className="btn btn-primary" onClick={addDevice}>Hinzuf√ºgen</button>
                        <button className="btn" onClick={() => setShowAdd(false)}>Abbrechen</button>
                    </div>
                </div>
            )}

            {discovered.length > 0 && (
                <div className="card" style={{marginBottom: 20, borderColor: 'var(--success)', borderWidth: 1}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12}}>
                        <div className="card-title" style={{margin: 0}}>
                            üì° {discovered.length} WLED-Geraete im Netzwerk gefunden
                        </div>
                        <div style={{display: 'flex', gap: 8}}>
                            {discovered.some(d => !d.already_managed) && (
                                <button className="btn btn-sm" onClick={addAllDiscovered}
                                    style={{background: 'rgba(0,214,143,0.15)', borderColor: 'rgba(0,214,143,0.3)', fontSize: 11}}>
                                    + Alle hinzufuegen
                                </button>
                            )}
                            <button className="btn btn-sm" onClick={scanNetwork} style={{fontSize: 11}}>
                                ‚Üª Erneut scannen
                            </button>
                        </div>
                    </div>
                    <div style={{display: 'grid', gap: 8, gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))'}}>
                        {discovered.map((d, i) => (
                            <div key={i} style={{
                                display: 'flex', gap: 10, alignItems: 'center', padding: '10px 14px',
                                background: d.already_managed ? 'rgba(0,0,0,0.1)' : 'rgba(0,214,143,0.05)',
                                borderRadius: 8, border: `1px solid ${d.already_managed ? 'var(--border)' : 'rgba(0,214,143,0.2)'}`,
                                opacity: d.already_managed ? 0.5 : 1,
                            }}>
                                <div style={{
                                    width: 10, height: 10, borderRadius: '50%', flexShrink: 0,
                                    background: d.already_managed ? 'var(--text-dim)' : 'var(--success)',
                                }} />
                                <div style={{flex: 1, minWidth: 0}}>
                                    <div style={{fontSize: 13, fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                        {d.name}
                                    </div>
                                    <div style={{fontSize: 11, color: 'var(--text-dim)'}}>
                                        {d.ip} ¬∑ {d.led_count || '?'} LEDs
                                    </div>
                                </div>
                                {d.already_managed ? (
                                    <span style={{fontSize: 10, color: 'var(--text-dim)'}}>Verwaltet</span>
                                ) : (
                                    <button className="btn btn-sm" onClick={() => addDiscovered(d)}
                                        style={{padding: '4px 10px', fontSize: 11, flexShrink: 0}}>+ Hinzufuegen</button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <div className="grid-3">
                {devices.map(d => {
                    const fw = getFwStatus(d.id);
                    const isUpdating = updating[d.id];
                    return (
                    <div key={d.id} className="device-card" style={{
                        borderColor: fw?.needs_update ? 'rgba(240,160,48,0.4)' : undefined,
                    }}>
                        <div className="led-bar" style={{background: d.online ? 'var(--success)' : 'var(--danger)'}}></div>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
                            <div>
                                <div className="device-name">{d.name || `WLED-${d.ip}`}</div>
                                <div className="device-ip">{d.ip}</div>
                            </div>
                            <span className={`badge ${d.online ? 'badge-success' : 'badge-danger'}`}>
                                {d.online ? 'Online' : 'Offline'}
                            </span>
                        </div>
                        <div className="device-meta" style={{marginTop: 12}}>
                            <span style={{cursor: 'pointer'}} title="Klicken zum Aendern" onClick={() => {
                                const count = prompt(`LED-Anzahl fuer "${d.name || d.ip}":\n(Wird direkt an WLED uebertragen)`, d.led_count || '');
                                if (count && parseInt(count) > 0) updateLedCount(d.id, parseInt(count));
                            }}>üí° {d.led_count || '?'} LEDs ‚úé</span>
                            <span style={{
                                color: fw?.needs_update ? 'var(--warning)' : 'var(--text-dim)',
                                fontWeight: fw?.needs_update ? 600 : 400,
                            }}>
                                üì¶ v{d.version || '?'}
                                {fw?.needs_update && ` ‚Üí ${fwCheck?.latest?.version}`}
                            </span>
                            {fw?.arch && <span style={{fontSize: 10, color: 'var(--text-dim)'}}>üîß {fw.arch}</span>}
                            {d.power && <span>üîÜ {Math.round(d.brightness / 255 * 100)}%</span>}
                        </div>

                        {/* Update available banner */}
                        {fw?.needs_update && d.online && (
                            <div style={{
                                marginTop: 10, padding: '8px 12px', borderRadius: 8,
                                background: 'rgba(240,160,48,0.1)', border: '1px solid rgba(240,160,48,0.25)',
                                display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 8,
                            }}>
                                <span style={{fontSize: 12, color: 'var(--warning)'}}>
                                    Update verfuegbar: {fwCheck?.latest?.version}
                                </span>
                                <button className="btn btn-sm" disabled={isUpdating} onClick={() => updateDevice(d.id)}
                                    style={{
                                        fontSize: 11, padding: '4px 12px', flexShrink: 0,
                                        background: isUpdating ? 'var(--bg-input)' : 'rgba(240,160,48,0.2)',
                                        borderColor: 'rgba(240,160,48,0.4)',
                                    }}>
                                    {isUpdating ? '‚ü≥ Update laeuft...' : 'üîÑ Jetzt updaten'}
                                </button>
                            </div>
                        )}

                        <div style={{display: 'flex', gap: 8, marginTop: fw?.needs_update ? 10 : 14}}>
                            <button className="btn btn-sm" onClick={() => API.post(`/api/devices/${d.id}/identify`)}>üî¶ Identifizieren</button>
                            <button className="btn btn-sm btn-danger" onClick={() => removeDevice(d.id)}>‚úï</button>
                        </div>
                    </div>
                    );
                })}
            </div>

            {devices.length === 0 && !showAdd && (
                <div className="card" style={{textAlign: 'center', padding: 48}}>
                    <div style={{fontSize: 48, marginBottom: 16}}>‚¨°</div>
                    <h3 style={{marginBottom: 8}}>Keine Ger√§te</h3>
                    <p style={{color: 'var(--text-dim)', marginBottom: 20}}>F√ºge dein erstes WLED-Ger√§t hinzu oder scanne dein Netzwerk.</p>
                    <button className="btn btn-primary" onClick={() => setShowAdd(true)}>+ Erstes Ger√§t hinzuf√ºgen</button>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ LED Control Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function LEDControlPage({ devices }) {
    const [selectedDevice, setSelectedDevice] = useState(null);
    const [brightness, setBrightness] = useState(128);
    const [color, setColor] = useState('#6c5ce7');
    const [effectId, setEffectId] = useState(0);
    const [speed, setSpeed] = useState(128);
    const [intensity, setIntensity] = useState(128);
    const [palette, setPalette] = useState(0);
    const [ledCount, setLedCount] = useState(60);
    const [selectedLeds, setSelectedLeds] = useState(new Set());
    const [segments, setSegments] = useState([]);
    const [showIndividual, setShowIndividual] = useState(false);
    const [showSegments, setShowSegments] = useState(false);
    const toast = useToast();

    const onlineDevices = devices.filter(d => d.online);
    const device = selectedDevice ? devices.find(d => d.id === selectedDevice) : null;

    useEffect(() => {
        if (onlineDevices.length > 0 && !selectedDevice) {
            setSelectedDevice(onlineDevices[0].id);
        }
    }, [onlineDevices]);

    useEffect(() => {
        if (device) {
            setLedCount(device.led_count || 60);
            setBrightness(device.brightness || 128);
            if (device.segments) setSegments(device.segments);
        }
    }, [device]);

    const hexToRgb = (hex) => {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return [r, g, b];
    };

    const applyColor = async () => {
        if (!selectedDevice) return;
        const rgb = hexToRgb(color);
        await API.post('/api/devices/' + selectedDevice + '/color', { color: rgb, brightness });
        toast('Farbe angewendet', 'success');
    };

    const applyEffect = async () => {
        if (!selectedDevice) return;
        await API.post('/api/devices/' + selectedDevice + '/effect', {
            effect_id: effectId, speed, intensity, palette
        });
        toast('Effekt angewendet', 'success');
    };

    const applyIndividual = async () => {
        if (!selectedDevice || selectedLeds.size === 0) return;
        const rgb = hexToRgb(color);
        const leds = {};
        selectedLeds.forEach(i => { leds[i] = rgb; });
        await API.post('/api/devices/' + selectedDevice + '/individual', { leds });
        toast(selectedLeds.size + ' LEDs gesetzt', 'success');
    };

    const effects = [
        "Solid", "Blink", "Breathe", "Wipe", "Wipe Random", "Random Colors",
        "Sweep", "Dynamic", "Colorloop", "Rainbow", "Scan", "Scan Dual",
        "Fade", "Theater", "Theater Rainbow", "Running", "Saw", "Twinkle",
        "Dissolve", "Dissolve Rnd", "Sparkle", "Sparkle Dark", "Sparkle+",
        "Strobe", "Strobe Rainbow", "Strobe Mega", "Blink Rainbow", "Android",
        "Chase", "Chase Random", "Chase Rainbow", "Chase Flash", "Chase Flash Rnd",
        "Rainbow Runner", "Colorful", "Traffic Light", "Sweep Random", "Chase 2",
        "Aurora", "Stream", "Scanner", "Lighthouse", "Fireworks", "Rain",
        "Tetrix", "Fire Flicker", "Gradient", "Loading", "Police", "Fairy",
        "Two Dots", "Fairytwinkle"
    ];

    const quickColors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff','#ffffff','#ff6600','#ff1493','#00ff7f','#6c5ce7','#ffeaa7'];

    return (
        <div>
            <div className="page-header">
                <h2>{'\u25C6'} LED Steuerung</h2>
                <p>Farben, Effekte und individuelle LED-Kontrolle</p>
            </div>

            {/* ‚îÄ‚îÄ Top Bar: Device + Power ‚îÄ‚îÄ */}
            <div className="card" style={{padding: 12, marginBottom: 12}}>
                <div style={{display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap'}}>
                    <select value={selectedDevice || ''} onChange={e => setSelectedDevice(e.target.value)}
                        style={{flex: 1, minWidth: 180, padding: '8px 10px', background: 'var(--bg-input)',
                            border: '1px solid var(--border)', borderRadius: 8, color: 'var(--text-primary)', fontSize: 13}}>
                        <option value="">{'\u2014'} Ger√§t w√§hlen {'\u2014'}</option>
                        {onlineDevices.map(d => (
                            <option key={d.id} value={d.id}>{d.name} ({d.led_count} LEDs)</option>
                        ))}
                    </select>
                    {selectedDevice && (
                        <>
                            <button className="btn btn-sm btn-success" style={{padding: '8px 14px'}}
                                onClick={() => API.post('/api/devices/' + selectedDevice + '/state', {on: true})}>AN</button>
                            <button className="btn btn-sm btn-danger" style={{padding: '8px 14px'}}
                                onClick={() => API.post('/api/devices/' + selectedDevice + '/state', {on: false})}>AUS</button>
                        </>
                    )}
                </div>
                {selectedDevice && (
                    <div style={{display: 'flex', alignItems: 'center', gap: 10, marginTop: 8}}>
                        <span style={{fontSize: 16}}>{brightness > 0 ? '\u2600' : '\uD83C\uDF19'}</span>
                        <input type="range" min="0" max="255" value={brightness}
                            onChange={e => {
                                setBrightness(parseInt(e.target.value));
                                API.post('/api/devices/' + selectedDevice + '/state', { bri: parseInt(e.target.value) });
                            }}
                            style={{flex: 1, accentColor: 'var(--accent)'}} />
                        <span style={{fontFamily: 'JetBrains Mono', fontSize: 12, minWidth: 36, textAlign: 'right'}}>
                            {Math.round(brightness / 255 * 100)}%
                        </span>
                    </div>
                )}
            </div>

            {!selectedDevice ? (
                <div className="card" style={{padding: 40, textAlign: 'center', color: 'var(--text-dim)'}}>
                    {onlineDevices.length === 0 ? 'Keine WLED-Ger√§te online. Gehe zu Ger√§te um eins hinzuzuf√ºgen.'
                        : 'W√§hle oben ein Ger√§t aus.'}
                </div>
            ) : (
                <>
                    {/* ‚îÄ‚îÄ Card Grid: Color + Effects side by side ‚îÄ‚îÄ */}
                    <div className="led-cards-grid">

                        {/* Color Card */}
                        <div className="card" style={{padding: 14}}>
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10}}>
                                <h4 style={{margin: 0, fontSize: 14}}>{'\uD83C\uDFA8'} Farbe</h4>
                                <button className="btn btn-sm btn-primary" onClick={applyColor} style={{fontSize: 11}}>Anwenden</button>
                            </div>
                            <div style={{display: 'flex', gap: 12, alignItems: 'center', marginBottom: 10}}>
                                <input type="color" value={color} onChange={e => setColor(e.target.value)}
                                    style={{width: 48, height: 48, border: 'none', borderRadius: 8, cursor: 'pointer'}} />
                                <div style={{
                                    width: 48, height: 48, borderRadius: 8, background: color,
                                    border: '2px solid var(--border)', boxShadow: '0 0 16px ' + color + '44',
                                }} />
                                <span style={{fontFamily: 'JetBrains Mono', fontSize: 12, color: 'var(--text-dim)'}}>{color}</span>
                            </div>
                            <div style={{display: 'flex', gap: 6, flexWrap: 'wrap'}}>
                                {quickColors.map(c => (
                                    <div key={c} onClick={() => setColor(c)}
                                        style={{
                                            width: 24, height: 24, borderRadius: 6, background: c, cursor: 'pointer',
                                            border: color === c ? '2px solid #fff' : '2px solid transparent',
                                            boxShadow: color === c ? '0 0 8px ' + c : 'none',
                                            transition: 'all 0.15s',
                                        }} />
                                ))}
                            </div>
                        </div>

                        {/* Effects Card */}
                        <div className="card" style={{padding: 14}}>
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10}}>
                                <h4 style={{margin: 0, fontSize: 14}}>{'\u2728'} Effekte</h4>
                                <button className="btn btn-sm btn-primary" onClick={applyEffect} style={{fontSize: 11}}>Anwenden</button>
                            </div>
                            <select value={effectId} onChange={e => setEffectId(parseInt(e.target.value))}
                                style={{width: '100%', padding: '6px 8px', marginBottom: 8, background: 'var(--bg-input)',
                                    border: '1px solid var(--border)', borderRadius: 6, color: 'var(--text-primary)', fontSize: 12}}>
                                {effects.map((name, i) => (
                                    <option key={i} value={i}>{name}</option>
                                ))}
                            </select>
                            <select value={palette} onChange={e => setPalette(parseInt(e.target.value))}
                                style={{width: '100%', padding: '6px 8px', marginBottom: 8, background: 'var(--bg-input)',
                                    border: '1px solid var(--border)', borderRadius: 6, color: 'var(--text-primary)', fontSize: 12}}>
                                {["Default","Random","Color 1","Colors 1&2","Gradient","Party","Cloud","Lava","Ocean","Forest","Rainbow","Rainbow Bands","Sunset","Breeze","Red & Blue","Fire","Icefire","Sakura","Aurora"].map((name, i) => (
                                    <option key={i} value={i}>{name}</option>
                                ))}
                            </select>
                            <div style={{display: 'flex', gap: 8}}>
                                <div style={{flex: 1}}>
                                    <label style={{fontSize: 10, color: 'var(--text-dim)'}}>Speed: {speed}</label>
                                    <input type="range" min="0" max="255" value={speed}
                                        onChange={e => setSpeed(parseInt(e.target.value))}
                                        style={{width: '100%', accentColor: 'var(--accent)'}} />
                                </div>
                                <div style={{flex: 1}}>
                                    <label style={{fontSize: 10, color: 'var(--text-dim)'}}>Intensit√§t: {intensity}</label>
                                    <input type="range" min="0" max="255" value={intensity}
                                        onChange={e => setIntensity(parseInt(e.target.value))}
                                        style={{width: '100%', accentColor: 'var(--accent)'}} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ‚îÄ‚îÄ Individual LEDs (collapsible) ‚îÄ‚îÄ */}
                    <div className="card" style={{padding: 0, marginBottom: 12, overflow: 'hidden'}}>
                        <div style={{
                            display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                            padding: '10px 14px', cursor: 'pointer', userSelect: 'none',
                        }} onClick={() => setShowIndividual(!showIndividual)}>
                            <h4 style={{margin: 0, fontSize: 14}}>{'\u25C6'} Einzelne LEDs ({ledCount})</h4>
                            <span style={{fontSize: 18, color: 'var(--text-dim)', transition: 'transform 0.2s',
                                transform: showIndividual ? 'rotate(180deg)' : 'rotate(0)'}}>
                                {'\u25BE'}
                            </span>
                        </div>
                        {showIndividual && (
                            <div style={{padding: '0 14px 14px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                                    <span style={{fontSize: 12, color: 'var(--text-dim)'}}>{selectedLeds.size} ausgew√§hlt</span>
                                    <div style={{display: 'flex', gap: 6, alignItems: 'center'}}>
                                        <input type="color" value={color} onChange={e => setColor(e.target.value)} style={{width: 28, height: 28, border: 'none', borderRadius: 4}} />
                                        <button className="btn btn-sm" onClick={() => {
                                            const all = new Set();
                                            for (let i = 0; i < ledCount; i++) all.add(i);
                                            setSelectedLeds(all);
                                        }} style={{fontSize: 11}}>Alle</button>
                                        <button className="btn btn-sm" onClick={() => setSelectedLeds(new Set())} style={{fontSize: 11}}>Keine</button>
                                        <button className="btn btn-sm btn-primary" onClick={applyIndividual} style={{fontSize: 11}}>Setzen</button>
                                    </div>
                                </div>
                                <div className="led-strip">
                                    {Array.from({length: Math.min(ledCount, 300)}, (_, i) => (
                                        <div key={i}
                                            className={'led-pixel ' + (selectedLeds.has(i) ? 'selected' : '')}
                                            style={{ background: selectedLeds.has(i) ? color : '#1a1a25', color: color }}
                                            onClick={() => {
                                                const next = new Set(selectedLeds);
                                                next.has(i) ? next.delete(i) : next.add(i);
                                                setSelectedLeds(next);
                                            }}
                                            title={'LED ' + i}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* ‚îÄ‚îÄ Segments (collapsible) ‚îÄ‚îÄ */}
                    <div className="card" style={{padding: 0, overflow: 'hidden'}}>
                        <div style={{
                            display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                            padding: '10px 14px', cursor: 'pointer', userSelect: 'none',
                        }} onClick={() => setShowSegments(!showSegments)}>
                            <h4 style={{margin: 0, fontSize: 14}}>{'\u229E'} Segmente ({segments.length})</h4>
                            <span style={{fontSize: 18, color: 'var(--text-dim)', transition: 'transform 0.2s',
                                transform: showSegments ? 'rotate(180deg)' : 'rotate(0)'}}>
                                {'\u25BE'}
                            </span>
                        </div>
                        {showSegments && (
                            <div style={{padding: '0 14px 14px'}}>
                                <button className="btn btn-sm btn-primary" style={{marginBottom: 8}} onClick={() => {
                                    const lastEnd = segments.length > 0 ? segments[segments.length-1].stop || segments[segments.length-1].len || 0 : 0;
                                    setSegments([...segments, {start: lastEnd, stop: Math.min(lastEnd + 30, ledCount), col: [[255,255,255]]}]);
                                }}>+ Segment</button>
                                {segments.map((seg, i) => (
                                    <div key={i} style={{
                                        display: 'flex', gap: 8, alignItems: 'center', padding: '8px 0',
                                        borderBottom: '1px solid var(--border)'
                                    }}>
                                        <span style={{fontFamily: 'JetBrains Mono', fontSize: 11, color: 'var(--text-dim)', minWidth: 20}}>#{i}</span>
                                        <input type="number" value={seg.start || 0} min="0" max={ledCount} placeholder="Start"
                                            onChange={e => { const n = [...segments]; n[i] = {...n[i], start: parseInt(e.target.value)}; setSegments(n); }}
                                            style={{width: 60, padding: '4px 6px', background: 'var(--bg-input)', border: '1px solid var(--border)',
                                                borderRadius: 4, color: 'var(--text-primary)', fontSize: 12}} />
                                        <span style={{color: 'var(--text-dim)', fontSize: 12}}>{'\u2192'}</span>
                                        <input type="number" value={seg.stop || seg.len || 0} min="0" max={ledCount} placeholder="Stop"
                                            onChange={e => { const n = [...segments]; n[i] = {...n[i], stop: parseInt(e.target.value)}; setSegments(n); }}
                                            style={{width: 60, padding: '4px 6px', background: 'var(--bg-input)', border: '1px solid var(--border)',
                                                borderRadius: 4, color: 'var(--text-primary)', fontSize: 12}} />
                                        <button className="btn btn-sm" style={{color: '#f44', fontSize: 11}} onClick={() => {
                                            setSegments(segments.filter((_, j) => j !== i));
                                        }}>{'\u2715'}</button>
                                    </div>
                                ))}
                                {segments.length > 0 && (
                                    <button className="btn btn-primary" style={{marginTop: 10, fontSize: 12}} onClick={async () => {
                                        await API.post('/api/devices/' + selectedDevice + '/segments', { segments });
                                        toast('Segmente gespeichert', 'success');
                                    }}>Segmente speichern</button>
                                )}
                            </div>
                        )}
                    </div>
                </>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Autodarts Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function AutodartsPage({ autodartsConnected, devices }) {
    const [boards, setBoards] = useState([]);
    const [showAdd, setShowAdd] = useState(false);
    const [editBoard, setEditBoard] = useState(null);

    // Form state
    const [formName, setFormName] = useState('');
    const [formBoardId, setFormBoardId] = useState('');
    const [formPassword, setFormPassword] = useState('');
    const [formUser, setFormUser] = useState('');
    const [formDevices, setFormDevices] = useState([]);
    const [formEnabled, setFormEnabled] = useState(true);
    const [formAutoReconnect, setFormAutoReconnect] = useState(true);
    const [editPasswordSet, setEditPasswordSet] = useState(false);

    const toast = useToast();

    const refreshBoards = async () => {
        const data = await API.get('/api/autodarts/boards');
        if (data?.boards) setBoards(data.boards);
    };

    useEffect(() => { refreshBoards(); }, []);

    const resetForm = () => {
        setFormName(''); setFormBoardId('');
        setFormPassword(''); setFormUser(''); setFormDevices([]);
        setFormEnabled(true); setFormAutoReconnect(true);
        setEditBoard(null); setEditPasswordSet(false);
    };

    const openEdit = (board) => {
        setFormName(board.name);
        setFormBoardId(board.board_id);
        setFormPassword('');
        setFormUser(board.account_username || board.account_email || '');
        setFormDevices(board.assigned_devices || []);
        setFormEnabled(board.enabled);
        setFormAutoReconnect(board.auto_reconnect !== false);
        setEditBoard(board.board_id);
        setEditPasswordSet(board.password_set || false);
        setShowAdd(true);
    };

    const saveBoard = async () => {
        if (!formBoardId) { toast('Board ID erforderlich', 'error'); return; }
        if (!editBoard && (!formUser || !formPassword)) { toast('Benutzername und Passwort erforderlich', 'error'); return; }
        const payload = {
            board_id: formBoardId,
            name: formName || `Board ${formBoardId.slice(0,8)}`,
            account_username: formUser,
            account_password: formPassword,
            assigned_devices: formDevices,
            enabled: formEnabled,
            auto_reconnect: formAutoReconnect,
        };
        console.log('Board save payload:', JSON.stringify({...payload, account_password: payload.account_password ? '***SET***' : '(empty)'}));
        const result = await API.post('/api/autodarts/boards', payload);
        console.log('Board save result:', result);
        if (result?.success) {
            const pwMsg = formPassword ? ' (Passwort gespeichert)' : '';
            toast((editBoard ? 'Board aktualisiert' : 'Board hinzugefuegt') + pwMsg + '!', 'success');
            resetForm();
            setShowAdd(false);
            refreshBoards();
        } else {
            toast('Fehler beim Speichern!', 'error');
        }
    };

    const deleteBoard = async (boardId) => {
        await API.del(`/api/autodarts/boards/${boardId}`);
        toast('Board entfernt', 'success');
        refreshBoards();
    };

    const connectBoard = async (boardId) => {
        await API.post(`/api/autodarts/boards/${boardId}/connect`);
        toast('Verbindung wird hergestellt...', 'info');
        setTimeout(refreshBoards, 2000);
    };

    const disconnectBoard = async (boardId) => {
        await API.post(`/api/autodarts/boards/${boardId}/disconnect`);
        toast('Board getrennt', 'success');
        setTimeout(refreshBoards, 1000);
    };

    const toggleDevice = (deviceId) => {
        setFormDevices(prev =>
            prev.includes(deviceId)
                ? prev.filter(id => id !== deviceId)
                : [...prev, deviceId]
        );
    };

    // Collect all assigned device IDs from other boards
    const getAssignedElsewhere = (currentBoardId) => {
        const assigned = new Set();
        boards.forEach(b => {
            if (b.board_id !== currentBoardId) {
                (b.assigned_devices || []).forEach(d => assigned.add(d));
            }
        });
        return assigned;
    };

    return (
        <div>
            <div className="page-header">
                <h2>Autodarts ‚Äî Multi-Board Verwaltung</h2>
                <p>Verwalte mehrere Boards und Accounts, weise WLED-Controller pro Board zu</p>
            </div>

            <div style={{display: 'flex', gap: 12, marginBottom: 24}}>
                <button className="btn btn-primary" onClick={() => { resetForm(); setShowAdd(true); }}>
                    + Board hinzuf√ºgen
                </button>
                <button className="btn btn-success" onClick={() => API.post('/api/autodarts/connect-all')}>
                    ‚ñ∂ Alle verbinden
                </button>
                <button className="btn" onClick={() => API.post('/api/autodarts/disconnect-all')}>
                    ‚ñ† Alle trennen
                </button>
                <button className="btn" onClick={refreshBoards}>‚Üª Aktualisieren</button>
            </div>

            {/* Board list */}
            {boards.length > 0 && (
                <div style={{display: 'grid', gap: 16, marginBottom: 28}}>
                    {boards.map(board => {
                        const assignedDeviceNames = (board.assigned_devices || []).map(did => {
                            const d = devices.find(x => x.id === did);
                            return d ? d.name : did;
                        });

                        return (
                            <div key={board.board_id} className="card" style={{
                                borderLeftWidth: 4,
                                borderLeftColor: board.connected ? 'var(--success)' : board.enabled ? 'var(--warning)' : 'var(--text-dim)',
                            }}>
                                <div style={{display: 'flex', alignItems: 'start', gap: 20}}>
                                    {/* Status icon */}
                                    <div style={{
                                        width: 56, height: 56, borderRadius: 12,
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        fontSize: 26, flexShrink: 0,
                                        background: board.connected ? 'rgba(0,214,143,0.15)' :
                                            board.enabled ? 'rgba(240,160,48,0.15)' : 'rgba(96,96,120,0.15)',
                                    }}>
                                        üéØ
                                    </div>

                                    {/* Info */}
                                    <div style={{flex: 1, minWidth: 0}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: 4}}>
                                            <span style={{fontWeight: 700, fontSize: 18}}>{board.name}</span>
                                            <span className={`badge ${board.connected ? 'badge-success' : board.enabled ? 'badge-warning' : 'badge-danger'}`}>
                                                {board.connected ? '‚óè Verbunden' : board.enabled ? '‚óã Getrennt' : 'Deaktiviert'}
                                            </span>
                                        </div>

                                        {(board.account_username || board.account_email) && (
                                            <div style={{fontSize: 13, color: 'var(--text-secondary)', marginBottom: 4}}>
                                                üë§ {board.account_username || board.account_email}
                                                {board.authenticated && <span style={{color: 'var(--success)', marginLeft: 8}}>‚úì Auth</span>}
                                                {board.password_set ? <span style={{color: 'var(--success)', marginLeft: 8}}>üîë</span> : <span style={{color: 'var(--danger)', marginLeft: 8}}>‚ö† Kein Passwort</span>}
                                            </div>
                                        )}
                                        {!board.account_username && !board.account_email && (
                                            <div style={{fontSize: 13, color: 'var(--danger)', marginBottom: 4}}>
                                                ‚ö† Benutzername + Passwort nicht konfiguriert
                                            </div>
                                        )}

                                        <div style={{fontSize: 12, color: 'var(--text-dim)', fontFamily: 'JetBrains Mono', marginBottom: 8}}>
                                            Board: {board.board_id.slice(0, 12)}...
                                        </div>

                                        {/* Assigned devices */}
                                        <div style={{marginBottom: 8}}>
                                            <span style={{fontSize: 12, fontWeight: 600, color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: 0.5}}>
                                                Zugewiesene WLED-Geraete:
                                            </span>
                                            {assignedDeviceNames.length > 0 ? (
                                                <div style={{display: 'flex', gap: 6, flexWrap: 'wrap', marginTop: 6}}>
                                                    {assignedDeviceNames.map((name, i) => (
                                                        <span key={i} className="badge badge-info">{name}</span>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div style={{fontSize: 13, color: 'var(--danger)', marginTop: 4}}>
                                                    ‚ö† Keine Ger√§te zugewiesen ‚Äî Board wird keine LEDs steuern!
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Actions */}
                                    <div style={{display: 'flex', gap: 8, flexShrink: 0}}>
                                        {board.connected ? (
                                            <button className="btn btn-sm btn-danger" onClick={() => disconnectBoard(board.board_id)}>Trennen</button>
                                        ) : (
                                            <button className="btn btn-sm btn-success" onClick={() => connectBoard(board.board_id)} disabled={!board.enabled}>Verbinden</button>
                                        )}
                                        <button className="btn btn-sm" onClick={() => openEdit(board)}>‚úé Bearbeiten</button>
                                        <button className="btn btn-sm btn-danger" onClick={() => deleteBoard(board.board_id)}>‚úï</button>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {boards.length === 0 && !showAdd && (
                <div className="card" style={{textAlign: 'center', padding: 48}}>
                    <div style={{fontSize: 48, marginBottom: 16}}>üéØ</div>
                    <h3 style={{marginBottom: 8}}>Keine Boards konfiguriert</h3>
                    <p style={{color: 'var(--text-dim)', marginBottom: 20}}>
                        Fuege dein erstes Autodarts-Board hinzu und weise WLED-Geraete zu.
                    </p>
                    <button className="btn btn-primary" onClick={() => { resetForm(); setShowAdd(true); }}>
                        + Erstes Board hinzuf√ºgen
                    </button>
                </div>
            )}

            {/* Add/Edit Modal */}
            {showAdd && (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowAdd(false)}>
                    <div className="modal" style={{maxWidth: 700}}>
                        <h3>{editBoard ? `Board "${formName}" bearbeiten` : 'Neues Board hinzuf√ºgen'}</h3>

                        <div className="grid-2">
                            <div className="input-group">
                                <label>Board Name</label>
                                <input type="text" value={formName} onChange={e => setFormName(e.target.value)}
                                    placeholder="z.B. Wohnzimmer Board, Keller Board" />
                            </div>
                            <div className="input-group">
                                <label>Board ID *</label>
                                <input type="text" value={formBoardId} onChange={e => setFormBoardId(e.target.value)}
                                    placeholder="Autodarts Board ID" disabled={!!editBoard}
                                    style={{fontFamily: 'JetBrains Mono', fontSize: 13}} />
                            </div>
                            <div className="input-group">
                                <label>Autodarts Benutzername *</label>
                                <input type="text" value={formUser} onChange={e => setFormUser(e.target.value)}
                                    placeholder="Dein autodarts.io Benutzername" />
                            </div>
                            <div className="input-group">
                                <label>Account Passwort *</label>
                                <input type="password" value={formPassword} onChange={e => setFormPassword(e.target.value)}
                                    placeholder={editBoard ? (editPasswordSet ? '‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè (gespeichert ‚Äî leer lassen um beizubehalten)' : 'Passwort eingeben') : 'Dein autodarts.io Passwort'} />
                                <span style={{fontSize: 11, color: editBoard && editPasswordSet ? 'var(--success)' : 'var(--text-dim)', marginTop: 4}}>
                                    {editBoard && editPasswordSet ? '‚úì Passwort ist gespeichert. Nur ausfuellen wenn du es aendern willst.' : '‚ö† 2FA muss auf autodarts.io deaktiviert sein'}
                                </span>
                            </div>
                        </div>

                        <div style={{display: 'flex', gap: 24, marginBottom: 20}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: 10}}>
                                <div className={`toggle ${formEnabled ? 'active' : ''}`}
                                    onClick={() => setFormEnabled(!formEnabled)} />
                                <span style={{fontSize: 14}}>Board aktiv</span>
                            </div>
                            <div style={{display: 'flex', alignItems: 'center', gap: 10}}>
                                <div className={`toggle ${formAutoReconnect ? 'active' : ''}`}
                                    onClick={() => setFormAutoReconnect(!formAutoReconnect)} />
                                <span style={{fontSize: 14}}>Auto-Reconnect</span>
                            </div>
                        </div>

                        {/* Device assignment */}
                        <div style={{
                            background: 'var(--bg-primary)', borderRadius: 10, padding: 20,
                            border: '1px solid var(--border)', marginBottom: 20
                        }}>
                            <div style={{fontWeight: 700, fontSize: 15, marginBottom: 4}}>
                                üîå WLED-Geraete diesem Board zuweisen
                            </div>
                            <p style={{fontSize: 13, color: 'var(--text-dim)', marginBottom: 14}}>
                                W√§hle aus, welche WLED-Ger√§te bei Events dieses Boards leuchten sollen.
                                {boards.length > 1 && ' Bereits einem anderen Board zugewiesene Ger√§te sind markiert.'}
                            </p>

                            {devices.length === 0 ? (
                                <p style={{color: 'var(--warning)', fontSize: 13}}>
                                    ‚ö† Noch keine WLED-Geraete vorhanden. Fuege erst unter "Ger√§te" welche hinzu.
                                </p>
                            ) : (
                                <div style={{display: 'grid', gap: 8}}>
                                    {devices.map(device => {
                                        const isAssigned = formDevices.includes(device.id);
                                        const assignedElsewhere = getAssignedElsewhere(editBoard);
                                        const usedByOther = assignedElsewhere.has(device.id);
                                        const otherBoard = usedByOther
                                            ? boards.find(b => b.board_id !== editBoard && (b.assigned_devices || []).includes(device.id))
                                            : null;

                                        return (
                                            <div key={device.id}
                                                onClick={() => toggleDevice(device.id)}
                                                style={{
                                                    display: 'flex', alignItems: 'center', gap: 14,
                                                    padding: '10px 14px', borderRadius: 8, cursor: 'pointer',
                                                    background: isAssigned ? 'rgba(108,92,231,0.15)' : 'var(--bg-card)',
                                                    border: `1px solid ${isAssigned ? 'var(--accent)' : 'var(--border)'}`,
                                                    transition: 'all 0.15s',
                                                }}>
                                                {/* Checkbox */}
                                                <div style={{
                                                    width: 22, height: 22, borderRadius: 6,
                                                    border: `2px solid ${isAssigned ? 'var(--accent)' : 'var(--border)'}`,
                                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                    background: isAssigned ? 'var(--accent)' : 'transparent',
                                                    color: 'white', fontSize: 14, fontWeight: 700, flexShrink: 0,
                                                }}>
                                                    {isAssigned && '‚úì'}
                                                </div>

                                                {/* Status dot */}
                                                <span className={`status-dot ${device.online ? 'online' : 'offline'}`}></span>

                                                {/* Info */}
                                                <div style={{flex: 1}}>
                                                    <div style={{fontWeight: 600, fontSize: 14}}>{device.name}</div>
                                                    <div style={{fontSize: 12, color: 'var(--text-dim)', fontFamily: 'JetBrains Mono'}}>
                                                        {device.ip} ‚Äî {device.led_count || '?'} LEDs
                                                    </div>
                                                </div>

                                                {/* Warning if used by other board */}
                                                {usedByOther && !isAssigned && (
                                                    <span className="badge badge-warning" style={{fontSize: 10}}>
                                                        ‚ö† {otherBoard?.name || 'anderes Board'}
                                                    </span>
                                                )}
                                                {usedByOther && isAssigned && (
                                                    <span className="badge badge-warning" style={{fontSize: 10}}>
                                                        Auch auf: {otherBoard?.name}
                                                    </span>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            <div style={{marginTop: 12, fontSize: 12, color: 'var(--text-dim)'}}>
                                {formDevices.length} Ger√§t(e) ausgew√§hlt
                            </div>
                        </div>

                        <div style={{display: 'flex', gap: 10}}>
                            <button className="btn btn-primary" onClick={saveBoard}>
                                {editBoard ? 'üíæ Speichern' : '+ Hinzuf√ºgen'}
                            </button>
                            <button className="btn" onClick={() => { setShowAdd(false); resetForm(); }}>Abbrechen</button>
                        </div>
                    </div>
                </div>
            )}

            {/* How-to card */}
            <div className="card">
                <div className="card-header">
                    <span className="card-title">So richtest du alles ein</span>
                </div>
                <div style={{fontSize: 14, color: 'var(--text-secondary)', lineHeight: 1.8}}>
                    <p><strong>1.</strong> F√ºge unter <strong>"Ger√§te"</strong> deine WLED-Controller (Gledopto, ESP32, ESP8266) per IP hinzu</p>
                    <p><strong>2.</strong> Erstelle hier ein Board pro Autodarts-Board (mit Board ID + Benutzername + Passwort deines autodarts.io Accounts)</p>
                    <p><strong>3.</strong> Weise jedem Board die gewuenschten WLED-Geraete zu ‚Üí <em>Board A ‚Üí Controller am Board A, Board B ‚Üí Controller am Board B</em></p>
                    <p><strong>4.</strong> Konfiguriere unter <strong>"Events & Effekte"</strong> die LED-Animationen</p>
                    <p><strong>5.</strong> Klicke "Alle verbinden" ‚Äî fertig! Jedes Board steuert nur seine eigenen LEDs</p>
                    <p style={{marginTop: 12, color: 'var(--text-dim)'}}>üí° Du kannst verschiedene Autodarts-Accounts nutzen. Jedes Board hat seine eigenen Zugangsdaten.</p>
                </div>
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Events Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function CrowdPage() {
    const [config, setCfg] = useState({ enabled: false, master_volume: 0.5 });
    const [sounds, setSounds] = useState({});
    const [soundFiles, setSoundFiles] = useState([]);
    const toast = useToast();

    const categories = [
        { id: 'ambient', label: 'üå´ Ambient', desc: 'Hintergrund-Atmosph√§re' },
        { id: 'positive', label: 'üéâ Jubel', desc: 'Positive Reaktionen auf gute Scores' },
        { id: 'negative', label: 'üò© Entt√§uschung', desc: 'Reaktionen auf schlechte W√ºrfe' },
        { id: 'special', label: '‚ú® Spezial', desc: 'Besondere Momente' },
    ];

    useEffect(() => {
        API.get('/api/crowd/config').then(d => setCfg(d || {}));
        API.get('/api/crowd/sounds').then(d => setSounds(d?.sounds || {}));
        API.get('/api/caller/sounds').then(d => {
            // Reuse the sound file list from caller
        });
        API.get('/api/caller/files').then(d => setSoundFiles(d?.sounds || []));
    }, []);

    const saveCfg = (update) => {
        const next = { ...config, ...update };
        setCfg(next);
        API.post('/api/crowd/config', next);
    };

    const saveSound = (key, field, value) => {
        const next = { ...sounds, [key]: { ...sounds[key], [field]: value } };
        setSounds(next);
        // Save only the assignment data (sound, volume, enabled)
        const toSave = {};
        Object.entries(next).forEach(([k, v]) => {
            toSave[k] = { sound: v.sound || '', volume: v.volume || 0.5, enabled: v.enabled !== false };
        });
        API.post('/api/crowd/sounds', toSave);
    };

    const testSound = (key) => {
        API.post('/api/crowd/test', { key }).catch(() => toast.show('Kein Sound zugewiesen', 'error'));
    };

    return <>
        <div className="card" style={{padding: 16, marginBottom: 12}}>
            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                <div>
                    <h3 style={{margin: 0}}>üé≠ Crowd Sound Engine</h3>
                    <small style={{color: 'var(--text-dim)'}}>
                        Dynamische Publikums-Sounds die auf dein Spiel reagieren
                    </small>
                </div>
                <label style={{display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer'}}>
                    <span style={{fontSize: 13, color: config.enabled ? 'var(--accent)' : 'var(--text-dim)'}}>
                        {config.enabled ? 'Aktiv' : 'Aus'}
                    </span>
                    <input type="checkbox" checked={config.enabled || false}
                        onChange={e => saveCfg({ enabled: e.target.checked })}
                        style={{accentColor: 'var(--accent)', width: 18, height: 18}} />
                </label>
            </div>

            {config.enabled && (
                <div style={{marginTop: 12, display: 'flex', alignItems: 'center', gap: 12}}>
                    <label style={{fontSize: 13, color: 'var(--text-dim)', whiteSpace: 'nowrap'}}>Master-Lautst√§rke:</label>
                    <input type="range" min="0" max="1" step="0.05" value={config.master_volume || 0.5}
                        onChange={e => saveCfg({ master_volume: parseFloat(e.target.value) })}
                        style={{flex: 1, accentColor: 'var(--accent)'}} />
                    <span style={{fontFamily: 'monospace', fontSize: 13, minWidth: 36}}>
                        {Math.round((config.master_volume || 0.5) * 100)}%
                    </span>
                </div>
            )}
        </div>

        {config.enabled && categories.map(cat => {
            const catSounds = Object.entries(sounds).filter(([k, v]) => v.category === cat.id);
            if (catSounds.length === 0) return null;
            return (
                <div key={cat.id} className="card" style={{padding: 16, marginBottom: 12}}>
                    <h4 style={{margin: '0 0 4px'}}>{cat.label}</h4>
                    <small style={{color: 'var(--text-dim)', display: 'block', marginBottom: 12}}>{cat.desc}</small>
                    <div style={{display: 'flex', flexDirection: 'column', gap: 6}}>
                        {catSounds.map(([key, s]) => (
                            <div key={key} style={{
                                display: 'flex', alignItems: 'center', gap: 8, padding: '6px 8px',
                                background: s.sound ? 'rgba(139,92,246,0.06)' : 'transparent',
                                borderRadius: 6, border: '1px solid var(--border)',
                                opacity: s.enabled === false ? 0.5 : 1,
                            }}>
                                <input type="checkbox" checked={s.enabled !== false}
                                    onChange={e => saveSound(key, 'enabled', e.target.checked)}
                                    style={{accentColor: 'var(--accent)'}} />
                                <div style={{minWidth: 140}}>
                                    <div style={{fontSize: 13, fontWeight: 500}}>{s.label}</div>
                                    <div style={{fontSize: 11, color: 'var(--text-dim)'}}>{s.description}</div>
                                </div>
                                <select value={s.sound || ''} onChange={e => saveSound(key, 'sound', e.target.value)}
                                    style={{flex: 1, padding: '4px 6px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4, fontSize: 12}}>
                                    <option value="">‚Äî Kein Sound ‚Äî</option>
                                    {soundFiles.map(f => <option key={f.filename} value={f.filename}>{f.filename}</option>)}
                                </select>
                                <input type="range" min="0" max="1" step="0.05" value={s.volume || 0.5}
                                    onChange={e => saveSound(key, 'volume', parseFloat(e.target.value))}
                                    style={{width: 60, accentColor: 'var(--accent)'}} title={`${Math.round((s.volume||0.5)*100)}%`} />
                                <button onClick={() => testSound(key)} title="Testen"
                                    style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: 14, color: 'var(--accent)'}}>‚ñ∂</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        })}
    </>;
}


function ClipsTab() {
    const [clipFiles, setClipFiles] = useState([]);
    const [assignments, setAssignments] = useState({});
    const [uploading, setUploading] = useState(false);
    const toast = useToast();

    const clipEvents = [
        {id: 'match_won', label: 'üèÜ Match gewonnen'},
        {id: 'game_won', label: 'üéâ Leg gewonnen'},
        {id: 'busted', label: 'üí• Bust'},
        {id: 'game_on', label: 'üéØ Game On'},
        {id: '180', label: 'üî• 180!'},
        {id: 'high_score', label: '‚≠ê High Score (100+)'},
        {id: 'checkout_possible', label: 'üéØ Checkout m√∂glich'},
        {id: 'miss', label: 'üòÖ Daneben (Miss)'},
        {id: 'bullseye', label: 'üéØ Bullseye'},
    ];

    useEffect(() => {
        API.get('/api/clips/files').then(d => setClipFiles(d?.files || []));
        API.get('/api/clips/assignments').then(d => setAssignments(d || {}));
    }, []);

    const handleUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setUploading(true);
        const formData = new FormData();
        formData.append('file', file);
        try {
            const resp = await fetch('/api/clips/upload', { method: 'POST', body: formData });
            if (resp.ok) {
                API.get('/api/clips/files').then(d => setClipFiles(d?.files || []));
                toast.show('Clip hochgeladen!', 'success');
            }
        } catch(err) { toast.show('Upload fehlgeschlagen', 'error'); }
        setUploading(false);
        e.target.value = '';
    };

    const saveAssignment = (eventId, clip, duration) => {
        const next = {...assignments};
        if (clip) {
            next[eventId] = { clip, duration: duration || 5 };
        } else {
            delete next[eventId];
        }
        setAssignments(next);
        API.post('/api/clips/assignments', next);
    };

    const deleteClip = async (filename) => {
        await fetch(`/api/clips/files/${filename}`, {method: 'DELETE'});
        setClipFiles(clipFiles.filter(f => f.filename !== filename));
        const next = {...assignments};
        Object.keys(next).forEach(k => { if (next[k]?.clip === filename) delete next[k]; });
        setAssignments(next);
        API.post('/api/clips/assignments', next);
    };

    const testClip = (filename) => {
        // Show clip overlay locally for testing
        window.dispatchEvent(new CustomEvent('throwsync-test-clip', { detail: { clip: filename, duration: 5 } }));
    };

    return <>
        <div className="card" style={{padding: 16, marginBottom: 12}}>
            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12}}>
                <div>
                    <h3 style={{margin: 0}}>üé¨ Video- & GIF-Clips</h3>
                    <small style={{color: 'var(--text-dim)'}}>Clips werden als Fullscreen-Overlay angezeigt wenn ein Event ausgel√∂st wird</small>
                </div>
                <label className="btn btn-primary" style={{cursor: 'pointer', opacity: uploading ? 0.5 : 1}}>
                    {uploading ? '‚è≥ ...' : 'üìÅ Clip hochladen'}
                    <input type="file" accept="video/*,image/gif,.gif,.mp4,.webm,.mov,.jpg,.png" hidden onChange={handleUpload} />
                </label>
            </div>

            {clipFiles.length === 0 && (
                <div style={{padding: 24, textAlign: 'center', color: 'var(--text-dim)', border: '1px dashed var(--border)', borderRadius: 8}}>
                    Noch keine Clips hochgeladen. Unterst√ºtzt: MP4, WebM, GIF, MOV, JPG, PNG
                </div>
            )}

            {clipFiles.length > 0 && (
                <div style={{display: 'flex', gap: 8, flexWrap: 'wrap'}}>
                    {clipFiles.map(f => (
                        <div key={f.filename} style={{
                            padding: '6px 10px', background: 'var(--bg-card)', borderRadius: 6,
                            border: '1px solid var(--border)', display: 'flex', alignItems: 'center', gap: 6, fontSize: 13
                        }}>
                            <span>{f.type === 'video' ? 'üé¨' : 'üñºÔ∏è'}</span>
                            <span style={{fontFamily: 'monospace'}}>{f.filename}</span>
                            <small style={{color: 'var(--text-dim)'}}>({(f.size/1024).toFixed(0)}KB)</small>
                            <button onClick={() => testClip(f.filename)} title="Vorschau"
                                style={{background: 'none', border: 'none', color: 'var(--accent)', cursor: 'pointer', fontSize: 14}}>‚ñ∂</button>
                            <button onClick={() => deleteClip(f.filename)} title="L√∂schen"
                                style={{background: 'none', border: 'none', color: '#f44', cursor: 'pointer', fontSize: 14}}>‚úï</button>
                        </div>
                    ))}
                </div>
            )}
        </div>

        <div className="card" style={{padding: 16}}>
            <h3 style={{margin: '0 0 12px'}}>Event ‚Üí Clip Zuweisungen</h3>
            <div style={{display: 'flex', flexDirection: 'column', gap: 6}}>
                {clipEvents.map(ev => {
                    const a = assignments[ev.id];
                    return (
                        <div key={ev.id} style={{
                            display: 'flex', alignItems: 'center', gap: 8, padding: '8px 10px',
                            background: a?.clip ? 'rgba(139,92,246,0.08)' : 'transparent',
                            borderRadius: 6, border: '1px solid var(--border)',
                        }}>
                            <span style={{minWidth: 180}}>{ev.label}</span>
                            <select value={a?.clip || ''} onChange={e => saveAssignment(ev.id, e.target.value, a?.duration)}
                                style={{flex: 1, padding: '4px 8px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4}}>
                                <option value="">‚Äî Kein Clip ‚Äî</option>
                                {clipFiles.map(f => <option key={f.filename} value={f.filename}>{f.filename}</option>)}
                            </select>
                            {a?.clip && <>
                                <label style={{fontSize: 12, color: 'var(--text-dim)'}}>Dauer:</label>
                                <input type="number" min="1" max="30" value={a?.duration || 5}
                                    onChange={e => saveAssignment(ev.id, a.clip, parseInt(e.target.value) || 5)}
                                    style={{width: 50, padding: '4px 6px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4}} />
                                <small style={{color: 'var(--text-dim)'}}>Sek.</small>
                            </>}
                        </div>
                    );
                })}
            </div>
        </div>
    </>;
}


function EventsPage({ devices }) {
    const [events, setEvents] = useState({});
    const [editEvent, setEditEvent] = useState(null);
    const [expandedCats, setExpandedCats] = useState({});
    const [filterEnabled, setFilterEnabled] = useState(false);
    const [loadError, setLoadError] = useState(false);
    const [loading, setLoading] = useState(true);
    const [clipboard, setClipboard] = useState(null);
    const [bulkMode, setBulkMode] = useState(false);
    const [selected, setSelected] = useState(new Set());
    const [showBulkEdit, setShowBulkEdit] = useState(false);
    const { t } = useI18n();
    const [showLog, setShowLog] = useState(false);
    const [eventLog, setEventLog] = useState([]);
    const [activeTab, setActiveTab] = useState('led'); // 'led' or 'caller'
    const toast = useToast();

    useEffect(() => {
        setLoading(true);
        setLoadError(false);
        API.get('/api/autodarts/events').then(data => {
            if (data?.events && Object.keys(data.events).length > 0) {
                setEvents(data.events);
            } else {
                setLoadError(true);
            }
            setLoading(false);
        }).catch(() => {
            setLoadError(true);
            setLoading(false);
        });
    }, []);

    const categoryMeta = {
        game:               { icon: 'üéÆ', label: 'Spiel-Events', desc: 'Game On, Game/Match gewonnen, Busted' },
        single_dart:        { icon: 'üéØ', label: 'Einzelwurf (Segment-Typ)', desc: 'Single, Double, Triple, Bull, Miss' },
        single_dart_number: { icon: 'üî¢', label: 'Einzelwurf (nach Zahl)', desc: 'S1‚ÄìS20, D1‚ÄìD20, T1‚ÄìT20 ‚Äî einzeln konfigurierbar', collapsed: true },
        dart_position:      { icon: 'ü•á', label: 'Dart-Position', desc: '1., 2. oder 3. Dart der Aufnahme' },
        round_score:        { icon: 'üìä', label: 'Runden-Score (Aufnahme)', desc: '180, 140+, 100+, Bett & Fr√ºhst√ºck usw.' },
        checkout:           { icon: '‚úÖ', label: 'Checkout / Finish', desc: 'Checkout m√∂glich, getroffen, High Finish' },
        turn:               { icon: 'üîÑ', label: 'Spielerwechsel', desc: 'Wer ist dran? Mein Wurf / Gegner / Darts gezogen' },
        takeout:            { icon: 'ü§ö', label: 'Takeout (Darts rausziehen)', desc: 'Board erkennt Darts rausziehen' },
        cricket:            { icon: 'üèè', label: 'Cricket-Spezifisch', desc: 'Cricket-Treffer, Zahl geschlossen, Daneben' },
        ambient:            { icon: 'üåà', label: 'Ambient / Idle', desc: 'Leerlauf-Beleuchtung wenn nichts passiert' },
    };

    const categoryOrder = ['game', 'single_dart', 'single_dart_number', 'dart_position', 'round_score', 'checkout', 'turn', 'takeout', 'cricket', 'ambient'];

    const testEvent = async (eventName) => {
        await API.post('/api/autodarts/test-event', { event: eventName });
        toast(`Event "${eventName}" getestet`, 'info');
    };

    const saveEvents = async () => {
        await API.post('/api/autodarts/events', { events });
        toast('Alle Events gespeichert!', 'success');
    };

    // Copy/Paste
    const copyEffect = (eventKey) => {
        const ev = events[eventKey];
        if (!ev) return;
        setClipboard({ effect: ev.effect, duration: ev.duration, chain: ev.chain });
        toast(`"${ev.label}" kopiert`, 'success');
    };

    const pasteEffect = (eventKey) => {
        if (!clipboard) return;
        setEvents(prev => ({
            ...prev,
            [eventKey]: { ...prev[eventKey], effect: clipboard.effect, duration: clipboard.duration, chain: clipboard.chain }
        }));
        toast(`Effekt eingefuegt`, 'success');
    };

    const pasteToSelected = () => {
        if (!clipboard || selected.size === 0) return;
        const updated = { ...events };
        selected.forEach(key => {
            if (updated[key]) {
                updated[key] = { ...updated[key], effect: clipboard.effect, duration: clipboard.duration, chain: clipboard.chain };
            }
        });
        setEvents(updated);
        toast(`Effekt auf ${selected.size} Events eingefuegt`, 'success');
    };

    // Bulk edit
    const toggleSelect = (key) => {
        setSelected(prev => {
            const next = new Set(prev);
            next.has(key) ? next.delete(key) : next.add(key);
            return next;
        });
    };

    const selectAll = (cat) => {
        const keys = (grouped[cat] || []).map(e => e.key);
        setSelected(prev => {
            const next = new Set(prev);
            const allSelected = keys.every(k => next.has(k));
            keys.forEach(k => allSelected ? next.delete(k) : next.add(k));
            return next;
        });
    };

    const bulkToggleEnabled = (enabled) => {
        const updated = { ...events };
        selected.forEach(key => { if (updated[key]) updated[key] = { ...updated[key], enabled }; });
        setEvents(updated);
        toast(`${selected.size} Events ${enabled ? 'aktiviert' : 'deaktiviert'}`, 'success');
    };

    const bulkApplyEffect = async (changes) => {
        const keys = [...selected];
        await API.post('/api/autodarts/events/bulk', { keys, changes });
        // Reload
        const data = await API.get('/api/autodarts/events');
        if (data?.events) setEvents(data.events);
        setShowBulkEdit(false);
        toast(`${keys.length} Events aktualisiert`, 'success');
    };

    // Event Log
    const loadLog = () => API.get('/api/event-log').then(d => setEventLog(d?.log || []));
    const clearLog = async () => { await API.post('/api/event-log/clear'); setEventLog([]); };

    // Listen for live events via WS
    useEffect(() => {
        const handler = (e) => {
            try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'event_fired' && msg.entry) {
                    setEventLog(prev => [...prev.slice(-99), msg.entry]);
                }
            } catch {}
        };
        // Try to hook into existing WS ‚Äî or just poll
        if (showLog) loadLog();
    }, [showLog]);

    const toggleCat = (cat) => {
        setExpandedCats(prev => ({...prev, [cat]: !prev[cat]}));
    };

    // Group events by category
    const grouped = {};
    Object.entries(events).forEach(([key, event]) => {
        const cat = event.category || 'other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ key, ...event });
    });

    const enabledCount = Object.values(events).filter(e => e.enabled).length;
    const totalCount = Object.keys(events).length;

    return (
        <div>
            <div className="page-header">
                <h2>Events & Caller</h2>
                <p>LED-Effekte und Sound-Ansagen konfigurieren</p>
            </div>

            {/* Tab Switcher */}
            <div style={{display: 'flex', gap: 2, marginBottom: 16, background: 'var(--bg-secondary)', borderRadius: 8, padding: 3}}>
                {[
                    {id: 'led', label: `\u26A1 ${t('tab.led', 'LED Effekte')}`, count: `${enabledCount}/${totalCount}`},
                    {id: 'caller', label: `\uD83C\uDF99 ${t('tab.caller', 'Caller Sounds')}`},
                    {id: 'clips', label: `\uD83C\uDFAC ${t('tab.clips', 'Clips')}`},
                    {id: 'crowd', label: `\uD83C\uDFAD ${t('tab.crowd', 'Crowd')}`},
                ].map(tab => (
                    <div key={tab.id} onClick={() => setActiveTab(tab.id)} style={{
                        flex: 1, padding: '8px 12px', borderRadius: 6, cursor: 'pointer', textAlign: 'center',
                        fontSize: 13, fontWeight: 600, transition: 'all 0.15s',
                        background: activeTab === tab.id ? 'var(--accent)' : 'transparent',
                        color: activeTab === tab.id ? '#fff' : 'var(--text-dim)',
                    }}>
                        {tab.label} {tab.count && <span style={{fontSize: 11, opacity: 0.7}}>({tab.count})</span>}
                    </div>
                ))}
            </div>

            {/* LED Events Tab */}
            {activeTab === 'led' && <>

            {/* Profile Bar */}
            <ProfileBar />

            <div style={{display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center'}}>
                <button className="btn btn-primary" onClick={saveEvents}>üíæ Speichern</button>
                <button className={`btn ${bulkMode ? 'btn-primary' : ''}`}
                    onClick={() => { setBulkMode(!bulkMode); setSelected(new Set()); }}
                    style={{fontSize: 12}}>
                    {bulkMode ? `‚úì ${selected.size} ausgewaehlt` : '‚òê Mehrfachauswahl'}
                </button>
                <button className={`btn ${showLog ? 'btn-primary' : ''}`}
                    onClick={() => { setShowLog(!showLog); if (!showLog) loadLog(); }}
                    style={{fontSize: 12}}>
                    üìã Event-Log
                </button>
                <div style={{display: 'flex', alignItems: 'center', gap: 8, marginLeft: 'auto'}}>
                    {clipboard && (
                        <span style={{fontSize: 11, color: 'var(--success)', padding: '4px 10px',
                            background: 'rgba(0,214,143,0.1)', borderRadius: 6}}>
                            üìã Kopiert: {clipboard.effect?.fx !== undefined ? (WLED_EFFECTS[clipboard.effect.fx] || `FX#${clipboard.effect.fx}`) : '?'}
                        </span>
                    )}
                    <div className={`toggle ${filterEnabled ? 'active' : ''}`}
                        onClick={() => setFilterEnabled(!filterEnabled)} />
                    <span style={{fontSize: 12}}>Nur aktive</span>
                </div>
            </div>

            {/* Bulk Edit Toolbar */}
            {bulkMode && selected.size > 0 && (
                <div style={{
                    display: 'flex', gap: 8, padding: '10px 14px', marginBottom: 16,
                    background: 'rgba(108,92,231,0.1)', borderRadius: 10,
                    border: '1px solid rgba(108,92,231,0.3)', flexWrap: 'wrap', alignItems: 'center',
                }}>
                    <span style={{fontSize: 13, fontWeight: 600}}>{selected.size} ausgewaehlt:</span>
                    <button className="btn btn-sm" onClick={() => bulkToggleEnabled(true)} style={{fontSize: 11}}>‚úì Alle aktivieren</button>
                    <button className="btn btn-sm" onClick={() => bulkToggleEnabled(false)} style={{fontSize: 11}}>‚úó Alle deaktivieren</button>
                    {clipboard && (
                        <button className="btn btn-sm" onClick={pasteToSelected}
                            style={{fontSize: 11, background: 'rgba(0,214,143,0.15)', borderColor: 'rgba(0,214,143,0.3)'}}>
                            üìã Effekt einfuegen
                        </button>
                    )}
                    <button className="btn btn-sm" onClick={() => setShowBulkEdit(true)} style={{fontSize: 11}}>üé® Effekt aendern</button>
                    <button className="btn btn-sm" onClick={() => setSelected(new Set())} style={{fontSize: 11, marginLeft: 'auto'}}>Auswahl aufheben</button>
                </div>
            )}

            {/* Event Log Panel */}
            {showLog && (
                <div className="card" style={{marginBottom: 20, maxHeight: 300, overflow: 'auto'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10}}>
                        <div className="card-title" style={{margin: 0}}>üìã Event-Log (Live)</div>
                        <div style={{display: 'flex', gap: 8}}>
                            <button className="btn btn-sm" onClick={loadLog} style={{fontSize: 11}}>‚Üª Aktualisieren</button>
                            <button className="btn btn-sm" onClick={clearLog} style={{fontSize: 11}}>‚úï Leeren</button>
                        </div>
                    </div>
                    {eventLog.length === 0 ? (
                        <p style={{color: 'var(--text-dim)', fontSize: 13, textAlign: 'center', padding: 20}}>
                            Noch keine Events. Wirf einen Dart oder teste einen Trigger!
                        </p>
                    ) : (
                        <div style={{display: 'grid', gap: 4}}>
                            {[...eventLog].reverse().slice(0, 50).map((entry, idx) => {
                                const time = new Date(entry.timestamp * 1000);
                                const timeStr = time.toLocaleTimeString('de-DE');
                                const evData = events[entry.event];
                                const col = evData?.effect?.col?.[0] || [100, 100, 100];
                                return (
                                    <div key={idx} style={{
                                        display: 'flex', gap: 8, alignItems: 'center',
                                        padding: '6px 10px', borderRadius: 6,
                                        background: 'rgba(0,0,0,0.2)', fontSize: 12,
                                    }}>
                                        <span style={{
                                            width: 10, height: 10, borderRadius: '50%', flexShrink: 0,
                                            background: `rgb(${col.join(',')})`,
                                        }} />
                                        <span style={{color: 'var(--text-dim)', fontFamily: 'JetBrains Mono', fontSize: 11, minWidth: 60}}>
                                            {timeStr}
                                        </span>
                                        <span style={{fontWeight: 600, color: 'var(--text-primary)'}}>
                                            {entry.details?.label || entry.event}
                                        </span>
                                        <span style={{color: 'var(--text-dim)', fontSize: 11}}>
                                            {entry.board || ''}
                                        </span>
                                        {entry.details?.fx !== undefined && (
                                            <span style={{color: 'var(--accent-bright)', fontSize: 11, marginLeft: 'auto'}}>
                                                {WLED_EFFECTS[entry.details.fx] || `FX#${entry.details.fx}`}
                                            </span>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            )}

            {loading && (
                <div className="card" style={{textAlign: 'center', padding: 40}}>
                    <div style={{fontSize: 24, marginBottom: 12}}>‚ü≥</div>
                    <p>Lade Events...</p>
                </div>
            )}

            {!loading && loadError && (
                <div className="card" style={{padding: 24, borderColor: 'rgba(255,100,50,0.4)'}}>
                    <h3 style={{margin: '0 0 12px 0', color: '#ff6432'}}>‚ö† Events konnten nicht geladen werden</h3>
                    <p style={{color: 'var(--text-secondary)', margin: '0 0 16px 0'}}>
                        Das passiert wenn der Server nicht l√§uft oder die Abh√§ngigkeiten noch nicht installiert sind.
                    </p>
                    <div style={{background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: 16, fontFamily: 'monospace', fontSize: 13, lineHeight: 2}}>
                        <div style={{color: 'var(--text-dim)', marginBottom: 4}}># So startest du den Server:</div>
                        <div><span style={{color: '#6c5ce7'}}>cd</span> throwsync</div>
                        <div><span style={{color: '#6c5ce7'}}>chmod</span> +x install.sh</div>
                        <div><span style={{color: '#6c5ce7'}}>./install.sh</span>  <span style={{color: 'var(--text-dim)'}}># installiert alles automatisch</span></div>
                        <div style={{color: 'var(--text-dim)', marginTop: 8, marginBottom: 4}}># Oder falls schon installiert:</div>
                        <div><span style={{color: '#6c5ce7'}}>./start.sh</span></div>
                    </div>
                    <button className="btn" style={{marginTop: 16}} onClick={() => window.location.reload()}>‚Üª Erneut versuchen</button>
                </div>
            )}

            {!loading && !loadError && <>
            {categoryOrder.map(category => {
                const catEvents = grouped[category] || [];
                if (catEvents.length === 0) return null;

                const meta = categoryMeta[category] || { icon: '‚ö°', label: category, desc: '' };
                const isCollapsedDefault = meta.collapsed && !expandedCats[category];
                const isExpanded = expandedCats[category] || !meta.collapsed;
                const filteredEvents = filterEnabled ? catEvents.filter(e => e.enabled) : catEvents;
                const enabledInCat = catEvents.filter(e => e.enabled).length;

                if (filterEnabled && filteredEvents.length === 0) return null;

                return (
                    <div key={category} style={{marginBottom: 24}}>
                        <div onClick={() => toggleCat(category)} style={{
                            display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer',
                            marginBottom: 10, padding: '8px 0', userSelect: 'none',
                        }}>
                            <span style={{fontSize: 20}}>{meta.icon}</span>
                            <div style={{flex: 1}}>
                                <span style={{fontWeight: 700, fontSize: 15}}>{meta.label}</span>
                                <span style={{fontSize: 12, color: 'var(--text-dim)', marginLeft: 10}}>
                                    {enabledInCat}/{catEvents.length} aktiv
                                </span>
                                {meta.desc && <div style={{fontSize: 12, color: 'var(--text-dim)'}}>{meta.desc}</div>}
                            </div>
                            <span style={{color: 'var(--text-dim)', fontSize: 12}}>
                                {isExpanded ? '‚ñº' : '‚ñ∂'} {catEvents.length} Trigger
                            </span>
                            {bulkMode && (
                                <button className="btn btn-sm" onClick={(e) => { e.stopPropagation(); selectAll(category); }}
                                    style={{fontSize: 10, padding: '2px 8px'}}>
                                    Alle
                                </button>
                            )}
                        </div>

                        {isExpanded && (
                            <div style={{display: 'grid', gap: 3}}>
                                {filteredEvents.map(event => (
                                    <div key={event.key} style={{
                                        display: 'flex', alignItems: 'center', gap: 8, padding: '6px 10px',
                                        background: selected.has(event.key) ? 'rgba(108,92,231,0.08)' : 'var(--bg-card)',
                                        borderRadius: 6, border: `1px solid ${selected.has(event.key) ? 'var(--accent)' : 'var(--border)'}`,
                                        opacity: event.enabled ? 1 : 0.4, fontSize: 13, cursor: 'pointer',
                                        transition: 'opacity 0.15s',
                                    }} onClick={() => bulkMode ? toggleSelect(event.key) : setEditEvent(event.key)}>
                                        {/* Color dot */}
                                        <div style={{
                                            width: 10, height: 10, borderRadius: '50%', flexShrink: 0,
                                            background: event.effect?.col?.[0] ? `rgb(${event.effect.col[0].join(',')})` : 'var(--accent)',
                                        }} />
                                        {/* Label */}
                                        <span style={{flex: 1, fontWeight: 500, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {event.label || event.key}
                                        </span>
                                        {/* Effect info */}
                                        <span style={{fontSize: 11, color: 'var(--text-dim)', flexShrink: 0, fontFamily: 'JetBrains Mono'}}>
                                            {WLED_EFFECTS[event.effect?.fx] || `FX${event.effect?.fx ?? 0}`}
                                            {event.chain?.length > 0 && ` ‚õì${event.chain.length}`}
                                        </span>
                                        {/* Actions */}
                                        <div style={{display: 'flex', gap: 2, flexShrink: 0}} onClick={e => e.stopPropagation()}>
                                            <div className={`toggle ${event.enabled ? 'active' : ''}`} style={{transform: 'scale(0.8)'}}
                                                onClick={() => {
                                                    const updated = {...events};
                                                    updated[event.key] = {...updated[event.key], enabled: !event.enabled};
                                                    setEvents(updated);
                                                }} />
                                            <button className="btn btn-sm" onClick={() => testEvent(event.key)}
                                                style={{padding: '2px 6px', fontSize: 10, minWidth: 0}}>‚ñ∂</button>
                                            <button className="btn btn-sm" onClick={() => copyEffect(event.key)}
                                                style={{padding: '2px 5px', fontSize: 10, minWidth: 0}}>üìã</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            })}

            {/* Hint card */}
            <div className="card" style={{marginTop: 16}}>
                <div style={{fontSize: 13, color: 'var(--text-dim)', lineHeight: 1.8}}>
                    <strong>üí° Priorit√§t:</strong> Wenn z.B. ein T20 geworfen wird, wird zuerst gepr√ºft ob <em>Triple 20</em> (Einzelzahl) aktiviert ist.
                    Falls nicht, greift <em>Triple (T1‚ÄìT20)</em> (Segment-Typ). So kannst du spezielle Felder besonders hervorheben!
                    <br /><strong>üí° Runden-Score:</strong> Wird ausgel√∂st wenn alle 3 Darts geworfen sind (Darts gezogen).
                    Der passendste Score-Bereich wird gew√§hlt.
                </div>
            </div>

            {/* ‚îÄ‚îÄ Advanced Features ‚îÄ‚îÄ */}
            <PlayerColorsEditor />
            <BrightnessScheduleEditor />
            <SegmentZonesEditor />
            <StatsAmbientConfig />
            </>}
            </>}

            {/* ‚îÄ‚îÄ Caller Tab ‚îÄ‚îÄ */}
            {activeTab === 'caller' && <CallerPage />}

            {/* ‚îÄ‚îÄ Clips Tab ‚îÄ‚îÄ */}
            {activeTab === 'clips' && <ClipsTab clipFiles={[]} />}

            {/* ‚îÄ‚îÄ Crowd Tab ‚îÄ‚îÄ */}
            {activeTab === 'crowd' && <CrowdPage />}

            {/* Edit Modal */}
            {editEvent && events[editEvent] && (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setEditEvent(null)}>
                    <div className="modal" style={{maxWidth: 620, maxHeight: '92vh', overflow: 'auto'}}>
                        <h3>Event bearbeiten: {events[editEvent].label}</h3>
                        <EventEditor
                            event={events[editEvent]}
                            devices={devices}
                            onChange={updated => {
                                setEvents({...events, [editEvent]: updated});
                            }}
                        />
                        <div style={{display: 'flex', gap: 8, marginTop: 20, flexWrap: 'wrap'}}>
                            <button className="btn btn-primary" onClick={() => { saveEvents(); setEditEvent(null); }}>Speichern</button>
                            <button className="btn" onClick={() => setEditEvent(null)}>Schliessen</button>
                            <button className="btn btn-sm" onClick={() => copyEffect(editEvent)}
                                style={{fontSize: 11}}>üìã Kopieren</button>
                            {clipboard && (
                                <button className="btn btn-sm" onClick={() => {
                                    pasteEffect(editEvent);
                                    // Force re-render by re-setting editEvent
                                    const key = editEvent; setEditEvent(null); setTimeout(() => setEditEvent(key), 10);
                                }} style={{fontSize: 11}}>üìã Einfuegen</button>
                            )}
                            <button className="btn btn-sm" onClick={() => testEvent(editEvent)} style={{marginLeft: 'auto'}}>‚ñ∂ Testen</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Bulk Edit Modal */}
            {showBulkEdit && (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowBulkEdit(false)}>
                    <div className="modal" style={{maxWidth: 500}}>
                        <h3>Bulk Edit: {selected.size} Events aendern</h3>
                        <BulkEditPanel
                            onApply={bulkApplyEffect}
                            onCancel={() => setShowBulkEdit(false)}
                        />
                    </div>
                </div>
            )}
        </div>
    );
}

// ‚îÄ‚îÄ‚îÄ Bulk Edit Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function BulkEditPanel({ onApply, onCancel }) {
    const [changes, setChanges] = useState({});
    const [changeFx, setChangeFx] = useState(false);
    const [changeColor, setChangeColor] = useState(false);
    const [changeBri, setChangeBri] = useState(false);
    const [changeSx, setChangeSx] = useState(false);
    const [changeDuration, setChangeDuration] = useState(false);

    const effect = changes.effect || {};
    const updateEffect = (k, v) => setChanges(prev => {
        const eff = {...(prev.effect || {}), [k]: v};
        // When user changes color, reset palette so col values are actually used by WLED
        if (k === 'col') eff.pal = 0;
        return {...prev, effect: eff};
    });

    return (
        <div>
            <p style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 16}}>
                Waehle aus welche Eigenschaften geaendert werden sollen. Nur aktivierte Aenderungen werden angewendet.
            </p>

            {/* Effect */}
            <div style={{padding: '10px 0', borderBottom: '1px solid var(--border)'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: changeFx ? 8 : 0}}>
                    <div className={`toggle ${changeFx ? 'active' : ''}`} onClick={() => setChangeFx(!changeFx)} />
                    <span style={{fontSize: 13}}>Effekt aendern</span>
                </div>
                {changeFx && (
                    <select value={effect.fx ?? 0} onChange={e => updateEffect('fx', parseInt(e.target.value))}>
                        {Object.entries(WLED_EFFECTS).map(([k,v]) => <option key={k} value={k}>{v}</option>)}
                    </select>
                )}
            </div>

            {/* Color */}
            <div style={{padding: '10px 0', borderBottom: '1px solid var(--border)'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: changeColor ? 8 : 0}}>
                    <div className={`toggle ${changeColor ? 'active' : ''}`} onClick={() => setChangeColor(!changeColor)} />
                    <span style={{fontSize: 13}}>Farbe aendern</span>
                </div>
                {changeColor && (
                    <div style={{display: 'flex', gap: 8, flexWrap: 'wrap'}}>
                        <input type="color" value={'#' + (effect.col?.[0] || [255,255,255]).map(c => c.toString(16).padStart(2,'0')).join('')}
                            onChange={e => {
                                const hex = e.target.value;
                                updateEffect('col', [[parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)]]);
                            }} />
                        {[[255,0,0,'Rot'],[0,255,0,'Gruen'],[0,0,255,'Blau'],[255,215,0,'Gold'],[255,0,255,'Pink'],[0,255,255,'Cyan'],[255,255,255,'Weiss']].map(([r,g,b,l]) => (
                            <button key={l} title={l} onClick={() => updateEffect('col', [[r,g,b]])}
                                style={{width: 28, height: 28, borderRadius: 6, border: '2px solid rgba(255,255,255,0.1)',
                                    background: `rgb(${r},${g},${b})`, cursor: 'pointer', padding: 0}} />
                        ))}
                    </div>
                )}
            </div>

            {/* Brightness */}
            <div style={{padding: '10px 0', borderBottom: '1px solid var(--border)'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: changeBri ? 8 : 0}}>
                    <div className={`toggle ${changeBri ? 'active' : ''}`} onClick={() => setChangeBri(!changeBri)} />
                    <span style={{fontSize: 13}}>Helligkeit: {effect.bri ?? 200}</span>
                </div>
                {changeBri && (
                    <input type="range" min="0" max="255" value={effect.bri ?? 200}
                        onChange={e => updateEffect('bri', parseInt(e.target.value))} />
                )}
            </div>

            {/* Speed */}
            <div style={{padding: '10px 0', borderBottom: '1px solid var(--border)'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: changeSx ? 8 : 0}}>
                    <div className={`toggle ${changeSx ? 'active' : ''}`} onClick={() => setChangeSx(!changeSx)} />
                    <span style={{fontSize: 13}}>Speed: {effect.sx ?? 128}</span>
                </div>
                {changeSx && (
                    <input type="range" min="0" max="255" value={effect.sx ?? 128}
                        onChange={e => updateEffect('sx', parseInt(e.target.value))} />
                )}
            </div>

            {/* Duration */}
            <div style={{padding: '10px 0', borderBottom: '1px solid var(--border)'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: changeDuration ? 8 : 0}}>
                    <div className={`toggle ${changeDuration ? 'active' : ''}`} onClick={() => setChangeDuration(!changeDuration)} />
                    <span style={{fontSize: 13}}>Dauer: {changes.duration ?? 2}s</span>
                </div>
                {changeDuration && (
                    <input type="number" min="0" step="0.5" value={changes.duration ?? 2}
                        onChange={e => setChanges(prev => ({...prev, duration: parseFloat(e.target.value)}))} />
                )}
            </div>

            <div style={{display: 'flex', gap: 10, marginTop: 16}}>
                <button className="btn btn-primary" onClick={() => {
                    const finalChanges = {};
                    if (changeFx || changeColor || changeBri || changeSx) {
                        finalChanges.effect = {};
                        if (changeFx) finalChanges.effect.fx = effect.fx ?? 0;
                        if (changeColor) finalChanges.effect.col = effect.col || [[255,255,255]];
                        if (changeBri) finalChanges.effect.bri = effect.bri ?? 200;
                        if (changeSx) finalChanges.effect.sx = effect.sx ?? 128;
                    }
                    if (changeDuration) finalChanges.duration = changes.duration ?? 2;
                    if (Object.keys(finalChanges).length > 0) onApply(finalChanges);
                }}>Anwenden</button>
                <button className="btn" onClick={onCancel}>Abbrechen</button>
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ WLED Effect Names ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const WLED_EFFECTS = {
    0: 'Solid', 1: 'Blink', 2: 'Breathe', 3: 'Color Wipe', 4: 'Color Wipe Random',
    5: 'Random Colors', 6: 'Color Sweep', 7: 'Dynamic', 8: 'Colorloop',
    9: 'Rainbow', 10: 'Scan', 11: 'Dual Scan', 12: 'Fade', 13: 'Theater Chase',
    14: 'Theater Chase Rainbow', 15: 'Running', 16: 'Saw', 17: 'Twinkle',
    18: 'Dissolve', 19: 'Dissolve Random', 20: 'Sparkle', 21: 'Sparkle Dark',
    22: 'Sparkle+', 23: 'Strobe', 24: 'Strobe Rainbow', 25: 'Strobe Mega',
    26: 'Blink Rainbow', 27: 'Android', 28: 'Chase', 29: 'Chase Random',
    30: 'Chase Rainbow', 31: 'Chase Flash', 32: 'Chase Flash Random',
    33: 'Rainbow Runner', 34: 'Colorful', 35: 'Traffic Light', 36: 'Sweep Random',
    37: 'Running 2', 38: 'Aurora', 39: 'Stream', 40: 'Scanner', 41: 'Lighthouse',
    42: 'Fireworks', 43: 'Rain', 44: 'Fireworks Starburst', 45: 'Fireworks 1D',
    46: 'Bouncing Balls', 47: 'Sinelon', 48: 'Sinelon Dual', 49: 'Sinelon Rainbow',
    50: 'Popcorn', 51: 'Drip', 52: 'Plasma', 53: 'Percent', 54: 'Ripple',
    55: 'Ripple Rainbow', 56: 'Heartbeat', 57: 'Pacifica', 58: 'Candle',
    59: 'Candle Multi', 60: 'Solid Pattern', 61: 'Solid Pattern Tri',
    62: 'Spots', 63: 'Spots Fade', 64: 'Glitter', 65: 'Candle', 66: 'Fire Flicker',
    67: 'Gradient', 68: 'Loading', 69: 'Police', 70: 'Fairy', 71: 'Two Dots',
    72: 'Fairy Twinkle', 73: 'Running Dual', 74: 'Halloween', 75: 'Tri Chase',
    76: 'Tri Wipe', 77: 'Tri Fade', 78: 'Lightning', 79: 'ICU', 80: 'Multi Comet',
    81: 'Scanner Dual', 82: 'Stream 2', 83: 'Oscillate', 84: 'Pride 2015',
    85: 'Juggle', 86: 'Palette', 87: 'Fire 2012', 88: 'Colorwaves',
    89: 'BPM', 90: 'Fill Noise', 91: 'Noise 1', 92: 'Noise 2', 93: 'Noise 3',
    94: 'Noise 4', 95: 'Colortwinkles', 96: 'Lake', 97: 'Meteor', 98: 'Meteor Smooth',
    99: 'Railway', 100: 'Ripple', 101: 'Twinklefox', 102: 'Twinklecat',
};


// ‚îÄ‚îÄ‚îÄ LED Ring Preview Component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function LEDRingPreview({ effect, ledCount = 60, size = 280 }) {
    const canvasRef = React.useRef(null);
    const animRef = React.useRef(null);
    const startTimeRef = React.useRef(Date.now());

    const fx = effect?.fx ?? 0;
    const speed = (effect?.sx ?? 128) / 255;
    const intensity = (effect?.ix ?? 128) / 255;
    const bri = (effect?.bri ?? 200) / 255;
    const col1 = effect?.col?.[0] || [255, 255, 255];
    const col2 = effect?.col?.[1] || [0, 0, 0];
    const col3 = effect?.col?.[2] || [128, 128, 128];

    React.useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        canvas.width = size * dpr;
        canvas.height = size * dpr;
        ctx.scale(dpr, dpr);

        const cx = size / 2;
        const cy = size / 2;
        const radius = size / 2 - 18;
        const ledSize = Math.max(3, Math.min(8, (2 * Math.PI * radius) / ledCount * 0.6));

        function lerp(a, b, t) {
            return a.map((v, i) => Math.round(v + (b[i] - v) * Math.max(0, Math.min(1, t))));
        }

        function hsl2rgb(h, s, l) {
            h = ((h % 360) + 360) % 360;
            s /= 100; l /= 100;
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = l - c / 2;
            let r, g, b;
            if (h < 60) { r = c; g = x; b = 0; }
            else if (h < 120) { r = x; g = c; b = 0; }
            else if (h < 180) { r = 0; g = c; b = x; }
            else if (h < 240) { r = 0; g = x; b = c; }
            else if (h < 300) { r = x; g = 0; b = c; }
            else { r = c; g = 0; b = x; }
            return [Math.round((r + m) * 255), Math.round((g + m) * 255), Math.round((b + m) * 255)];
        }

        function computeLEDs(t) {
            const leds = new Array(ledCount);
            const spd = 0.3 + speed * 4;
            const N = ledCount;

            // Helper: pseudo-random per index+seed
            function prng(i, seed) { let x = Math.sin(i * 127.1 + seed * 311.7) * 43758.5453; return x - Math.floor(x); }
            // Helper: triangle wave 0-1
            function tri(x) { return Math.abs(((x % 1) + 1) % 1 * 2 - 1); }

            switch (fx) {
                case 0: // Solid
                    for (let i = 0; i < N; i++) leds[i] = [...col1];
                    break;

                case 1: // Blink
                case 26: { // Blink Rainbow
                    const on = Math.sin(t * spd * 3) > 0;
                    for (let i = 0; i < N; i++) {
                        if (on) { leds[i] = fx === 26 ? hsl2rgb((t * 60) % 360, 100, 50) : [...col1]; }
                        else { leds[i] = [0, 0, 0]; }
                    }
                    break;
                }

                case 2: { // Breathe
                    const b = (Math.sin(t * spd * 1.5) + 1) / 2;
                    for (let i = 0; i < N; i++) leds[i] = col1.map(c => Math.round(c * b));
                    break;
                }

                case 3: // Color Wipe
                case 4: // Color Wipe Random
                case 6: // Color Sweep
                case 36: { // Sweep Random
                    const wipePos = ((t * spd * 0.5) % 2);
                    const forward = wipePos < 1;
                    const p = forward ? wipePos : wipePos - 1;
                    const c1 = (fx === 4 || fx === 36) ? hsl2rgb((Math.floor(t * spd) * 67) % 360, 90, 50) : col1;
                    const c2 = (fx === 4 || fx === 36) ? hsl2rgb((Math.floor(t * spd) * 67 + 120) % 360, 90, 50) : col2;
                    for (let i = 0; i < N; i++) {
                        const frac = i / N;
                        if (fx === 6 || fx === 36) {
                            leds[i] = Math.abs(frac - p) < 0.03 ? [...c1] : lerp(c2, c1, Math.max(0, 1 - Math.abs(frac - p) * 5));
                        } else {
                            leds[i] = frac < p ? (forward ? [...c1] : [...c2]) : (forward ? [...c2] : [...c1]);
                        }
                    }
                    break;
                }

                case 5: // Random Colors
                case 7: { // Dynamic
                    const seed = Math.floor(t * spd * 0.5);
                    for (let i = 0; i < N; i++) leds[i] = hsl2rgb((i * 127 + seed * 311) % 360, 90, 50);
                    break;
                }

                case 8: // Colorloop
                case 9: { // Rainbow
                    const off = t * spd * 60;
                    for (let i = 0; i < N; i++) leds[i] = hsl2rgb((i / N * 360 + off) % 360, 100, 50);
                    break;
                }

                case 10: { // Scan
                    const sp = (Math.sin(t * spd * 2) + 1) / 2 * N;
                    for (let i = 0; i < N; i++) {
                        const d = Math.abs(i - sp);
                        leds[i] = col1.map(c => Math.round(c * Math.max(0, 1 - d / (2 + intensity * 5))));
                    }
                    break;
                }

                case 11: { // Dual Scan
                    const sp1 = (Math.sin(t * spd * 2) + 1) / 2 * N;
                    const sp2 = N - sp1;
                    for (let i = 0; i < N; i++) {
                        const d = Math.min(Math.abs(i - sp1), Math.abs(i - sp2));
                        leds[i] = col1.map(c => Math.round(c * Math.max(0, 1 - d / (2 + intensity * 5))));
                    }
                    break;
                }

                case 12: { // Fade
                    const f = (Math.sin(t * spd * 0.8) + 1) / 2;
                    const fc = lerp(col1, col2, f);
                    for (let i = 0; i < N; i++) leds[i] = [...fc];
                    break;
                }

                case 13: // Theater Chase
                case 75: { // Tri Chase
                    const cOff = Math.floor(t * spd * 8) % 3;
                    for (let i = 0; i < N; i++) {
                        const m = (i + cOff) % 3;
                        leds[i] = m === 0 ? [...col1] : m === 1 && fx === 75 ? [...col2] : [0, 0, 0];
                    }
                    break;
                }

                case 14: { // Theater Chase Rainbow
                    const cOff2 = Math.floor(t * spd * 8) % 3;
                    const hOff = t * spd * 40;
                    for (let i = 0; i < N; i++) {
                        leds[i] = (i + cOff2) % 3 === 0 ? hsl2rgb((i / N * 360 + hOff) % 360, 100, 50) : [0, 0, 0];
                    }
                    break;
                }

                case 15: // Running
                case 33: // Rainbow Runner
                case 37: // Running 2
                case 73: { // Running Dual
                    const rOff = t * spd * 40;
                    for (let i = 0; i < N; i++) {
                        const wave = (Math.sin((i / N * Math.PI * 4 * (1 + intensity * 3)) + rOff * 0.15) + 1) / 2;
                        if (fx === 33) leds[i] = hsl2rgb((i / N * 360 + rOff) % 360, 100, wave * 50);
                        else if (fx === 73) leds[i] = wave > 0.5 ? lerp(col2, col1, (wave - 0.5) * 2) : lerp(col1, col2, wave * 2);
                        else leds[i] = lerp(col2, col1, wave);
                    }
                    break;
                }

                case 16: { // Saw
                    const sawOff = (t * spd * 0.5) % 1;
                    for (let i = 0; i < N; i++) {
                        const v = ((i / N + sawOff) % 1);
                        leds[i] = col1.map(c => Math.round(c * v));
                    }
                    break;
                }

                case 17: // Twinkle
                case 72: // Fairy Twinkle
                case 95: { // Colortwinkles
                    for (let i = 0; i < N; i++) {
                        const tw = Math.sin(t * spd * 3 + i * 47.3) * 0.5 + 0.5;
                        const on = tw > (1 - intensity * 0.8);
                        if (fx === 95) leds[i] = on ? hsl2rgb((i * 37 + t * 20) % 360, 90, 50) : [2, 2, 2];
                        else if (fx === 72) leds[i] = on ? col1.map(c => Math.round(c * tw)) : [0, 0, 0];
                        else leds[i] = on ? [...col1] : col1.map(c => Math.round(c * 0.05));
                    }
                    break;
                }

                case 18: // Dissolve
                case 19: { // Dissolve Random
                    const phase = (t * spd * 0.3) % 2;
                    for (let i = 0; i < N; i++) {
                        const thresh = prng(i, 42);
                        const p = phase < 1 ? phase : 2 - phase;
                        const c = fx === 19 ? hsl2rgb(prng(i, 7) * 360, 90, 50) : col1;
                        leds[i] = thresh < p ? [...c] : [0, 0, 0];
                    }
                    break;
                }

                case 20: // Sparkle
                case 21: // Sparkle Dark
                case 22: { // Sparkle+
                    const bg = fx === 21 ? [...col1] : col1.map(c => Math.round(c * 0.15));
                    for (let i = 0; i < N; i++) leds[i] = [...bg];
                    const ns = Math.floor(1 + intensity * 8);
                    for (let s = 0; s < ns; s++) {
                        const si = Math.floor(((Math.sin(t * 73.1 * spd + s * 17.7) + 1) / 2) * N) % N;
                        leds[si] = fx === 21 ? [0, 0, 0] : [...col1];
                    }
                    break;
                }

                case 23: // Strobe
                case 24: // Strobe Rainbow
                case 25: { // Strobe Mega
                    const duty = fx === 25 ? 0.3 : 0.15;
                    const on = (t * spd * (fx === 25 ? 5 : 10)) % 1 < duty;
                    for (let i = 0; i < N; i++) {
                        if (on) leds[i] = fx === 24 ? hsl2rgb((t * 120) % 360, 100, 50) : [...col1];
                        else leds[i] = [0, 0, 0];
                    }
                    break;
                }

                case 27: { // Android
                    const headPos = (t * spd * 20) % N;
                    const tailLen = Math.floor(N * 0.3 * (0.5 + intensity * 0.5));
                    for (let i = 0; i < N; i++) {
                        const dist = ((headPos - i) % N + N) % N;
                        leds[i] = dist < tailLen ? lerp(col2, col1, 1 - dist / tailLen) : [...col2];
                    }
                    break;
                }

                case 28: // Chase
                case 29: // Chase Random
                case 30: // Chase Rainbow
                case 31: // Chase Flash
                case 32: { // Chase Flash Random
                    const chLen = Math.max(2, Math.floor(N * 0.15));
                    const chPos = ((t * spd * 30) % N);
                    for (let i = 0; i < N; i++) {
                        const dist = ((i - chPos) % N + N) % N;
                        if (dist < chLen) {
                            if (fx === 30) leds[i] = hsl2rgb((i / N * 360 + t * 60) % 360, 100, 50);
                            else if (fx === 29 || fx === 32) leds[i] = hsl2rgb(prng(Math.floor(t * spd), 3) * 360, 90, 50);
                            else if ((fx === 31 || fx === 32) && (t * spd * 15) % 1 < 0.2) leds[i] = [255, 255, 255];
                            else leds[i] = [...col1];
                        } else { leds[i] = [...col2]; }
                    }
                    break;
                }

                case 34: { // Colorful
                    const cols = [[255, 0, 0], [0, 255, 0], [0, 0, 255], [255, 255, 0]];
                    const shift = Math.floor(t * spd * 2);
                    for (let i = 0; i < N; i++) leds[i] = [...cols[(i + shift) % 4]];
                    break;
                }

                case 35: { // Traffic Light
                    const phase3 = Math.floor(t * spd * 1.5) % 3;
                    const tc = phase3 === 0 ? [255, 0, 0] : phase3 === 1 ? [255, 180, 0] : [0, 255, 0];
                    for (let i = 0; i < N; i++) leds[i] = [...tc];
                    break;
                }

                case 38: { // Aurora
                    for (let i = 0; i < N; i++) {
                        const v1 = Math.sin(i * 0.15 + t * spd * 0.8) * 0.5 + 0.5;
                        const v2 = Math.sin(i * 0.08 - t * spd * 0.5) * 0.5 + 0.5;
                        const hue = (120 + v1 * 80 + v2 * 40 + t * 10) % 360;
                        leds[i] = hsl2rgb(hue, 80, 20 + v1 * v2 * 40);
                    }
                    break;
                }

                case 39: // Stream
                case 82: { // Stream 2
                    const sOff = t * spd * 30;
                    for (let i = 0; i < N; i++) {
                        const p = ((i + sOff) / N * 3) % 1;
                        if (fx === 82) leds[i] = hsl2rgb((p * 360 + t * 30) % 360, 90, 30 + p * 40);
                        else leds[i] = lerp(col2, col1, p);
                    }
                    break;
                }

                case 40: // Scanner (Knight Rider)
                case 41: { // Lighthouse
                    const sp = fx === 41 ? ((t * spd * 0.8) % 1) * N : (Math.sin(t * spd * 2.5) + 1) / 2 * N;
                    const w = fx === 41 ? N * 0.08 : 3 + intensity * 6;
                    for (let i = 0; i < N; i++) {
                        const d = fx === 41 ? Math.min(Math.abs(i - sp), N - Math.abs(i - sp)) : Math.abs(i - sp);
                        const b = Math.max(0, 1 - d / w);
                        leds[i] = col1.map(c => Math.round(c * b * b));
                    }
                    break;
                }

                case 42: // Fireworks
                case 44: // Fireworks Starburst
                case 45: { // Fireworks 1D
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const nB = 3 + Math.floor(intensity * 5);
                    for (let b = 0; b < nB; b++) {
                        const bt = (t * spd * 0.8 + b * 2.7) % 3;
                        if (bt < 1.5) {
                            const ctr = Math.floor(prng(b, 37) * N);
                            const rad = bt * (3 + intensity * 8);
                            const fade = Math.max(0, 1 - bt / 1.5);
                            const bc = b % 3 === 0 ? col1 : b % 3 === 1 ? col2 : col3;
                            for (let i = 0; i < N; i++) {
                                const d = Math.min(Math.abs(i - ctr), N - Math.abs(i - ctr));
                                if (d < rad) {
                                    const br = fade * Math.max(0, 1 - d / rad);
                                    leds[i] = leds[i].map((v, ch) => Math.min(255, v + Math.round(bc[ch] * br)));
                                }
                            }
                        }
                    }
                    break;
                }

                case 43: { // Rain
                    for (let i = 0; i < N; i++) leds[i] = col2.map(c => Math.round(c * 0.1));
                    const nDrops = 5 + Math.floor(intensity * 10);
                    for (let d = 0; d < nDrops; d++) {
                        const pos = ((prng(d, 5) * N + t * spd * 20 * (0.5 + prng(d, 8) * 0.5)) % N);
                        const idx = Math.floor(pos) % N;
                        const fade = Math.max(0, 1 - (pos % 1));
                        leds[idx] = col1.map(c => Math.min(255, Math.round(c * fade)));
                    }
                    break;
                }

                case 46: { // Bouncing Balls
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const nBalls = 2 + Math.floor(intensity * 4);
                    for (let b = 0; b < nBalls; b++) {
                        const period = 1.5 + b * 0.3;
                        const phase = (t * spd / period) % 1;
                        const h = Math.abs(Math.sin(phase * Math.PI));
                        const pos = Math.floor(h * (N - 1));
                        const bc = b === 0 ? col1 : b === 1 ? col2 : col3;
                        for (let j = -1; j <= 1; j++) {
                            const idx = (pos + j + N) % N;
                            leds[idx] = leds[idx].map((v, ch) => Math.min(255, v + bc[ch]));
                        }
                    }
                    break;
                }

                case 47: // Sinelon
                case 48: // Sinelon Dual
                case 49: { // Sinelon Rainbow
                    const sPos = (Math.sin(t * spd * 1.8) + 1) / 2 * N;
                    const sPos2 = fx === 48 ? N - sPos : -1;
                    for (let i = 0; i < N; i++) {
                        const d1 = ((sPos - i) % N + N) % N;
                        const d2 = fx === 48 ? ((sPos2 - i) % N + N) % N : N;
                        const trail = Math.max(
                            Math.max(0, 1 - d1 / (5 + intensity * 15)),
                            Math.max(0, 1 - d2 / (5 + intensity * 15))
                        );
                        if (fx === 49) leds[i] = hsl2rgb((i / N * 360 + t * 30) % 360, 100, trail * 50);
                        else leds[i] = col1.map(c => Math.round(c * trail));
                    }
                    break;
                }

                case 50: { // Popcorn
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const nPop = 4 + Math.floor(intensity * 8);
                    for (let p = 0; p < nPop; p++) {
                        const pt = (t * spd + p * 1.7) % 2;
                        if (pt < 1.2) {
                            const h = Math.sin(pt / 1.2 * Math.PI) * (0.3 + prng(p, 3) * 0.7);
                            const pos = Math.floor(prng(p, 5) * N * 0.8 + N * 0.1 + h * N * 0.3) % N;
                            leds[pos] = p % 2 === 0 ? [...col1] : [...col2];
                        }
                    }
                    break;
                }

                case 51: { // Drip
                    for (let i = 0; i < N; i++) leds[i] = [...col2];
                    const dripPhase = (t * spd * 0.5) % 2;
                    const dripPos = dripPhase < 1 ? Math.floor(dripPhase * N) : Math.floor(N - 1);
                    if (dripPhase >= 1) {
                        const splash = (dripPhase - 1) * 3;
                        for (let i = 0; i < N; i++) {
                            const d = Math.abs(i - (N - 1));
                            if (d < splash * 5) leds[i] = col1.map(c => Math.round(c * Math.max(0, 1 - d / (splash * 5))));
                        }
                    } else {
                        for (let j = -1; j <= 1; j++) { const idx = (dripPos + j + N) % N; leds[idx] = [...col1]; }
                    }
                    break;
                }

                case 52: { // Plasma
                    for (let i = 0; i < N; i++) {
                        const v1 = Math.sin(i * 0.3 + t * spd * 2);
                        const v2 = Math.sin(i * 0.15 - t * spd * 1.5);
                        const v3 = Math.sin((i * 0.1 + t * spd) * 0.5);
                        leds[i] = lerp(col1, col2, (v1 + v2 + v3 + 3) / 6);
                    }
                    break;
                }

                case 53: { // Percent
                    const pct = (intensity * 100);
                    const fill = Math.floor(N * pct / 100);
                    for (let i = 0; i < N; i++) leds[i] = i < fill ? [...col1] : [...col2];
                    break;
                }

                case 54: // Ripple
                case 55: // Ripple Rainbow
                case 100: { // Ripple (alt)
                    for (let i = 0; i < N; i++) leds[i] = col2.map(c => Math.round(c * 0.1));
                    const nRip = 3 + Math.floor(intensity * 4);
                    for (let r = 0; r < nRip; r++) {
                        const rt = (t * spd * 0.6 + r * 1.3) % 3;
                        const center = Math.floor(prng(r, 9) * N);
                        const radius = rt * (5 + intensity * 15);
                        const fade = Math.max(0, 1 - rt / 3);
                        for (let i = 0; i < N; i++) {
                            const d = Math.min(Math.abs(i - center), N - Math.abs(i - center));
                            if (Math.abs(d - radius) < 2) {
                                const br = fade * Math.max(0, 1 - Math.abs(d - radius) / 2);
                                const rc = (fx === 55) ? hsl2rgb((r * 60 + t * 30) % 360, 100, 50) : col1;
                                leds[i] = leds[i].map((v, ch) => Math.min(255, v + Math.round(rc[ch] * br)));
                            }
                        }
                    }
                    break;
                }

                case 56: { // Heartbeat
                    const hp = (t * spd * 2) % 2;
                    let pulse = 0;
                    if (hp < 0.15) pulse = hp / 0.15;
                    else if (hp < 0.3) pulse = 1 - (hp - 0.15) / 0.15;
                    else if (hp < 0.45) pulse = (hp - 0.3) / 0.15 * 0.7;
                    else if (hp < 0.7) pulse = 0.7 * (1 - (hp - 0.45) / 0.25);
                    for (let i = 0; i < N; i++) leds[i] = col1.map(c => Math.round(c * pulse));
                    break;
                }

                case 57: { // Pacifica
                    for (let i = 0; i < N; i++) {
                        const v1 = Math.sin(i * 0.12 + t * spd * 0.6) * 0.5 + 0.5;
                        const v2 = Math.sin(i * 0.08 - t * spd * 0.4) * 0.5 + 0.5;
                        const v3 = Math.sin(i * 0.2 + t * spd * 1.1) * 0.3 + 0.5;
                        const bright = (v1 + v2 + v3) / 3;
                        leds[i] = hsl2rgb(190 + v1 * 30, 80, bright * 40);
                    }
                    break;
                }

                case 58: // Candle
                case 59: // Candle Multi
                case 65: { // Candle (alt)
                    for (let i = 0; i < N; i++) {
                        const flicker = 0.5 + prng(i, Math.floor(t * spd * 10)) * 0.5;
                        if (fx === 59) {
                            const hue = (i / N * 40 + 10);
                            leds[i] = hsl2rgb(hue, 100, flicker * 50);
                        } else {
                            leds[i] = [Math.round(255 * flicker), Math.round(120 * flicker), Math.round(20 * flicker * 0.3)];
                        }
                    }
                    break;
                }

                case 60: { // Solid Pattern
                    for (let i = 0; i < N; i++) leds[i] = i % 2 === 0 ? [...col1] : [...col2];
                    break;
                }

                case 61: { // Solid Pattern Tri
                    for (let i = 0; i < N; i++) {
                        const m = i % 3;
                        leds[i] = m === 0 ? [...col1] : m === 1 ? [...col2] : [...col3];
                    }
                    break;
                }

                case 62: { // Spots
                    const spotW = Math.max(2, Math.floor(N / (3 + intensity * 8)));
                    for (let i = 0; i < N; i++) {
                        leds[i] = (i % (spotW * 2)) < spotW ? [...col1] : [...col2];
                    }
                    break;
                }

                case 63: { // Spots Fade
                    const spotW2 = Math.max(2, Math.floor(N / (3 + intensity * 8)));
                    for (let i = 0; i < N; i++) {
                        const pos = (i % (spotW2 * 2)) / (spotW2 * 2);
                        const v = (Math.sin(pos * Math.PI * 2) + 1) / 2;
                        leds[i] = lerp(col2, col1, v);
                    }
                    break;
                }

                case 64: { // Glitter
                    for (let i = 0; i < N; i++) leds[i] = [...col2];
                    const nGlit = Math.floor(2 + intensity * N * 0.2);
                    for (let g = 0; g < nGlit; g++) {
                        const gi = Math.floor(prng(g, Math.floor(t * spd * 5)) * N);
                        leds[gi] = [...col1];
                    }
                    break;
                }

                case 66: { // Fire Flicker
                    for (let i = 0; i < N; i++) {
                        const fl = 0.4 + prng(i, Math.floor(t * spd * 15)) * 0.6;
                        leds[i] = [Math.round(255 * fl), Math.round(96 * fl * fl), Math.round(12 * fl * fl * fl)];
                    }
                    break;
                }

                case 67: { // Gradient
                    for (let i = 0; i < N; i++) leds[i] = lerp(col1, col2, i / N);
                    break;
                }

                case 68: { // Loading
                    const loadPos = (t * spd * 0.4) % 1;
                    const loadLen = 0.15 + intensity * 0.3;
                    for (let i = 0; i < N; i++) {
                        const p = i / N;
                        const d = Math.min(Math.abs(p - loadPos), 1 - Math.abs(p - loadPos));
                        leds[i] = d < loadLen ? col1.map(c => Math.round(c * Math.max(0, 1 - d / loadLen))) : [...col2];
                    }
                    break;
                }

                case 69: { // Police
                    const polP = (t * spd * 4) % 2;
                    for (let i = 0; i < N; i++) {
                        const half = i < N / 2;
                        leds[i] = polP < 1 ? (half ? [255, 0, 0] : [0, 0, 255]) : (half ? [0, 0, 255] : [255, 0, 0]);
                    }
                    break;
                }

                case 70: { // Fairy
                    for (let i = 0; i < N; i++) {
                        const v = Math.sin(i * 0.5 + t * spd * 2) * 0.5 + 0.5;
                        const twk = prng(i, Math.floor(t * spd * 8)) > 0.7 ? 1 : v * 0.3;
                        leds[i] = col1.map(c => Math.round(c * twk));
                    }
                    break;
                }

                case 71: { // Two Dots
                    const dot1 = Math.floor(((t * spd * 0.5) % 1) * N);
                    const dot2 = (dot1 + Math.floor(N / 2)) % N;
                    for (let i = 0; i < N; i++) {
                        const d1 = Math.min(Math.abs(i - dot1), N - Math.abs(i - dot1));
                        const d2 = Math.min(Math.abs(i - dot2), N - Math.abs(i - dot2));
                        if (d1 < 3) leds[i] = [...col1];
                        else if (d2 < 3) leds[i] = [...col2];
                        else leds[i] = [0, 0, 0];
                    }
                    break;
                }

                case 74: { // Halloween
                    const hOff2 = t * spd * 20;
                    for (let i = 0; i < N; i++) {
                        const p = ((i + hOff2) / N * 2) % 1;
                        leds[i] = p < 0.5 ? [255, Math.round(60 * (p * 2)), 0] : [128, 0, Math.round(128 * ((p - 0.5) * 2))];
                    }
                    break;
                }

                case 76: { // Tri Wipe
                    const twP = (t * spd * 0.3) % 3;
                    const twFrac = twP % 1;
                    const twStage = Math.floor(twP);
                    const cols = [col1, col2, col3];
                    for (let i = 0; i < N; i++) {
                        leds[i] = i / N < twFrac ? [...cols[twStage]] : [...cols[(twStage + 2) % 3]];
                    }
                    break;
                }

                case 77: { // Tri Fade
                    const tfP = (t * spd * 0.5) % 3;
                    const tfStage = Math.floor(tfP);
                    const tfFrac = tfP - tfStage;
                    const tfCols = [col1, col2, col3];
                    const tfC = lerp(tfCols[tfStage], tfCols[(tfStage + 1) % 3], tfFrac);
                    for (let i = 0; i < N; i++) leds[i] = [...tfC];
                    break;
                }

                case 78: { // Lightning
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const ltPhase = (t * spd * 2) % 3;
                    if (ltPhase < 0.1 || (ltPhase > 0.2 && ltPhase < 0.25)) {
                        const ltCenter = Math.floor(prng(0, Math.floor(t * spd)) * N);
                        const ltWidth = Math.floor(N * 0.3);
                        for (let i = 0; i < N; i++) {
                            const d = Math.min(Math.abs(i - ltCenter), N - Math.abs(i - ltCenter));
                            if (d < ltWidth) leds[i] = [255, 255, 255];
                        }
                    }
                    break;
                }

                case 79: { // ICU
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const eyeSpacing = Math.floor(N * 0.1);
                    const eyePos = Math.floor((Math.sin(t * spd * 1.5) + 1) / 2 * (N - eyeSpacing * 2)) + eyeSpacing;
                    leds[eyePos % N] = [...col1];
                    leds[(eyePos + eyeSpacing) % N] = [...col1];
                    break;
                }

                case 80: { // Multi Comet
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const nComets = 3;
                    for (let c = 0; c < nComets; c++) {
                        const cPos = ((t * spd * 25 * (0.7 + c * 0.3) + c * N / nComets) % N);
                        const cLen = 5 + intensity * 10;
                        const cc = c === 0 ? col1 : c === 1 ? col2 : col3;
                        for (let i = 0; i < N; i++) {
                            const d = ((cPos - i) % N + N) % N;
                            if (d < cLen) {
                                const br = 1 - d / cLen;
                                leds[i] = leds[i].map((v, ch) => Math.min(255, v + Math.round(cc[ch] * br * br)));
                            }
                        }
                    }
                    break;
                }

                case 81: { // Scanner Dual
                    const sdP1 = (Math.sin(t * spd * 2) + 1) / 2 * N;
                    const sdP2 = (Math.sin(t * spd * 2 + Math.PI) + 1) / 2 * N;
                    for (let i = 0; i < N; i++) {
                        const d1 = Math.abs(i - sdP1);
                        const d2 = Math.abs(i - sdP2);
                        const b1 = Math.max(0, 1 - d1 / (3 + intensity * 6));
                        const b2 = Math.max(0, 1 - d2 / (3 + intensity * 6));
                        leds[i] = [
                            Math.min(255, Math.round(col1[0] * b1 + col2[0] * b2)),
                            Math.min(255, Math.round(col1[1] * b1 + col2[1] * b2)),
                            Math.min(255, Math.round(col1[2] * b1 + col2[2] * b2)),
                        ];
                    }
                    break;
                }

                case 83: { // Oscillate
                    const osc1 = (Math.sin(t * spd * 2) + 1) / 2;
                    const osc2 = (Math.sin(t * spd * 3.1) + 1) / 2;
                    const osc3 = (Math.sin(t * spd * 1.7) + 1) / 2;
                    const third = N / 3;
                    for (let i = 0; i < N; i++) {
                        if (i < third) leds[i] = Math.abs(i / third - osc1) < 0.1 ? [...col1] : [0, 0, 0];
                        else if (i < third * 2) leds[i] = Math.abs((i - third) / third - osc2) < 0.1 ? [...col2] : [0, 0, 0];
                        else leds[i] = Math.abs((i - third * 2) / third - osc3) < 0.1 ? [...col3] : [0, 0, 0];
                    }
                    break;
                }

                case 84: { // Pride 2015
                    const pOff = t * spd * 50;
                    for (let i = 0; i < N; i++) {
                        const hue = (i / N * 360 + pOff + Math.sin(i * 0.2 + t) * 30) % 360;
                        leds[i] = hsl2rgb(hue, 100, 50);
                    }
                    break;
                }

                case 85: { // Juggle
                    for (let i = 0; i < N; i++) leds[i] = [0, 0, 0];
                    const nJug = 3 + Math.floor(intensity * 5);
                    for (let j = 0; j < nJug; j++) {
                        const jPos = Math.floor((Math.sin(t * spd * (1 + j * 0.7) + j * 2.3) + 1) / 2 * N);
                        const jCol = hsl2rgb((j * 50 + t * 20) % 360, 100, 50);
                        for (let d = -1; d <= 1; d++) leds[(jPos + d + N) % N] = [...jCol];
                    }
                    break;
                }

                case 86: { // Palette
                    const palOff = t * spd * 20;
                    for (let i = 0; i < N; i++) {
                        const p = ((i / N * 3 + palOff / N) % 1);
                        if (p < 0.33) leds[i] = lerp(col1, col2, p / 0.33);
                        else if (p < 0.66) leds[i] = lerp(col2, col3, (p - 0.33) / 0.33);
                        else leds[i] = lerp(col3, col1, (p - 0.66) / 0.34);
                    }
                    break;
                }

                case 87: { // Fire 2012
                    for (let i = 0; i < N; i++) {
                        const heat = Math.max(0, Math.sin(i * 0.4 + t * spd * 3) * 0.5 + 0.5 +
                            Math.sin(i * 0.9 - t * spd * 5) * 0.3 + prng(i, Math.floor(t * 10)) * intensity * 0.15);
                        const h = Math.min(1, heat);
                        if (h < 0.33) leds[i] = [Math.round(h * 3 * 255), 0, 0];
                        else if (h < 0.66) leds[i] = [255, Math.round((h - 0.33) * 3 * 200), 0];
                        else leds[i] = [255, 200, Math.round((h - 0.66) * 3 * 200)];
                    }
                    break;
                }

                case 88: { // Colorwaves
                    const cwOff = t * spd * 30;
                    for (let i = 0; i < N; i++) {
                        const v = Math.sin(i * 0.2 + cwOff * 0.05) * 0.5 + 0.5;
                        const hue = (i / N * 180 + t * spd * 20) % 360;
                        leds[i] = hsl2rgb(hue, 90, 15 + v * 40);
                    }
                    break;
                }

                case 89: { // BPM
                    const bpmOff = t * spd * 60;
                    for (let i = 0; i < N; i++) {
                        const beat = Math.sin(i * 0.5 + bpmOff * 0.1) * 0.5 + 0.5;
                        const hue = (i / N * 360 + bpmOff) % 360;
                        leds[i] = hsl2rgb(hue, 100, beat * 50);
                    }
                    break;
                }

                case 90: { // Fill Noise
                    for (let i = 0; i < N; i++) {
                        const n = prng(i, Math.floor(t * spd * 3));
                        leds[i] = lerp(col1, col2, n);
                    }
                    break;
                }

                case 91: // Noise 1
                case 92: // Noise 2
                case 93: // Noise 3
                case 94: { // Noise 4
                    const nScale = [0.3, 0.15, 0.5, 0.08][fx - 91];
                    const nSpeed = [1, 0.5, 2, 0.3][fx - 91];
                    for (let i = 0; i < N; i++) {
                        const v1 = Math.sin(i * nScale + t * spd * nSpeed) * 0.5 + 0.5;
                        const v2 = Math.sin(i * nScale * 2.1 - t * spd * nSpeed * 0.7) * 0.5 + 0.5;
                        const hue = (v1 * 360 + t * 10) % 360;
                        leds[i] = hsl2rgb(hue, 80, (v1 * v2) * 50 + 5);
                    }
                    break;
                }

                case 96: { // Lake
                    for (let i = 0; i < N; i++) {
                        const v1 = Math.sin(i * 0.2 + t * spd * 0.5) * 0.5 + 0.5;
                        const v2 = Math.sin(i * 0.1 - t * spd * 0.3) * 0.5 + 0.5;
                        leds[i] = hsl2rgb(200 + v1 * 40, 70, (v1 * v2) * 35 + 5);
                    }
                    break;
                }

                case 97: // Meteor
                case 98: { // Meteor Smooth
                    const mPos = (t * spd * 30) % (N + 20);
                    const mLen = 5 + intensity * 15;
                    for (let i = 0; i < N; i++) {
                        const d = mPos - i;
                        if (d >= 0 && d < mLen) {
                            const br = fx === 98 ? (1 - d / mLen) : Math.pow(1 - d / mLen, 2);
                            leds[i] = col1.map(c => Math.round(c * br));
                        } else { leds[i] = [0, 0, 0]; }
                    }
                    break;
                }

                case 99: { // Railway
                    const rwOff = Math.floor(t * spd * 2) % 2;
                    for (let i = 0; i < N; i++) {
                        leds[i] = ((Math.floor(i / Math.max(1, Math.floor(N / 8))) + rwOff) % 2 === 0) ? [...col1] : [...col2];
                    }
                    break;
                }

                case 101: // Twinklefox
                case 102: { // Twinklecat
                    for (let i = 0; i < N; i++) {
                        const base = fx === 102 ? 0.02 : 0.05;
                        const phase = Math.sin(t * spd * 1.5 + i * 7.3 + prng(i, 1) * 100);
                        const bright = phase > (0.3 - intensity * 0.5) ? (phase - 0.3 + intensity * 0.5) * 2 : base;
                        const hue = (prng(i, 2) * 60 + t * 5) % 360;
                        leds[i] = hsl2rgb(hue, 80, Math.min(50, bright * 50));
                    }
                    break;
                }

                default: { // Generic animated fallback for unmapped FX
                    const gOff = t * spd * 40;
                    for (let i = 0; i < N; i++) {
                        const wave = (Math.sin(i / N * Math.PI * 4 + gOff * 0.1) + 1) / 2;
                        leds[i] = lerp(col2, col1, wave);
                    }
                }
            }

            // Apply brightness
            return leds.map(led => led.map(c => Math.round(c * bri)));
        }

        function draw() {
            const t = (Date.now() - startTimeRef.current) / 1000;
            const leds = computeLEDs(t);

            ctx.clearRect(0, 0, size, size);

            // Draw subtle ring outline
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255,255,255,0.04)';
            ctx.lineWidth = ledSize * 2 + 4;
            ctx.stroke();

            // Draw effect name in center
            ctx.fillStyle = 'rgba(255,255,255,0.15)';
            ctx.font = '11px Space Grotesk, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(WLED_EFFECTS[fx] || `FX #${fx}`, cx, cy - 8);
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            ctx.font = '10px Space Grotesk, sans-serif';
            ctx.fillText(`${ledCount} LEDs`, cx, cy + 8);
            // Show if effect is approximated
            const simulatedFx = [0,1,2,3,5,7,8,9,10,12,13,14,15,17,20,22,23,28,30,37,40,42,44,45,47,49,52,56,67,69,84,86,87,95,97,98];
            if (!simulatedFx.includes(fx)) {
                ctx.fillStyle = 'rgba(255,200,50,0.25)';
                ctx.font = '9px Space Grotesk, sans-serif';
                ctx.fillText('~ Ann√§herung ~', cx, cy + 22);
            }

            // Draw LED dots
            for (let i = 0; i < ledCount; i++) {
                const angle = (i / ledCount) * Math.PI * 2 - Math.PI / 2;
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;
                const [r, g, b] = leds[i] || [0, 0, 0];
                const brightness = (r + g + b) / 3;

                // Glow
                if (brightness > 20) {
                    ctx.beginPath();
                    ctx.arc(x, y, ledSize + 3, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${r},${g},${b},${Math.min(0.35, brightness / 400)})`;
                    ctx.fill();
                }

                // LED dot
                ctx.beginPath();
                ctx.arc(x, y, ledSize, 0, Math.PI * 2);
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fill();

                // Highlight
                if (brightness > 50) {
                    ctx.beginPath();
                    ctx.arc(x - ledSize * 0.25, y - ledSize * 0.25, ledSize * 0.35, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255,255,255,${Math.min(0.3, brightness / 800)})`;
                    ctx.fill();
                }
            }

            animRef.current = requestAnimationFrame(draw);
        }

        draw();
        return () => { if (animRef.current) cancelAnimationFrame(animRef.current); };
    }, [fx, speed, intensity, bri, col1[0], col1[1], col1[2], col2[0], col2[1], col2[2], ledCount, size]);

    return (
        <canvas
            ref={canvasRef}
            style={{ width: size, height: size, display: 'block', margin: '0 auto' }}
        />
    );
}


// ‚îÄ‚îÄ‚îÄ Event Editor with Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function EventEditor({ event, devices, onChange }) {
    const update = (key, value) => onChange({...event, [key]: value});
    const updateEffect = (key, value) => {
        const eff = {...(event.effect || {}), [key]: value};
        // When user changes color, reset palette so col values are actually used by WLED
        if (key === 'col') eff.pal = 0;
        onChange({...event, effect: eff});
    };
    const [previewLedCount, setPreviewLedCount] = React.useState(60);

    const col1 = event.effect?.col?.[0] || [255, 255, 255];
    const col2 = event.effect?.col?.[1] || [0, 0, 0];
    const hex1 = '#' + col1.map(c => c.toString(16).padStart(2, '0')).join('');
    const hex2 = '#' + col2.map(c => c.toString(16).padStart(2, '0')).join('');
    const fxNum = event.effect?.fx ?? 0;
    const fxName = WLED_EFFECTS[fxNum] || `Effekt #${fxNum}`;

    const setColor = (idx, hexVal) => {
        const r = parseInt(hexVal.slice(1,3), 16);
        const g = parseInt(hexVal.slice(3,5), 16);
        const b = parseInt(hexVal.slice(5,7), 16);
        const cols = [...(event.effect?.col || [[255,255,255], [0,0,0]])];
        while (cols.length <= idx) cols.push([0, 0, 0]);
        cols[idx] = [r, g, b];
        updateEffect('col', cols);
    };

    return (
        <div>
            {/* Live Preview */}
            <div style={{
                background: 'rgba(0,0,0,0.4)', borderRadius: 16, padding: '16px 16px 12px',
                marginBottom: 20, border: '1px solid var(--border)',
            }}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                    <span style={{fontSize: 12, color: 'var(--text-dim)'}}>Live-Vorschau</span>
                    <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <span style={{fontSize: 11, color: 'var(--text-dim)'}}>LEDs:</span>
                        {[30, 60, 120, 144].map(n => (
                            <button key={n} onClick={() => setPreviewLedCount(n)}
                                style={{
                                    padding: '2px 8px', fontSize: 11, borderRadius: 4, border: 'none', cursor: 'pointer',
                                    background: previewLedCount === n ? 'var(--accent)' : 'rgba(255,255,255,0.08)',
                                    color: previewLedCount === n ? 'white' : 'var(--text-dim)',
                                }}>{n}</button>
                        ))}
                    </div>
                </div>
                <LEDRingPreview effect={event.effect} ledCount={previewLedCount} size={260} />
            </div>

            {/* Effect selector */}
            <div className="input-group" style={{marginBottom: 16}}>
                <label>Effekt: <strong>{fxName}</strong> (#{fxNum})</label>
                <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
                    <input type="range" min="0" max="102" value={fxNum} style={{flex: 1}}
                        onChange={e => updateEffect('fx', parseInt(e.target.value))} />
                    <input type="number" min="0" max="200" value={fxNum}
                        style={{width: 60, textAlign: 'center'}}
                        onChange={e => updateEffect('fx', parseInt(e.target.value) || 0)} />
                </div>
            </div>

            {/* Quick Effect Buttons */}
            <div style={{display: 'flex', gap: 6, marginBottom: 16, flexWrap: 'wrap'}}>
                {[
                    {fx: 0, label: 'Solid'},
                    {fx: 2, label: 'Breathe'},
                    {fx: 9, label: 'Rainbow'},
                    {fx: 28, label: 'Chase'},
                    {fx: 44, label: 'Fireworks'},
                    {fx: 40, label: 'Scanner'},
                    {fx: 69, label: 'Police'},
                    {fx: 52, label: 'Plasma'},
                    {fx: 87, label: 'Fire'},
                    {fx: 97, label: 'Meteor'},
                    {fx: 56, label: 'Heartbeat'},
                    {fx: 84, label: 'Pride'},
                ].map(({fx: f, label}) => (
                    <button key={f} onClick={() => updateEffect('fx', f)}
                        style={{
                            padding: '4px 10px', fontSize: 11, borderRadius: 6, border: 'none', cursor: 'pointer',
                            background: fxNum === f ? 'var(--accent)' : 'rgba(255,255,255,0.06)',
                            color: fxNum === f ? 'white' : 'var(--text-secondary)',
                        }}>{label}</button>
                ))}
            </div>

            {/* Colors */}
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16}}>
                <div className="input-group">
                    <label style={{fontSize: 12}}>Farbe 1 (Haupt)</label>
                    <div style={{display: 'flex', gap: 6, alignItems: 'center'}}>
                        <input type="color" value={hex1} onChange={e => setColor(0, e.target.value)}
                            style={{width: 44, height: 32}} />
                        <span style={{fontSize: 11, color: 'var(--text-dim)', fontFamily: 'monospace'}}>{hex1}</span>
                    </div>
                </div>
                <div className="input-group">
                    <label style={{fontSize: 12}}>Farbe 2 (Sekund.)</label>
                    <div style={{display: 'flex', gap: 6, alignItems: 'center'}}>
                        <input type="color" value={hex2} onChange={e => setColor(1, e.target.value)}
                            style={{width: 44, height: 32}} />
                        <span style={{fontSize: 11, color: 'var(--text-dim)', fontFamily: 'monospace'}}>{hex2}</span>
                    </div>
                </div>
                <div className="input-group">
                    <label style={{fontSize: 12}}>Dauer</label>
                    <div style={{display: 'flex', gap: 6, alignItems: 'center'}}>
                        <input type="number" min="0" step="0.5" value={event.duration || 0}
                            style={{width: 70}}
                            onChange={e => update('duration', parseFloat(e.target.value))} />
                        <span style={{fontSize: 11, color: 'var(--text-dim)'}}>{event.duration > 0 ? 'Sek.' : 'dauerhaft'}</span>
                    </div>
                </div>
            </div>

            {/* Quick color presets */}
            <div style={{display: 'flex', gap: 4, marginBottom: 16, flexWrap: 'wrap'}}>
                <span style={{fontSize: 11, color: 'var(--text-dim)', marginRight: 4, lineHeight: '24px'}}>Schnellfarben:</span>
                {[
                    {c: [255,0,0], l: 'Rot'},
                    {c: [0,255,0], l: 'Gruen'},
                    {c: [0,0,255], l: 'Blau'},
                    {c: [255,215,0], l: 'Gold'},
                    {c: [255,0,255], l: 'Pink'},
                    {c: [0,255,255], l: 'Cyan'},
                    {c: [255,100,0], l: 'Orange'},
                    {c: [128,0,255], l: 'Lila'},
                    {c: [255,255,255], l: 'Weiss'},
                ].map(({c, l}) => (
                    <button key={l} title={l} onClick={() => {
                        const cols = [...(event.effect?.col || [[255,255,255]])];
                        cols[0] = c;
                        updateEffect('col', cols);
                    }} style={{
                        width: 24, height: 24, borderRadius: 6, border: '2px solid rgba(255,255,255,0.1)',
                        background: `rgb(${c.join(',')})`, cursor: 'pointer', padding: 0,
                    }} />
                ))}
            </div>

            {/* Sliders */}
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16}}>
                <div className="input-group">
                    <label style={{fontSize: 12}}>Helligkeit: {event.effect?.bri ?? 200}</label>
                    <input type="range" min="0" max="255" value={event.effect?.bri ?? 200}
                        onChange={e => updateEffect('bri', parseInt(e.target.value))} />
                </div>
                <div className="input-group">
                    <label style={{fontSize: 12}}>Speed: {event.effect?.sx ?? 128}</label>
                    <input type="range" min="0" max="255" value={event.effect?.sx ?? 128}
                        onChange={e => updateEffect('sx', parseInt(e.target.value))} />
                </div>
                <div className="input-group">
                    <label style={{fontSize: 12}}>Intensitaet: {event.effect?.ix ?? 128}</label>
                    <input type="range" min="0" max="255" value={event.effect?.ix ?? 128}
                        onChange={e => updateEffect('ix', parseInt(e.target.value))} />
                </div>
            </div>

            {/* Target devices */}
            <div className="input-group">
                <label style={{fontSize: 12}}>Zielgeraete</label>
                <select value={event.devices || 'all'} onChange={e => update('devices', e.target.value)}>
                    <option value="all">Alle Geraete</option>
                    {devices.map(d => (
                        <option key={d.id} value={d.id}>{d.name} ({d.ip})</option>
                    ))}
                </select>
            </div>

            {/* Favorites */}
            <div style={{marginTop: 16, paddingTop: 16, borderTop: '1px solid var(--border)'}}>
                <FavoritesPanel
                    currentEffect={event.effect}
                    currentDuration={event.duration || 0}
                    onApply={(eff, dur) => {
                        onChange({...event, effect: eff, duration: dur});
                    }}
                />
            </div>

            {/* Effect Chain */}
            <div style={{marginTop: 8, paddingTop: 16, borderTop: '1px solid var(--border)'}}>
                <EffectChainBuilder
                    chain={event.chain || null}
                    onChange={(chain) => update('chain', chain)}
                />
                {event.chain && event.chain.length > 0 && (
                    <p style={{fontSize: 11, color: 'var(--warning)', marginTop: 8}}>
                        ‚ö° Effekt-Kette aktiv: Die obigen Einzeleffekt-Einstellungen werden ignoriert.
                        Stattdessen werden die {event.chain.length} Schritte nacheinander abgespielt.
                    </p>
                )}
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Flash Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function FlashPage({ devices }) {
    const [flashMode, setFlashMode] = useState('ota');  // 'ota' or 'serial'
    const [controllerProfile, setControllerProfile] = useState('gledopto_gl-c-008wl');
    const [profiles, setProfiles] = useState({});

    // OTA state
    const [selectedDevice, setSelectedDevice] = useState('');
    const [deviceVersion, setDeviceVersion] = useState(null);

    // Serial state
    const [ports, setPorts] = useState([]);
    const [selectedPort, setSelectedPort] = useState('');

    // Shared state
    const [firmwares, setFirmwares] = useState([]);
    const [selectedFirmware, setSelectedFirmware] = useState(null);
    const [flashing, setFlashing] = useState(false);
    const [flashProgress, setFlashProgress] = useState(null);
    const [eraseFirst, setEraseFirst] = useState(true);
    const toast = useToast();

    const onlineDevices = devices.filter(d => d.online);
    const currentProfile = profiles[controllerProfile] || {};
    const chipFilter = currentProfile.firmware_filter || null;

    useEffect(() => {
        API.get('/api/flash/profiles').then(data => {
            if (data?.profiles) setProfiles(data.profiles);
        });
        loadFirmwares();
    }, []);

    useEffect(() => {
        if (chipFilter) loadFirmwares();
    }, [controllerProfile]);

    const refreshPorts = async () => {
        const data = await API.get('/api/flash/ports');
        setPorts(data?.ports || []);
    };

    const loadFirmwares = async () => {
        const chip = profiles[controllerProfile]?.firmware_filter || null;
        const url = chip ? `/api/flash/firmwares?chip=${chip}` : '/api/flash/firmwares';
        const data = await API.get(url);
        setFirmwares(data?.firmwares || []);
    };

    const checkVersion = async () => {
        const device = onlineDevices.find(d => d.id === selectedDevice);
        if (!device) return;
        const info = await API.get(`/api/flash/check-version/${device.ip}`);
        if (info?.version) {
            setDeviceVersion(info);
            toast(`Aktuelle Version: ${info.version} (${info.arch})`, 'info');
        } else {
            toast('Version konnte nicht abgefragt werden', 'error');
        }
    };

    const downloadFw = async (version, filename) => {
        toast('Firmware wird heruntergeladen...', 'info');
        const result = await API.post('/api/flash/download', {
            version, filename, chip_filter: chipFilter
        });
        if (result?.success) {
            toast('Firmware heruntergeladen!', 'success');
            setSelectedFirmware(result.path);
            loadFirmwares();
        } else {
            toast('Download fehlgeschlagen: ' + (result?.error || ''), 'error');
        }
    };

    const startFlash = async () => {
        if (!selectedFirmware) {
            toast('Firmware ausw√§hlen!', 'error');
            return;
        }

        if (flashMode === 'ota') {
            const device = onlineDevices.find(d => d.id === selectedDevice);
            if (!device) { toast('Ger√§t ausw√§hlen!', 'error'); return; }

            setFlashing(true);
            setFlashProgress({ stage: 'starting', progress: 0, message: 'Starte OTA Update...' });
            const result = await API.post('/api/flash/ota', {
                device_ip: device.ip,
                firmware_path: selectedFirmware
            });
            if (!result?.success) {
                toast('Fehler: ' + (result?.error || 'Unbekannt'), 'error');
                setFlashing(false);
            }
        } else {
            if (!selectedPort) { toast('Port ausw√§hlen!', 'error'); return; }
            setFlashing(true);
            setFlashProgress({ stage: 'starting', progress: 0, message: 'Starte Serial Flash...' });
            await API.post('/api/flash/serial', {
                port: selectedPort,
                firmware_path: selectedFirmware,
                chip: currentProfile.chip || 'esp32',
                erase_first: eraseFirst
            });
        }
    };

    return (
        <div>
            <div className="page-header">
                <h2>Firmware Updater</h2>
                <p>WLED Firmware per WiFi (OTA) oder USB aktualisieren</p>
            </div>

            {/* Controller Profile Selector */}
            <div className="card" style={{borderColor: 'var(--accent)', marginBottom: 20}}>
                <div className="card-header">
                    <span className="card-title">1. Controller-Typ ausw√§hlen</span>
                </div>
                <div className="input-group" style={{marginBottom: 12}}>
                    <select value={controllerProfile} onChange={e => {
                        setControllerProfile(e.target.value);
                        const p = profiles[e.target.value];
                        if (p) setFlashMode(p.flash_method || 'ota');
                    }}>
                        {Object.entries(profiles).map(([key, p]) => (
                            <option key={key} value={key}>
                                {p.name} ‚Äî {p.chip?.toUpperCase()} ({p.flash_method === 'ota' ? 'WiFi/OTA' : 'USB/Serial'})
                            </option>
                        ))}
                    </select>
                </div>

                {currentProfile.notes && (
                    <div style={{
                        padding: '12px 16px', borderRadius: 8, fontSize: 13, lineHeight: 1.6,
                        background: currentProfile.chip === 'esp8266' && currentProfile.flash_method === 'ota'
                            ? 'rgba(255,71,87,0.1)' : 'rgba(0,180,216,0.1)',
                        border: `1px solid ${currentProfile.chip === 'esp8266' && currentProfile.flash_method === 'ota'
                            ? 'rgba(255,71,87,0.3)' : 'rgba(0,180,216,0.3)'}`,
                        color: 'var(--text-secondary)',
                    }}>
                        {currentProfile.chip === 'esp8266' && currentProfile.flash_method === 'ota' && (
                            <span style={{color: 'var(--danger)', fontWeight: 700}}>‚ö† WICHTIG: </span>
                        )}
                        {currentProfile.notes}
                        {currentProfile.supported_strips && (
                            <div style={{marginTop: 6, fontSize: 12, color: 'var(--text-dim)'}}>
                                Unterst√ºtzte Strips: {currentProfile.supported_strips.join(', ')}
                                {currentProfile.max_ics && ` ¬∑ Max ${currentProfile.max_ics} ICs`}
                                {currentProfile.voltage && ` ¬∑ ${currentProfile.voltage}`}
                            </div>
                        )}
                    </div>
                )}

                <div className="tabs" style={{marginTop: 16, marginBottom: 0}}>
                    <div className={`tab ${flashMode === 'ota' ? 'active' : ''}`}
                        onClick={() => setFlashMode('ota')}>üì° OTA (WiFi)</div>
                    <div className={`tab ${flashMode === 'serial' ? 'active' : ''}`}
                        onClick={() => setFlashMode('serial')}>üîå USB (Serial)</div>
                </div>
            </div>

            <div className="grid-2">
                {/* Left: Target selection */}
                <div className="card">
                    <div className="card-header">
                        <span className="card-title">
                            2. {flashMode === 'ota' ? 'Zielger√§t (WiFi)' : 'USB-Port'}
                        </span>
                        {flashMode === 'serial' && (
                            <button className="btn btn-sm" onClick={refreshPorts}>‚Üª Ports laden</button>
                        )}
                    </div>

                    {flashMode === 'ota' ? (
                        <>
                            <div className="input-group">
                                <label>WLED-Ger√§t ausw√§hlen</label>
                                <select value={selectedDevice} onChange={e => { setSelectedDevice(e.target.value); setDeviceVersion(null); }}>
                                    <option value="">‚Äî Ger√§t w√§hlen ‚Äî</option>
                                    {onlineDevices.map(d => (
                                        <option key={d.id} value={d.id}>
                                            {d.name} ({d.ip}) ‚Äî v{d.version}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            {selectedDevice && (
                                <button className="btn btn-sm" onClick={checkVersion} style={{marginBottom: 12}}>
                                    üîç Version pr√ºfen
                                </button>
                            )}
                            {deviceVersion && (
                                <div style={{fontSize: 13, color: 'var(--text-secondary)', fontFamily: 'JetBrains Mono', lineHeight: 1.8}}>
                                    <div>Name: {deviceVersion.name}</div>
                                    <div>Version: <strong>{deviceVersion.version}</strong></div>
                                    <div>Architektur: <strong style={{color: deviceVersion.arch?.includes('8266') ? 'var(--warning)' : 'var(--info)'}}>{deviceVersion.arch}</strong></div>
                                    <div>LEDs: {deviceVersion.led_count}</div>
                                </div>
                            )}
                            {onlineDevices.length === 0 && (
                                <p style={{color: 'var(--warning)', fontSize: 13}}>
                                    Keine Online-Ger√§te gefunden. Stelle sicher, dass dein Controller mit dem WiFi verbunden ist.
                                </p>
                            )}
                        </>
                    ) : (
                        <>
                            {ports.length === 0 ? (
                                <div>
                                    <p style={{color: 'var(--text-dim)', fontSize: 14, marginBottom: 12}}>
                                        Kein Controller erkannt. Verbinde per USB und klicke "Ports laden".
                                    </p>
                                    <button className="btn btn-sm" onClick={refreshPorts}>‚Üª Ports laden</button>
                                </div>
                            ) : (
                                <select value={selectedPort} onChange={e => setSelectedPort(e.target.value)}>
                                    <option value="">‚Äî Port w√§hlen ‚Äî</option>
                                    {ports.map(p => (
                                        <option key={p.port} value={p.port}>
                                            {p.port} ‚Äî {p.description}
                                        </option>
                                    ))}
                                </select>
                            )}
                            <div style={{display: 'flex', alignItems: 'center', gap: 10, marginTop: 14}}>
                                <div className={`toggle ${eraseFirst ? 'active' : ''}`}
                                    onClick={() => setEraseFirst(!eraseFirst)} />
                                <span style={{fontSize: 13}}>Flash vorher l√∂schen (empfohlen bei Erstinstallation)</span>
                            </div>
                        </>
                    )}
                </div>

                {/* Right: Flash control */}
                <div className="card">
                    <div className="card-header">
                        <span className="card-title">3. Flashen</span>
                    </div>

                    {selectedFirmware && (
                        <div style={{
                            padding: '10px 14px', borderRadius: 8, marginBottom: 14,
                            background: 'rgba(108,92,231,0.1)', border: '1px solid rgba(108,92,231,0.3)',
                            fontSize: 13, fontFamily: 'JetBrains Mono',
                        }}>
                            üì¶ {selectedFirmware.split('/').pop()}
                        </div>
                    )}

                    <div style={{display: 'flex', gap: 10, flexWrap: 'wrap'}}>
                        <button className="btn btn-primary" onClick={startFlash} disabled={flashing}>
                            {flashing ? '‚ü≥ Flashe...' : flashMode === 'ota' ? 'üì° OTA Update starten' : 'üîå Serial Flash starten'}
                        </button>
                        {flashMode === 'serial' && (
                            <button className="btn" onClick={async () => {
                                if (!selectedPort) { toast('Port ausw√§hlen!', 'error'); return; }
                                toast('Backup wird erstellt...', 'info');
                                const result = await API.post('/api/flash/backup', {
                                    port: selectedPort, chip: currentProfile.chip || 'esp32'
                                });
                                if (result?.success) toast(`Backup: ${result.filename}`, 'success');
                                else toast('Backup fehlgeschlagen', 'error');
                            }}>üì¶ Backup</button>
                        )}
                    </div>

                    {flashProgress && (
                        <div style={{marginTop: 16}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: 13, marginBottom: 6}}>
                                <span>{flashProgress.message}</span>
                                <span>{flashProgress.progress}%</span>
                            </div>
                            <div className="progress-bar">
                                <div className="fill" style={{
                                    width: `${flashProgress.progress}%`,
                                    background: flashProgress.stage === 'error'
                                        ? 'var(--danger)'
                                        : flashProgress.stage === 'complete'
                                        ? 'var(--success)'
                                        : undefined
                                }}></div>
                            </div>
                            {flashProgress.stage === 'error' && (
                                <div style={{color: 'var(--danger)', fontSize: 13, marginTop: 8}}>
                                    {flashProgress.error}
                                </div>
                            )}
                            {flashProgress.stage === 'complete' && (
                                <div style={{color: 'var(--success)', fontSize: 13, marginTop: 8, fontWeight: 600}}>
                                    ‚úÖ {flashProgress.message}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>

            {/* Firmware list */}
            <div className="card">
                <div className="card-header">
                    <span className="card-title">
                        Verf√ºgbare Firmware
                        {chipFilter && <span className="badge badge-info" style={{marginLeft: 8}}>
                            Gefiltert: {chipFilter.toUpperCase()}
                        </span>}
                    </span>
                    <button className="btn btn-sm" onClick={loadFirmwares}>‚Üª Laden</button>
                </div>

                {firmwares.length === 0 ? (
                    <p style={{color: 'var(--text-dim)', fontSize: 14}}>Lade Firmware-Liste...</p>
                ) : (
                    <div style={{display: 'grid', gap: 10}}>
                        {firmwares.slice(0, 12).map((fw, i) => (
                            <div key={i} style={{
                                display: 'flex', alignItems: 'center', gap: 16, padding: '12px 0',
                                borderBottom: '1px solid var(--border)'
                            }}>
                                <div style={{flex: 1}}>
                                    <div style={{fontWeight: 600, fontSize: 14}}>
                                        {fw.name}
                                        {fw.prerelease && <span className="badge badge-warning" style={{marginLeft: 8}}>Pre-release</span>}
                                        {fw.local && <span className="badge badge-info" style={{marginLeft: 8}}>Lokal</span>}
                                    </div>
                                    <div style={{fontSize: 12, color: 'var(--text-dim)'}}>
                                        {fw.assets?.length} Datei(en)
                                        {fw.date && ` ¬∑ ${new Date(fw.date).toLocaleDateString('de')}`}
                                    </div>
                                </div>
                                <div style={{display: 'flex', gap: 6, flexWrap: 'wrap'}}>
                                    {fw.assets?.map((a, j) => (
                                        <button key={j} className="btn btn-sm"
                                            title={a.filename}
                                            onClick={() => {
                                                if (a.local_path) {
                                                    setSelectedFirmware(a.local_path);
                                                    toast(`Firmware ausgew√§hlt: ${a.filename}`, 'info');
                                                } else {
                                                    downloadFw(fw.version, a.filename);
                                                }
                                            }}>
                                            {a.local_path ? '‚úì W√§hlen' : `‚¨á ${a.variant}`}
                                            {a.is_ota && ' (OTA)'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {/* Safety info */}
            <div className="card" style={{borderColor: 'rgba(255,71,87,0.3)'}}>
                <div className="card-header">
                    <span className="card-title" style={{color: 'var(--danger)'}}>‚ö† Sicherheitshinweise</span>
                </div>
                <div style={{fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.8}}>
                    <p>‚Ä¢ <strong>Gledopto GL-C-008WL</strong>: Nutzt ESP8266 ‚Äî NUR ESP8266-Firmware verwenden!</p>
                    <p>‚Ä¢ <strong>ESP32-Firmware auf ESP8266 = Controller zerstoert!</strong> Das Programm pr√ºft dies automatisch.</p>
                    <p>‚Ä¢ <strong>OTA-Update</strong>: Controller muss im selben WiFi-Netzwerk sein und erreichbar sein.</p>
                    <p>‚Ä¢ Bei OTA-Updates wird der Controller kurz offline gehen und automatisch neu starten.</p>
                    <p>‚Ä¢ <strong>Strom nicht unterbrechen</strong> w√§hrend des Flash-Vorgangs!</p>
                    <p>‚Ä¢ Im Zweifel: <a href="https://install.wled.me" target="_blank" style={{color: 'var(--accent-bright)'}}>install.wled.me</a> als alternative Installationsmethode nutzen.</p>
                </div>
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Presets Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function PresetsPage({ devices }) {
    const [presets, setPresets] = useState([]);
    const [showCreate, setShowCreate] = useState(false);
    const [newName, setNewName] = useState('');
    const toast = useToast();

    useEffect(() => {
        API.get('/api/presets').then(data => setPresets(data?.presets || []));
    }, []);

    const savePreset = async () => {
        if (!newName) return;
        const preset = {
            name: newName,
            created: new Date().toISOString(),
            devices: devices.map(d => ({
                device_id: d.id,
                name: d.name,
                state: { bri: d.brightness, on: d.power, seg: d.segments }
            }))
        };
        await API.post('/api/presets', preset);
        toast('Preset gespeichert!', 'success');
        setNewName('');
        setShowCreate(false);
        const data = await API.get('/api/presets');
        setPresets(data?.presets || []);
    };

    const applyPreset = async (index) => {
        await API.post(`/api/presets/${index}/apply`);
        toast('Preset angewendet!', 'success');
    };

    const deletePreset = async (index) => {
        await API.del(`/api/presets/${index}`);
        toast('Preset gel√∂scht', 'success');
        const data = await API.get('/api/presets');
        setPresets(data?.presets || []);
    };

    return (
        <div>
            <div className="page-header">
                <h2>Presets</h2>
                <p>Speichere und lade LED-Konfigurationen</p>
            </div>

            <button className="btn btn-primary" style={{marginBottom: 20}} onClick={() => setShowCreate(true)}>
                + Aktuellen Zustand als Preset speichern
            </button>

            {showCreate && (
                <div className="card" style={{marginBottom: 20, borderColor: 'var(--accent)'}}>
                    <div className="input-group">
                        <label>Preset-Name</label>
                        <input type="text" value={newName} onChange={e => setNewName(e.target.value)}
                            placeholder="z.B. Spielabend, Training, Party" />
                    </div>
                    <div style={{display: 'flex', gap: 10}}>
                        <button className="btn btn-primary" onClick={savePreset}>Speichern</button>
                        <button className="btn" onClick={() => setShowCreate(false)}>Abbrechen</button>
                    </div>
                </div>
            )}

            <div className="grid-3">
                {presets.map((p, i) => (
                    <div key={i} className="card">
                        <div style={{fontWeight: 600, fontSize: 16, marginBottom: 6}}>{p.name}</div>
                        <div style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 14}}>
                            {p.devices?.length || 0} Ger√§te ¬∑ {p.created ? new Date(p.created).toLocaleDateString('de') : ''}
                        </div>
                        <div style={{display: 'flex', gap: 8}}>
                            <button className="btn btn-sm btn-primary" onClick={() => applyPreset(i)}>‚ñ∂ Laden</button>
                            <button className="btn btn-sm btn-danger" onClick={() => deletePreset(i)}>‚úï</button>
                        </div>
                    </div>
                ))}
            </div>

            {presets.length === 0 && (
                <div className="card" style={{textAlign: 'center', padding: 48}}>
                    <div style={{fontSize: 48, marginBottom: 16}}>‚òÖ</div>
                    <h3 style={{marginBottom: 8}}>Keine Presets</h3>
                    <p style={{color: 'var(--text-dim)'}}>Speichere deinen aktuellen LED-Zustand als Preset.</p>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Settings Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ Players Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function PlayersPage() {
    const [profiles, setProfiles] = useState([]);
    const [activeId, setActiveId] = useState('');
    const [editProfile, setEditProfile] = useState(null);
    const [showCreate, setShowCreate] = useState(false);
    const [newName, setNewName] = useState('');
    const [newAvatar, setNewAvatar] = useState('\uD83C\uDFAF');
    const [soundFiles, setSoundFiles] = useState([]);
    const [clipFiles, setClipFiles] = useState([]);
    const toast = useToast();
    const { t } = useI18n();

    const avatars = [
        '\uD83C\uDFAF', '\uD83D\uDD25', '\uD83D\uDC51', '\uD83E\uDD47', '\uD83C\uDFC6',
        '\uD83D\uDC8E', '\uD83C\uDF1F', '\u26A1', '\uD83D\uDE80', '\uD83D\uDC0D',
        '\uD83D\uDC3A', '\uD83E\uDD81', '\uD83E\uDD85', '\uD83E\uDDCA', '\uD83D\uDC7B',
        '\uD83E\uDD16', '\uD83C\uDFB3', '\uD83C\uDFAE', '\uD83C\uDFB5', '\uD83C\uDFB8',
    ];

    const load = () => {
        API.get('/api/profiles/players').then(d => {
            setProfiles(d?.profiles || []);
            setActiveId(d?.active || '');
        });
    };

    useEffect(() => {
        load();
        API.get('/api/caller/files').then(d => setSoundFiles(d?.sounds || []));
        API.get('/api/clips/files').then(d => setClipFiles(d?.files || []));
    }, []);

    const createProfile = async () => {
        if (!newName.trim()) return;
        await API.post('/api/profiles/players', { name: newName, avatar: newAvatar });
        setNewName('');
        setShowCreate(false);
        load();
        toast(t('common.success', 'Erstellt!'), 'success');
    };

    const activate = async (id) => {
        await API.post(`/api/profiles/players/${id}/activate`);
        setActiveId(id);
        toast('Walk-On!', 'success');
    };

    const deleteProfile = async (id) => {
        if (!confirm('Spieler-Profil l√∂schen?')) return;
        await API.del(`/api/profiles/players/${id}`);
        load();
    };

    const saveEdit = async () => {
        if (!editProfile) return;
        const { id, stats, created, ...data } = editProfile;
        await API.put(`/api/profiles/players/${id}`, data);
        setEditProfile(null);
        load();
        toast(t('common.save', 'Gespeichert!'), 'success');
    };

    const resetStats = async (id) => {
        if (!confirm('Statistiken zur√ºcksetzen?')) return;
        await API.post(`/api/profiles/players/${id}/reset-stats`);
        load();
    };

    const checkoutRate = (stats) => {
        const total = (stats?.checkouts_hit || 0) + (stats?.checkouts_missed || 0);
        return total > 0 ? ((stats.checkouts_hit / total) * 100).toFixed(1) : '‚Äî';
    };

    return (
        <div>
            <div className="page-header">
                <h2>Spieler-Profile</h2>
                <p>Walk-On Sounds, LED-Themes und Statistiken pro Spieler</p>
            </div>

            {/* Player Cards */}
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 12, marginBottom: 16}}>
                {profiles.map(p => {
                    const isActive = p.id === activeId;
                    const stats = p.stats || {};
                    return (
                        <div key={p.id} className="card" style={{
                            padding: 16,
                            border: isActive ? '2px solid var(--accent)' : '1px solid var(--border)',
                            background: isActive ? 'rgba(139,92,246,0.06)' : 'var(--bg-card)',
                        }}>
                            <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12}}>
                                <span style={{fontSize: 32}}>{p.avatar || '\uD83C\uDFAF'}</span>
                                <div style={{flex: 1}}>
                                    <div style={{fontWeight: 700, fontSize: 16}}>{p.name}</div>
                                    {isActive && <span style={{fontSize: 11, color: 'var(--accent)', fontWeight: 600}}>AKTIV</span>}
                                </div>
                                <div style={{width: 24, height: 24, borderRadius: '50%', background: p.led_color || '#8b5cf6', border: '2px solid var(--border)'}} title="LED-Farbe" />
                            </div>

                            {/* Mini Stats */}
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 6, marginBottom: 12}}>
                                {[
                                    { label: 'Avg', value: stats.avg_score || '‚Äî' },
                                    { label: 'Highest', value: stats.highest_score || '‚Äî' },
                                    { label: '180s', value: stats.total_180s || 0 },
                                    { label: 'Legs', value: stats.legs_won || 0 },
                                    { label: 'Matches', value: stats.matches_won || 0 },
                                    { label: 'Checkout%', value: checkoutRate(stats) },
                                ].map(s => (
                                    <div key={s.label} style={{textAlign: 'center', padding: '4px 0'}}>
                                        <div style={{fontSize: 11, color: 'var(--text-dim)'}}>{s.label}</div>
                                        <div style={{fontSize: 15, fontWeight: 600, fontVariantNumeric: 'tabular-nums'}}>{s.value}</div>
                                    </div>
                                ))}
                            </div>

                            {/* Quick Info */}
                            <div style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 10}}>
                                {p.walk_on_sound && <span>üéµ {p.walk_on_sound} </span>}
                                {p.victory_clip && <span>üé¨ Victory-Clip </span>}
                            </div>

                            {/* Actions */}
                            <div style={{display: 'flex', gap: 6}}>
                                {!isActive && (
                                    <button className="btn btn-primary" style={{flex: 1, fontSize: 12}} onClick={() => activate(p.id)}>
                                        ‚ñ∂ Aktivieren
                                    </button>
                                )}
                                <button className="btn" style={{fontSize: 12}} onClick={() => setEditProfile({...p})}>
                                    ‚úè Bearbeiten
                                </button>
                                <button className="btn" style={{fontSize: 12, color: '#f44'}} onClick={() => deleteProfile(p.id)}>
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    );
                })}

                {/* Add Player Card */}
                <div className="card" style={{
                    padding: 16, display: 'flex', alignItems: 'center', justifyContent: 'center',
                    minHeight: 200, cursor: 'pointer', border: '2px dashed var(--border)',
                    opacity: 0.6, transition: 'opacity 0.2s',
                }} onClick={() => setShowCreate(true)}
                   onMouseEnter={e => e.currentTarget.style.opacity = 1}
                   onMouseLeave={e => e.currentTarget.style.opacity = 0.6}>
                    <div style={{textAlign: 'center'}}>
                        <div style={{fontSize: 36, marginBottom: 8}}>+</div>
                        <div style={{fontSize: 14}}>Neuer Spieler</div>
                    </div>
                </div>
            </div>

            {/* Create Modal */}
            {showCreate && (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setShowCreate(false)}>
                    <div className="modal" style={{maxWidth: 400}}>
                        <h3>Neuer Spieler</h3>
                        <div style={{marginBottom: 12}}>
                            <label style={{fontSize: 13, color: 'var(--text-dim)'}}>Name</label>
                            <input type="text" value={newName} onChange={e => setNewName(e.target.value)}
                                placeholder="Name eingeben..."
                                style={{width: '100%', padding: '8px 12px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 6, marginTop: 4}}
                                autoFocus onKeyDown={e => e.key === 'Enter' && createProfile()} />
                        </div>
                        <div style={{marginBottom: 16}}>
                            <label style={{fontSize: 13, color: 'var(--text-dim)'}}>Avatar</label>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: 4, marginTop: 4}}>
                                {avatars.map(a => (
                                    <button key={a} onClick={() => setNewAvatar(a)}
                                        style={{
                                            fontSize: 22, padding: '4px 6px', background: newAvatar === a ? 'var(--accent)' : 'transparent',
                                            border: newAvatar === a ? 'none' : '1px solid var(--border)', borderRadius: 6, cursor: 'pointer',
                                        }}>{a}</button>
                                ))}
                            </div>
                        </div>
                        <div style={{display: 'flex', gap: 8}}>
                            <button className="btn btn-primary" style={{flex: 1}} onClick={createProfile}>Erstellen</button>
                            <button className="btn" onClick={() => setShowCreate(false)}>Abbrechen</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Edit Modal */}
            {editProfile && (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setEditProfile(null)}>
                    <div className="modal" style={{maxWidth: 520, maxHeight: '90vh', overflow: 'auto'}}>
                        <h3>{editProfile.avatar} {editProfile.name} ‚Äî Profil bearbeiten</h3>

                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 16}}>
                            <div>
                                <label style={{fontSize: 12, color: 'var(--text-dim)'}}>Name</label>
                                <input type="text" value={editProfile.name} onChange={e => setEditProfile({...editProfile, name: e.target.value})}
                                    style={{width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4}} />
                            </div>
                            <div>
                                <label style={{fontSize: 12, color: 'var(--text-dim)'}}>LED-Farbe</label>
                                <input type="color" value={editProfile.led_color || '#8b5cf6'} onChange={e => setEditProfile({...editProfile, led_color: e.target.value})}
                                    style={{width: '100%', height: 34, border: 'none', borderRadius: 4, cursor: 'pointer'}} />
                            </div>
                        </div>

                        <div style={{marginBottom: 12}}>
                            <label style={{fontSize: 12, color: 'var(--text-dim)'}}>Avatar</label>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: 3, marginTop: 4}}>
                                {avatars.map(a => (
                                    <button key={a} onClick={() => setEditProfile({...editProfile, avatar: a})}
                                        style={{
                                            fontSize: 20, padding: '3px 5px',
                                            background: editProfile.avatar === a ? 'var(--accent)' : 'transparent',
                                            border: editProfile.avatar === a ? 'none' : '1px solid var(--border)',
                                            borderRadius: 4, cursor: 'pointer',
                                        }}>{a}</button>
                                ))}
                            </div>
                        </div>

                        <div style={{marginBottom: 12}}>
                            <label style={{fontSize: 12, color: 'var(--text-dim)'}}>üéµ Walk-On Sound</label>
                            <select value={editProfile.walk_on_sound || ''} onChange={e => setEditProfile({...editProfile, walk_on_sound: e.target.value})}
                                style={{width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4}}>
                                <option value="">‚Äî Kein Walk-On ‚Äî</option>
                                {soundFiles.map(f => <option key={f.filename} value={f.filename}>{f.filename}</option>)}
                            </select>
                        </div>

                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 12}}>
                            <div>
                                <label style={{fontSize: 12, color: 'var(--text-dim)'}}>üé¨ Victory-Clip</label>
                                <select value={editProfile.victory_clip || ''} onChange={e => setEditProfile({...editProfile, victory_clip: e.target.value})}
                                    style={{width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4}}>
                                    <option value="">‚Äî Kein Clip ‚Äî</option>
                                    {clipFiles.map(f => <option key={f.filename} value={f.filename}>{f.filename}</option>)}
                                </select>
                            </div>
                            <div>
                                <label style={{fontSize: 12, color: 'var(--text-dim)'}}>üí• Bust-Clip</label>
                                <select value={editProfile.bust_clip || ''} onChange={e => setEditProfile({...editProfile, bust_clip: e.target.value})}
                                    style={{width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4}}>
                                    <option value="">‚Äî Kein Clip ‚Äî</option>
                                    {clipFiles.map(f => <option key={f.filename} value={f.filename}>{f.filename}</option>)}
                                </select>
                            </div>
                        </div>

                        <div style={{marginBottom: 12}}>
                            <label style={{fontSize: 12, color: 'var(--text-dim)'}}>LED-Helligkeit</label>
                            <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                                <input type="range" min="10" max="255" value={editProfile.led_brightness || 180}
                                    onChange={e => setEditProfile({...editProfile, led_brightness: parseInt(e.target.value)})}
                                    style={{flex: 1, accentColor: 'var(--accent)'}} />
                                <span style={{fontFamily: 'monospace', fontSize: 13, minWidth: 30}}>{editProfile.led_brightness || 180}</span>
                            </div>
                        </div>

                        {/* Stats Display */}
                        <div style={{padding: 12, background: 'var(--bg)', borderRadius: 8, marginBottom: 16}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                                <span style={{fontWeight: 600, fontSize: 14}}>Statistiken</span>
                                <button className="btn" style={{fontSize: 11, padding: '2px 8px'}} onClick={() => resetStats(editProfile.id)}>Reset</button>
                            </div>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 6, fontSize: 12}}>
                                {[
                                    { label: 'Avg Score', value: editProfile.stats?.avg_score || '‚Äî' },
                                    { label: 'Highest', value: editProfile.stats?.highest_score || '‚Äî' },
                                    { label: '180s', value: editProfile.stats?.total_180s || 0 },
                                    { label: 'Legs Won', value: editProfile.stats?.legs_won || 0 },
                                    { label: 'Matches Won', value: editProfile.stats?.matches_won || 0 },
                                    { label: 'Checkout%', value: checkoutRate(editProfile.stats || {}) },
                                    { label: 'Bullseyes', value: editProfile.stats?.total_bullseyes || 0 },
                                    { label: 'Best C/O', value: editProfile.stats?.best_checkout || '‚Äî' },
                                    { label: 'Games', value: editProfile.stats?.games_played || 0 },
                                ].map(s => (
                                    <div key={s.label} style={{textAlign: 'center', padding: 4, background: 'var(--bg-card)', borderRadius: 4}}>
                                        <div style={{color: 'var(--text-dim)', fontSize: 10}}>{s.label}</div>
                                        <div style={{fontWeight: 600, fontSize: 14}}>{s.value}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div style={{display: 'flex', gap: 8}}>
                            <button className="btn btn-primary" style={{flex: 1}} onClick={saveEdit}>{t('common.save', 'Speichern')}</button>
                            <button className="btn" onClick={() => setEditProfile(null)}>{t('common.cancel', 'Abbrechen')}</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Stats Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function StatsPage() {
    const [profiles, setProfiles] = useState([]);
    const [selectedId, setSelectedId] = useState('all');
    const { t } = useI18n();

    useEffect(() => {
        API.get('/api/profiles/players').then(d => {
            setProfiles(d?.profiles || []);
        });
    }, []);

    // Aggregate stats across all or single player
    const getStats = () => {
        const targets = selectedId === 'all' ? profiles : profiles.filter(p => p.id === selectedId);
        if (targets.length === 0) return null;
        const agg = {
            games_played: 0, legs_won: 0, matches_won: 0,
            highest_score: 0, total_180s: 0, total_bullseyes: 0,
            checkouts_hit: 0, checkouts_missed: 0, best_checkout: 0,
            all_scores: [],
        };
        targets.forEach(p => {
            const s = p.stats || {};
            agg.games_played += s.games_played || 0;
            agg.legs_won += s.legs_won || 0;
            agg.matches_won += s.matches_won || 0;
            agg.total_180s += s.total_180s || 0;
            agg.total_bullseyes += s.total_bullseyes || 0;
            agg.checkouts_hit += s.checkouts_hit || 0;
            agg.checkouts_missed += s.checkouts_missed || 0;
            if ((s.highest_score || 0) > agg.highest_score) agg.highest_score = s.highest_score;
            if ((s.best_checkout || 0) > agg.best_checkout) agg.best_checkout = s.best_checkout;
            agg.all_scores.push(...(s.scores_history || []));
        });
        agg.avg_score = agg.all_scores.length > 0
            ? (agg.all_scores.reduce((a, b) => a + b, 0) / agg.all_scores.length).toFixed(1)
            : '‚Äî';
        const coTotal = agg.checkouts_hit + agg.checkouts_missed;
        agg.checkout_rate = coTotal > 0 ? ((agg.checkouts_hit / coTotal) * 100).toFixed(1) + '%' : '‚Äî';
        return agg;
    };

    // Score distribution histogram
    const getDistribution = () => {
        const targets = selectedId === 'all' ? profiles : profiles.filter(p => p.id === selectedId);
        const scores = [];
        targets.forEach(p => scores.push(...(p.stats?.scores_history || [])));
        const bins = [
            { label: '0-20', min: 0, max: 20, count: 0, color: '#ef4444' },
            { label: '21-40', min: 21, max: 40, count: 0, color: '#f97316' },
            { label: '41-60', min: 41, max: 60, count: 0, color: '#eab308' },
            { label: '61-80', min: 61, max: 80, count: 0, color: '#84cc16' },
            { label: '81-100', min: 81, max: 100, count: 0, color: '#22c55e' },
            { label: '101-120', min: 101, max: 120, count: 0, color: '#14b8a6' },
            { label: '121-140', min: 121, max: 140, count: 0, color: '#06b6d4' },
            { label: '141-160', min: 141, max: 160, count: 0, color: '#3b82f6' },
            { label: '161-180', min: 161, max: 180, count: 0, color: '#8b5cf6' },
        ];
        scores.forEach(s => {
            const bin = bins.find(b => s >= b.min && s <= b.max);
            if (bin) bin.count++;
        });
        return bins;
    };

    const stats = getStats();
    const dist = getDistribution();
    const maxCount = Math.max(...dist.map(b => b.count), 1);

    const statCards = stats ? [
        { icon: 'üéØ', label: 'Avg Score', value: stats.avg_score, big: true },
        { icon: 'üî•', label: 'Highest Score', value: stats.highest_score || '‚Äî' },
        { icon: 'üíØ', label: '180s', value: stats.total_180s },
        { icon: 'üéØ', label: 'Bullseyes', value: stats.total_bullseyes },
        { icon: 'üèÜ', label: 'Matches Won', value: stats.matches_won },
        { icon: '‚úÖ', label: 'Legs Won', value: stats.legs_won },
        { icon: 'üéÆ', label: 'Games Played', value: stats.games_played },
        { icon: 'üé∞', label: 'Checkout %', value: stats.checkout_rate },
        { icon: '‚≠ê', label: 'Best Checkout', value: stats.best_checkout || '‚Äî' },
        { icon: '‚úì', label: 'Checkouts Hit', value: stats.checkouts_hit },
        { icon: '‚úó', label: 'Checkouts Missed', value: stats.checkouts_missed },
    ] : [];

    return (
        <div>
            <div className="page-header">
                <h2>üìä {t('nav.stats', 'Statistiken')}</h2>
                <p>Spieler-Leistung und Score-Verteilung</p>
            </div>

            {/* Player Filter */}
            <div className="card" style={{padding: 12, marginBottom: 16, display: 'flex', alignItems: 'center', gap: 8}}>
                <span style={{fontSize: 13, color: 'var(--text-dim)'}}>Spieler:</span>
                <button className={'btn ' + (selectedId === 'all' ? 'btn-primary' : '')}
                    style={{fontSize: 12, padding: '4px 10px'}}
                    onClick={() => setSelectedId('all')}>
                    Alle
                </button>
                {profiles.map(p => (
                    <button key={p.id} className={'btn ' + (selectedId === p.id ? 'btn-primary' : '')}
                        style={{fontSize: 12, padding: '4px 10px'}}
                        onClick={() => setSelectedId(p.id)}>
                        {p.avatar} {p.name}
                    </button>
                ))}
            </div>

            {profiles.length === 0 && (
                <div className="card" style={{padding: 32, textAlign: 'center', color: 'var(--text-dim)'}}>
                    <div style={{fontSize: 48, marginBottom: 12}}>üìä</div>
                    <p>Noch keine Spieler-Profile vorhanden.</p>
                    <p style={{fontSize: 13}}>Erstelle Profile unter "Spieler" um Statistiken zu sammeln.</p>
                </div>
            )}

            {stats && <>
                {/* Big Stat Cards */}
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: 10, marginBottom: 16}}>
                    {statCards.map(c => (
                        <div key={c.label} className="card" style={{
                            padding: '14px 12px', textAlign: 'center',
                            background: c.big ? 'linear-gradient(135deg, rgba(139,92,246,0.15), rgba(59,130,246,0.1))' : 'var(--bg-card)',
                        }}>
                            <div style={{fontSize: 20, marginBottom: 4}}>{c.icon}</div>
                            <div style={{fontSize: c.big ? 28 : 22, fontWeight: 700, fontVariantNumeric: 'tabular-nums', color: c.big ? 'var(--accent)' : 'var(--text)'}}>
                                {c.value}
                            </div>
                            <div style={{fontSize: 11, color: 'var(--text-dim)', marginTop: 2}}>{c.label}</div>
                        </div>
                    ))}
                </div>

                {/* Score Distribution Chart */}
                <div className="card" style={{padding: 16}}>
                    <h4 style={{margin: '0 0 12px'}}>Score-Verteilung (3-Dart)</h4>
                    <div style={{display: 'flex', alignItems: 'flex-end', gap: 4, height: 140}}>
                        {dist.map(bin => (
                            <div key={bin.label} style={{flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                                <div style={{fontSize: 10, color: 'var(--text-dim)', marginBottom: 4}}>
                                    {bin.count > 0 ? bin.count : ''}
                                </div>
                                <div style={{
                                    width: '100%', background: bin.color,
                                    height: `${Math.max((bin.count / maxCount) * 110, bin.count > 0 ? 4 : 0)}px`,
                                    borderRadius: '4px 4px 0 0', transition: 'height 0.3s ease',
                                    opacity: bin.count > 0 ? 1 : 0.15,
                                }} />
                                <div style={{fontSize: 9, color: 'var(--text-dim)', marginTop: 4, whiteSpace: 'nowrap'}}>
                                    {bin.label}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Leaderboard if multiple players */}
                {profiles.length > 1 && selectedId === 'all' && (
                    <div className="card" style={{padding: 16, marginTop: 12}}>
                        <h4 style={{margin: '0 0 12px'}}>üèÜ Leaderboard</h4>
                        <table style={{width: '100%', borderCollapse: 'collapse', fontSize: 13}}>
                            <thead>
                                <tr style={{borderBottom: '1px solid var(--border)', color: 'var(--text-dim)'}}>
                                    <th style={{textAlign: 'left', padding: '6px 8px'}}>#</th>
                                    <th style={{textAlign: 'left', padding: '6px 8px'}}>Spieler</th>
                                    <th style={{textAlign: 'right', padding: '6px 8px'}}>Avg</th>
                                    <th style={{textAlign: 'right', padding: '6px 8px'}}>180s</th>
                                    <th style={{textAlign: 'right', padding: '6px 8px'}}>Legs</th>
                                    <th style={{textAlign: 'right', padding: '6px 8px'}}>Matches</th>
                                </tr>
                            </thead>
                            <tbody>
                                {[...profiles]
                                    .sort((a, b) => (b.stats?.avg_score || 0) - (a.stats?.avg_score || 0))
                                    .map((p, i) => (
                                        <tr key={p.id} style={{borderBottom: '1px solid var(--border)'}}>
                                            <td style={{padding: '6px 8px', fontWeight: 600}}>
                                                {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}
                                            </td>
                                            <td style={{padding: '6px 8px'}}>{p.avatar} {p.name}</td>
                                            <td style={{textAlign: 'right', padding: '6px 8px', fontVariantNumeric: 'tabular-nums', fontWeight: 600}}>
                                                {p.stats?.avg_score || '‚Äî'}
                                            </td>
                                            <td style={{textAlign: 'right', padding: '6px 8px'}}>{p.stats?.total_180s || 0}</td>
                                            <td style={{textAlign: 'right', padding: '6px 8px'}}>{p.stats?.legs_won || 0}</td>
                                            <td style={{textAlign: 'right', padding: '6px 8px'}}>{p.stats?.matches_won || 0}</td>
                                        </tr>
                                    ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </>}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ LED Animation Designer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function LEDDesignerPage() {
    const [presets, setPresets] = useState([]);
    const [custom, setCustom] = useState([]);
    const [editAnim, setEditAnim] = useState(null);
    const [newName, setNewName] = useState('');
    const toast = useToast();
    const { t } = useI18n();

    const load = () => {
        API.get('/api/led-designer/animations').then(d => {
            setPresets(d?.presets || []);
            setCustom(d?.custom || []);
        });
    };
    useEffect(load, []);

    const createAnim = async () => {
        if (!newName.trim()) return;
        const res = await API.post('/api/led-designer/animations', { name: newName });
        if (res?.success) { setNewName(''); load(); }
    };

    const deleteAnim = async (id) => {
        if (!confirm('Animation l√∂schen?')) return;
        await API.del(`/api/led-designer/animations/${id}`);
        load();
    };

    const preview = async (anim) => {
        toast('Preview wird abgespielt...', 'info');
        await API.post('/api/led-designer/preview', { animation: anim });
    };

    const saveEdit = async () => {
        if (!editAnim) return;
        await API.post('/api/led-designer/animations', editAnim);
        setEditAnim(null);
        load();
        toast('Animation gespeichert!', 'success');
    };

    const addFrame = () => {
        if (!editAnim) return;
        const frames = [...editAnim.frames];
        const lastTime = frames.length > 0 ? frames[frames.length - 1].time : 0;
        frames.push({ time: lastTime + 500, colors: ['#8b5cf6'], brightness: 200, transition: 300 });
        setEditAnim({ ...editAnim, frames, duration: Math.max(editAnim.duration, lastTime + 1000) });
    };

    const removeFrame = (idx) => {
        if (!editAnim || editAnim.frames.length <= 1) return;
        const frames = editAnim.frames.filter((_, i) => i !== idx);
        setEditAnim({ ...editAnim, frames });
    };

    const updateFrame = (idx, field, value) => {
        const frames = [...editAnim.frames];
        frames[idx] = { ...frames[idx], [field]: value };
        setEditAnim({ ...editAnim, frames });
    };

    const AnimCard = ({ anim, isPreset }) => (
        <div className="card" style={{ padding: 14, display: 'flex', alignItems: 'center', gap: 12 }}>
            {/* Color preview strip */}
            <div style={{ width: 48, height: 48, borderRadius: 8, overflow: 'hidden', display: 'flex', flexShrink: 0 }}>
                {(anim.frames?.[0]?.colors || ['#888']).slice(0, 4).map((c, i) => (
                    <div key={i} style={{ flex: 1, height: '100%', background: c }} />
                ))}
            </div>
            <div style={{ flex: 1 }}>
                <div style={{ fontWeight: 600, fontSize: 14 }}>{anim.name}</div>
                <div style={{ fontSize: 11, color: 'var(--text-dim)' }}>
                    {anim.frames?.length || 0} Frames ¬∑ {anim.duration || 0}ms ¬∑ {anim.blend_mode || 'linear'}
                    {anim.loop ? ' ¬∑ Loop' : ''}
                    {isPreset && ' ¬∑ Preset'}
                </div>
            </div>
            <button className="btn" style={{ fontSize: 12 }} onClick={() => preview(anim)}>‚ñ∂ Preview</button>
            {!isPreset && (
                <>
                    <button className="btn" style={{ fontSize: 12 }} onClick={() => setEditAnim({ ...anim })}>‚úè</button>
                    <button className="btn" style={{ fontSize: 12, color: '#f44' }} onClick={() => deleteAnim(anim.id)}>‚úï</button>
                </>
            )}
            {isPreset && (
                <button className="btn" style={{ fontSize: 12 }} onClick={async () => {
                    await API.post('/api/led-designer/animations', { ...anim, id: null, name: anim.name + ' (Kopie)', builtin: false });
                    load();
                }}>üìã Kopieren</button>
            )}
        </div>
    );

    return (
        <div>
            <div className="page-header">
                <h2>üí° LED Animations-Designer</h2>
                <p>Erstelle eigene LED-Animationen mit Keyframes</p>
            </div>

            {/* Create new */}
            <div className="card" style={{ padding: 12, marginBottom: 12, display: 'flex', gap: 8 }}>
                <input type="text" value={newName} onChange={e => setNewName(e.target.value)}
                    placeholder="Neue Animation..." onKeyDown={e => e.key === 'Enter' && createAnim()}
                    style={{ flex: 1, padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                <button className="btn btn-primary" onClick={createAnim}>+ Erstellen</button>
            </div>

            {/* Custom Animations */}
            {custom.length > 0 && <h4 style={{ margin: '16px 0 8px' }}>üé® Eigene Animationen</h4>}
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8, marginBottom: 16 }}>
                {custom.map(a => <AnimCard key={a.id} anim={a} isPreset={false} />)}
            </div>

            {/* Preset Animations */}
            <h4 style={{ margin: '16px 0 8px' }}>‚≠ê Preset-Animationen</h4>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                {presets.map(a => <AnimCard key={a.id} anim={a} isPreset={true} />)}
            </div>

            {/* Edit Modal */}
            {editAnim && (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && setEditAnim(null)}>
                    <div className="modal" style={{ maxWidth: 600, maxHeight: '90vh', overflow: 'auto' }}>
                        <h3>‚úè {editAnim.name}</h3>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 10, marginBottom: 16 }}>
                            <div>
                                <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Name</label>
                                <input type="text" value={editAnim.name} onChange={e => setEditAnim({ ...editAnim, name: e.target.value })}
                                    style={{ width: '100%', padding: '4px 8px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                            </div>
                            <div>
                                <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Dauer (ms)</label>
                                <input type="number" value={editAnim.duration} onChange={e => setEditAnim({ ...editAnim, duration: parseInt(e.target.value) || 2000 })}
                                    style={{ width: '100%', padding: '4px 8px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                            </div>
                            <div>
                                <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Blend</label>
                                <select value={editAnim.blend_mode || 'linear'} onChange={e => setEditAnim({ ...editAnim, blend_mode: e.target.value })}
                                    style={{ width: '100%', padding: '4px 8px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }}>
                                    <option value="linear">Linear</option>
                                    <option value="step">Step</option>
                                    <option value="ease">Ease</option>
                                </select>
                            </div>
                        </div>

                        <label style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 16, cursor: 'pointer', fontSize: 13 }}>
                            <input type="checkbox" checked={editAnim.loop !== false} onChange={e => setEditAnim({ ...editAnim, loop: e.target.checked })}
                                style={{ accentColor: 'var(--accent)' }} /> Loop
                        </label>

                        {/* Timeline */}
                        <div style={{ marginBottom: 12, padding: 8, background: 'var(--bg)', borderRadius: 8, position: 'relative', height: 32 }}>
                            {editAnim.frames.map((f, i) => {
                                const pos = editAnim.duration > 0 ? (f.time / editAnim.duration) * 100 : 0;
                                return <div key={i} style={{ position: 'absolute', left: `${pos}%`, top: 4, width: 24, height: 24, borderRadius: 999, background: f.colors?.[0] || '#888', border: '2px solid #fff', transform: 'translateX(-50%)', cursor: 'pointer' }} title={`${f.time}ms`} />;
                            })}
                        </div>

                        {/* Keyframes */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: 8, marginBottom: 12 }}>
                            {editAnim.frames.map((f, i) => (
                                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '6px 8px', background: 'var(--bg-card)', borderRadius: 6, border: '1px solid var(--border)' }}>
                                    <span style={{ fontSize: 11, color: 'var(--text-dim)', minWidth: 16 }}>{i + 1}</span>
                                    <input type="number" value={f.time} onChange={e => updateFrame(i, 'time', parseInt(e.target.value) || 0)}
                                        style={{ width: 60, padding: '2px 4px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 3, fontSize: 12 }} title="Time (ms)" />
                                    <span style={{ fontSize: 10, color: 'var(--text-dim)' }}>ms</span>
                                    {(f.colors || ['#ffffff']).map((c, ci) => (
                                        <input key={ci} type="color" value={c} onChange={e => {
                                            const colors = [...(f.colors || ['#ffffff'])];
                                            colors[ci] = e.target.value;
                                            updateFrame(i, 'colors', colors);
                                        }} style={{ width: 28, height: 24, border: 'none', borderRadius: 3, cursor: 'pointer' }} />
                                    ))}
                                    <button onClick={() => { const colors = [...(f.colors || []), '#ffffff']; updateFrame(i, 'colors', colors); }}
                                        style={{ background: 'none', border: '1px dashed var(--border)', borderRadius: 3, width: 24, height: 24, cursor: 'pointer', fontSize: 12, color: 'var(--text-dim)' }}>+</button>
                                    <input type="range" min="0" max="255" value={f.brightness || 200} onChange={e => updateFrame(i, 'brightness', parseInt(e.target.value))}
                                        style={{ width: 60, accentColor: 'var(--accent)' }} title={`Brightness: ${f.brightness || 200}`} />
                                    <button onClick={() => removeFrame(i)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#f44', fontSize: 14 }}>‚úï</button>
                                </div>
                            ))}
                        </div>

                        <div style={{ display: 'flex', gap: 8 }}>
                            <button className="btn" onClick={addFrame}>+ Keyframe</button>
                            <button className="btn" onClick={() => preview(editAnim)}>‚ñ∂ Preview</button>
                            <div style={{ flex: 1 }} />
                            <button className="btn btn-primary" onClick={saveEdit}>Speichern</button>
                            <button className="btn" onClick={() => setEditAnim(null)}>Abbrechen</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Integrations Page (Twitch + Discord) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function IntegrationsPage() {
    const [twitchCfg, setTwitchCfg] = useState({});
    const [twitchStatus, setTwitchStatus] = useState({ connected: false });
    const [discordCfg, setDiscordCfg] = useState({});
    const [oauthInput, setOauthInput] = useState('');
    const [webhookInput, setWebhookInput] = useState('');
    const [whConfig, setWhConfig] = useState({ enabled: false, webhooks: [], available_events: {} });
    const toast = useToast();

    useEffect(() => {
        API.get('/api/twitch/config').then(d => setTwitchCfg(d || {}));
        API.get('/api/twitch/status').then(d => setTwitchStatus(d || {}));
        API.get('/api/discord/config').then(d => setDiscordCfg(d || {}));
        API.get('/api/webhooks/config').then(d => { if (d) setWhConfig(d); });
    }, []);

    const saveTwitch = (update) => {
        const next = { ...twitchCfg, ...update };
        setTwitchCfg(next);
        API.post('/api/twitch/config', next);
    };

    const saveDiscord = (update) => {
        const next = { ...discordCfg, ...update };
        setDiscordCfg(next);
        API.post('/api/discord/config', next);
    };

    // Webhook helpers
    const saveWebhooks = (updates = {}) => {
        const next = { ...whConfig, ...updates };
        setWhConfig(next);
        API.post('/api/webhooks/config', { enabled: next.enabled, webhooks: next.webhooks });
    };

    const addWebhook = () => {
        const id = 'wh_' + Date.now();
        const wh = { id, name: 'Neuer Webhook', url: '', enabled: true, events: ['180', 'match_won'], headers: {}, secret: '', include_stats: false, last_status: null, last_sent: null };
        saveWebhooks({ webhooks: [...whConfig.webhooks, wh] });
    };

    const updateWebhook = (id, update) => {
        const webhooks = whConfig.webhooks.map(w => w.id === id ? { ...w, ...update } : w);
        saveWebhooks({ webhooks });
    };

    const removeWebhook = (id) => {
        saveWebhooks({ webhooks: whConfig.webhooks.filter(w => w.id !== id) });
    };

    const testWebhook = async (id) => {
        const r = await API.post('/api/webhooks/test/' + id);
        if (r?.success) toast('Test gesendet! Status: ' + r.status, 'success');
        else toast('Fehler: ' + (r?.error || 'Unbekannt'), 'error');
        // Refresh config to get updated last_status
        API.get('/api/webhooks/config').then(d => { if (d) setWhConfig(d); });
    };

    return (
        <div>
            <div className="page-header">
                <h2>üîó Integrationen</h2>
                <p>Twitch, Discord, OBS und Custom Webhooks</p>
            </div>

            {/* ‚ïê‚ïê‚ïê TWITCH ‚ïê‚ïê‚ïê */}
            <div className="card" style={{ padding: 16, marginBottom: 16, borderColor: twitchStatus.connected ? 'var(--success)' : 'var(--border)' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 }}>
                    <span style={{ fontSize: 28 }}>üì∫</span>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 700, fontSize: 16 }}>Twitch Chat Bot</div>
                        <div style={{ fontSize: 12, color: twitchStatus.connected ? 'var(--success)' : 'var(--text-dim)' }}>
                            {twitchStatus.connected ? `‚úì Verbunden mit #${twitchStatus.channel}` : 'Nicht verbunden'}
                        </div>
                    </div>
                    <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                        <span style={{ fontSize: 13, color: twitchCfg.enabled ? 'var(--accent)' : 'var(--text-dim)' }}>
                            {twitchCfg.enabled ? 'Aktiv' : 'Aus'}
                        </span>
                        <input type="checkbox" checked={twitchCfg.enabled || false}
                            onChange={e => saveTwitch({ enabled: e.target.checked })}
                            style={{ accentColor: 'var(--accent)', width: 18, height: 18 }} />
                    </label>
                </div>

                {twitchCfg.enabled && <>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10, marginBottom: 12 }}>
                        <div>
                            <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Channel</label>
                            <input type="text" value={twitchCfg.channel || ''} onChange={e => saveTwitch({ channel: e.target.value })}
                                placeholder="dein_kanal"
                                style={{ width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                        </div>
                        <div>
                            <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Bot Name</label>
                            <input type="text" value={twitchCfg.bot_name || 'ThrowSyncBot'} onChange={e => saveTwitch({ bot_name: e.target.value })}
                                style={{ width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                        </div>
                    </div>
                    <div style={{ marginBottom: 12 }}>
                        <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>OAuth Token</label>
                        <div style={{ display: 'flex', gap: 6 }}>
                            <input type="password" value={oauthInput} onChange={e => setOauthInput(e.target.value)}
                                placeholder={twitchCfg.has_token ? '(gespeichert)' : 'oauth:xxxxxx'}
                                style={{ flex: 1, padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                            {oauthInput && <button className="btn btn-primary" style={{ fontSize: 12 }}
                                onClick={() => { saveTwitch({ oauth_token: oauthInput }); setOauthInput(''); toast('Token gespeichert!', 'success'); }}>
                                Speichern</button>}
                        </div>
                        <small style={{ color: 'var(--text-dim)', fontSize: 11 }}>
                            Hol dir deinen Token: <a href="https://twitchapps.com/tmi/" target="_blank" style={{ color: 'var(--accent)' }}>twitchapps.com/tmi</a>
                        </small>
                    </div>
                    <div style={{ display: 'flex', gap: 6, marginBottom: 12 }}>
                        {!twitchStatus.connected ? (
                            <button className="btn btn-primary" onClick={async () => {
                                const r = await API.post('/api/twitch/connect');
                                if (r?.success) { setTwitchStatus({ connected: true, channel: twitchCfg.channel }); toast('Twitch verbunden!', 'success'); }
                                else toast('Verbindung fehlgeschlagen', 'error');
                            }}>üîó Verbinden</button>
                        ) : (
                            <button className="btn" onClick={async () => {
                                await API.post('/api/twitch/disconnect');
                                setTwitchStatus({ connected: false });
                            }}>‚õì Trennen</button>
                        )}
                        {twitchStatus.connected && (
                            <button className="btn" onClick={async () => {
                                const r = await API.post('/api/twitch/test');
                                if (r?.success) toast('Testnachricht gesendet!', 'success');
                            }}>üß™ Test</button>
                        )}
                    </div>

                    {/* Alert toggles */}
                    <div style={{ fontSize: 13, color: 'var(--text-dim)', marginBottom: 6 }}>Events die gepostet werden:</div>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                        {['180', 'match_won', 'game_won', 'busted', 'high_score', 'bullseye', 'achievement'].map(evt => (
                            <label key={evt} style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '4px 8px', background: 'var(--bg)', borderRadius: 4, cursor: 'pointer', fontSize: 12 }}>
                                <input type="checkbox" checked={twitchCfg.alerts?.[evt] !== undefined}
                                    onChange={e => {
                                        const alerts = { ...(twitchCfg.alerts || {}) };
                                        if (!e.target.checked) delete alerts[evt];
                                        else alerts[evt] = alerts[evt] || `{player} ‚Äî ${evt}`;
                                        saveTwitch({ alerts });
                                    }}
                                    style={{ accentColor: 'var(--accent)' }} />
                                {evt}
                            </label>
                        ))}
                    </div>
                </>}
            </div>

            {/* ‚ïê‚ïê‚ïê DISCORD ‚ïê‚ïê‚ïê */}
            <div className="card" style={{ padding: 16, marginBottom: 16 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 }}>
                    <span style={{ fontSize: 28 }}>üí¨</span>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 700, fontSize: 16 }}>Discord Webhook</div>
                        <div style={{ fontSize: 12, color: discordCfg.has_webhook ? 'var(--success)' : 'var(--text-dim)' }}>
                            {discordCfg.has_webhook ? '‚úì Webhook konfiguriert' : 'Nicht konfiguriert'}
                        </div>
                    </div>
                    <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                        <span style={{ fontSize: 13, color: discordCfg.enabled ? 'var(--accent)' : 'var(--text-dim)' }}>
                            {discordCfg.enabled ? 'Aktiv' : 'Aus'}
                        </span>
                        <input type="checkbox" checked={discordCfg.enabled || false}
                            onChange={e => saveDiscord({ enabled: e.target.checked })}
                            style={{ accentColor: 'var(--accent)', width: 18, height: 18 }} />
                    </label>
                </div>

                {discordCfg.enabled && <>
                    <div style={{ marginBottom: 12 }}>
                        <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Webhook URL</label>
                        <div style={{ display: 'flex', gap: 6 }}>
                            <input type="url" value={webhookInput} onChange={e => setWebhookInput(e.target.value)}
                                placeholder={discordCfg.has_webhook ? discordCfg.webhook_url_display : 'https://discord.com/api/webhooks/...'}
                                style={{ flex: 1, padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4, fontSize: 12 }} />
                            {webhookInput && <button className="btn btn-primary" style={{ fontSize: 12 }}
                                onClick={() => { saveDiscord({ webhook_url: webhookInput }); setWebhookInput(''); toast('Webhook gespeichert!', 'success'); }}>
                                Speichern</button>}
                        </div>
                        <small style={{ color: 'var(--text-dim)', fontSize: 11 }}>
                            Discord ‚Üí Server Settings ‚Üí Integrations ‚Üí Webhooks ‚Üí New Webhook ‚Üí Copy URL
                        </small>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10, marginBottom: 12 }}>
                        <div>
                            <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Bot Name</label>
                            <input type="text" value={discordCfg.bot_name || 'ThrowSync'} onChange={e => saveDiscord({ bot_name: e.target.value })}
                                style={{ width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                        </div>
                        <div>
                            <label style={{ fontSize: 12, color: 'var(--text-dim)' }}>Min. High Score</label>
                            <input type="number" value={discordCfg.min_high_score || 100} onChange={e => saveDiscord({ min_high_score: parseInt(e.target.value) || 100 })}
                                style={{ width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)', border: '1px solid var(--border)', borderRadius: 4 }} />
                        </div>
                    </div>

                    <button className="btn" onClick={async () => {
                        const r = await API.post('/api/discord/test');
                        if (r?.success) toast('Test-Embed gesendet!', 'success');
                        else toast('Fehler ‚Äî Webhook pr√ºfen', 'error');
                    }} style={{ marginBottom: 12 }}>üß™ Test-Nachricht senden</button>

                    <div style={{ fontSize: 13, color: 'var(--text-dim)', marginBottom: 6 }}>Events die gepostet werden:</div>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                        {[
                            { key: 'post_180', label: 'üî• 180' },
                            { key: 'post_match_won', label: 'üèÜ Match Won' },
                            { key: 'post_game_won', label: '‚úÖ Leg Won' },
                            { key: 'post_busted', label: 'üí• Bust' },
                            { key: 'post_high_score', label: 'üí™ High Score' },
                            { key: 'post_achievements', label: 'üèÖ Achievements' },
                        ].map(evt => (
                            <label key={evt.key} style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '4px 8px', background: 'var(--bg)', borderRadius: 4, cursor: 'pointer', fontSize: 12 }}>
                                <input type="checkbox" checked={discordCfg[evt.key] !== false}
                                    onChange={e => saveDiscord({ [evt.key]: e.target.checked })}
                                    style={{ accentColor: 'var(--accent)' }} />
                                {evt.label}
                            </label>
                        ))}
                    </div>
                </>}
            </div>

            {/* ‚ïê‚ïê‚ïê OBS ‚ïê‚ïê‚ïê */}
            <div className="card" style={{ padding: 16 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 }}>
                    <span style={{ fontSize: 28 }}>üé•</span>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 700, fontSize: 16 }}>OBS Browser Source</div>
                        <div style={{ fontSize: 12, color: 'var(--text-dim)' }}>Transparentes Overlay f√ºr deinen Stream</div>
                    </div>
                </div>
                <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                    <button className="btn btn-primary" onClick={() => {
                        navigator.clipboard.writeText(window.location.origin + '/display');
                        toast('URL kopiert!', 'success');
                    }}>üìã Display URL kopieren</button>
                    <button className="btn" onClick={() => {
                        navigator.clipboard.writeText(window.location.origin + '/lobby');
                        toast('URL kopiert!', 'success');
                    }}>üè† Lobby URL kopieren</button>
                    <button className="btn" onClick={() => window.open('/display', '_blank')}>üëÅ Vorschau</button>
                </div>
                <div style={{ marginTop: 8, fontSize: 12, color: 'var(--text-dim)', padding: 10, background: 'var(--bg)', borderRadius: 6 }}>
                    <strong>OBS Setup:</strong> Quellen ‚Üí + ‚Üí Browser ‚Üí URL: <code>{window.location.origin}/display</code> ‚Üí Breite: 1920 ‚Üí H√∂he: 1080 ‚Üí ‚úì Transparenter Hintergrund
                </div>
            </div>

            {/* ‚ïê‚ïê‚ïê CUSTOM WEBHOOKS ‚ïê‚ïê‚ïê */}
            <div className="card" style={{ padding: 16, marginTop: 16 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 }}>
                    <span style={{ fontSize: 28 }}>üåê</span>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 700, fontSize: 16 }}>Custom Webhooks</div>
                        <div style={{ fontSize: 12, color: 'var(--text-dim)' }}>
                            HTTP POST bei Game-Events ‚Äî f√ºr Zapier, IFTTT, Home Assistant, n8n, Make.com u.v.m.
                        </div>
                    </div>
                    <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                        <span style={{ fontSize: 13, color: whConfig.enabled ? 'var(--accent)' : 'var(--text-dim)' }}>
                            {whConfig.enabled ? 'Aktiv' : 'Aus'}
                        </span>
                        <input type="checkbox" checked={whConfig.enabled || false}
                            onChange={e => saveWebhooks({ enabled: e.target.checked })}
                            style={{ accentColor: 'var(--accent)', width: 18, height: 18 }} />
                    </label>
                </div>

                {whConfig.enabled && <>
                    {/* Webhook List */}
                    {whConfig.webhooks.map(wh => (
                        <div key={wh.id} style={{
                            border: '1px solid var(--border)', borderRadius: 10, padding: 14, marginBottom: 12,
                            background: wh.enabled ? 'var(--bg-card)' : 'rgba(0,0,0,0.2)',
                            opacity: wh.enabled ? 1 : 0.6,
                        }}>
                            {/* Header */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>
                                <input type="text" value={wh.name} onChange={e => updateWebhook(wh.id, { name: e.target.value })}
                                    style={{ flex: 1, background: 'transparent', border: 'none', color: 'var(--text)', fontWeight: 600, fontSize: 14, outline: 'none' }}
                                    placeholder="Webhook Name" />
                                <label style={{ display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer', fontSize: 12 }}>
                                    <input type="checkbox" checked={wh.enabled}
                                        onChange={e => updateWebhook(wh.id, { enabled: e.target.checked })}
                                        style={{ accentColor: 'var(--accent)' }} />
                                    Aktiv
                                </label>
                                {wh.last_status && (
                                    <span style={{
                                        fontSize: 11, padding: '2px 8px', borderRadius: 999,
                                        background: typeof wh.last_status === 'number' && wh.last_status < 300 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)',
                                        color: typeof wh.last_status === 'number' && wh.last_status < 300 ? 'var(--success)' : '#ef4444',
                                    }}>
                                        {wh.last_status}
                                    </span>
                                )}
                            </div>

                            {/* URL */}
                            <div style={{ marginBottom: 8 }}>
                                <input type="url" value={wh.url} onChange={e => updateWebhook(wh.id, { url: e.target.value })}
                                    placeholder="https://hooks.zapier.com/... oder http://homeassistant:8123/api/..."
                                    style={{ width: '100%', padding: '6px 10px', background: 'var(--bg-input)', color: 'var(--text)',
                                        border: '1px solid var(--border)', borderRadius: 6, fontSize: 13, fontFamily: 'JetBrains Mono, monospace' }} />
                            </div>

                            {/* Events */}
                            <div style={{ marginBottom: 8 }}>
                                <div style={{ fontSize: 12, color: 'var(--text-dim)', marginBottom: 4, fontWeight: 500 }}>Events:</div>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: 4 }}>
                                    {Object.entries(whConfig.available_events || {}).map(([key, ev]) => {
                                        const active = (wh.events || []).includes(key);
                                        return (
                                            <button key={key} onClick={() => {
                                                const events = active ? wh.events.filter(e => e !== key) : [...(wh.events || []), key];
                                                updateWebhook(wh.id, { events });
                                            }} style={{
                                                padding: '3px 8px', borderRadius: 999, fontSize: 11, cursor: 'pointer',
                                                border: active ? '1px solid var(--accent)' : '1px solid var(--border)',
                                                background: active ? 'rgba(139,92,246,0.15)' : 'transparent',
                                                color: active ? 'var(--accent)' : 'var(--text-dim)',
                                            }}>
                                                {ev.icon} {ev.label}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Advanced: Secret + Headers */}
                            <details style={{ fontSize: 12, color: 'var(--text-dim)', marginBottom: 8 }}>
                                <summary style={{ cursor: 'pointer', marginBottom: 6 }}>Erweitert</summary>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                                    <div>
                                        <label style={{ fontSize: 11, color: 'var(--text-dim)' }}>HMAC Secret (optional)</label>
                                        <input type="text" value={wh.secret || ''} onChange={e => updateWebhook(wh.id, { secret: e.target.value })}
                                            placeholder="F√ºr Signatur-Verifikation"
                                            style={{ width: '100%', padding: '4px 8px', background: 'var(--bg-input)', color: 'var(--text)',
                                                border: '1px solid var(--border)', borderRadius: 4, fontSize: 12 }} />
                                    </div>
                                    <div>
                                        <label style={{ fontSize: 11, color: 'var(--text-dim)' }}>Custom Header (optional)</label>
                                        <input type="text" value={Object.entries(wh.headers || {}).map(([k,v]) => k+': '+v).join(', ')}
                                            onChange={e => {
                                                const headers = {};
                                                e.target.value.split(',').forEach(h => {
                                                    const [k, ...v] = h.split(':');
                                                    if (k?.trim() && v.length) headers[k.trim()] = v.join(':').trim();
                                                });
                                                updateWebhook(wh.id, { headers });
                                            }}
                                            placeholder="Authorization: Bearer xxx"
                                            style={{ width: '100%', padding: '4px 8px', background: 'var(--bg-input)', color: 'var(--text)',
                                                border: '1px solid var(--border)', borderRadius: 4, fontSize: 12 }} />
                                    </div>
                                </div>
                            </details>

                            {/* Actions */}
                            <div style={{ display: 'flex', gap: 6 }}>
                                <button className="btn" style={{ fontSize: 11, padding: '4px 10px' }}
                                    onClick={() => testWebhook(wh.id)} disabled={!wh.url}>
                                    üß™ Testen
                                </button>
                                <button className="btn" style={{ fontSize: 11, padding: '4px 10px', color: '#ef4444' }}
                                    onClick={() => removeWebhook(wh.id)}>
                                    üóë Entfernen
                                </button>
                                {wh.last_sent && (
                                    <span style={{ fontSize: 11, color: 'var(--text-dim)', marginLeft: 'auto', alignSelf: 'center' }}>
                                        Letzter: {new Date(wh.last_sent).toLocaleString('de-DE')}
                                    </span>
                                )}
                            </div>
                        </div>
                    ))}

                    {/* Add Webhook Button */}
                    <button className="btn" onClick={addWebhook} style={{ width: '100%', padding: 10, borderStyle: 'dashed' }}>
                        + Webhook hinzuf√ºgen
                    </button>

                    {/* Example Payloads */}
                    {whConfig.webhooks.length === 0 && (
                        <div style={{ marginTop: 12, padding: 12, background: 'var(--bg)', borderRadius: 8, fontSize: 12 }}>
                            <div style={{ fontWeight: 600, marginBottom: 6 }}>Beispiel JSON-Payload:</div>
                            <code style={{ fontSize: 11, lineHeight: 1.5, display: 'block', whiteSpace: 'pre', color: 'var(--text-dim)' }}>
{`{
  "event": "180",
  "timestamp": "2026-02-21T12:00:00Z",
  "source": "ThrowSync",
  "player": "angljack",
  "score": 180
}`}
                            </code>
                        </div>
                    )}
                </>}
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Achievements Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function AchievementsPage() {
    const [allAchievements, setAll] = useState([]);
    const [profiles, setProfiles] = useState([]);
    const [selectedId, setSelectedId] = useState('');
    const { t } = useI18n();

    useEffect(() => {
        API.get('/api/achievements').then(d => setAll(d?.achievements || []));
        API.get('/api/profiles/players').then(d => {
            const p = d?.profiles || [];
            setProfiles(p);
            if (p.length > 0) setSelectedId(p[0].id);
        });
    }, []);

    const selectedProfile = profiles.find(p => p.id === selectedId);
    const unlocked = selectedProfile?.achievements || [];
    const unlockedCount = unlocked.length;
    const totalCount = allAchievements.length;
    const progress = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;

    const categories = [
        { id: 'score', label: '\uD83C\uDFAF Score', desc: 'Punkte und W√ºrfe' },
        { id: 'wins', label: '\uD83C\uDFC6 Siege', desc: 'Legs und Matches' },
        { id: 'checkout', label: '\u2705 Checkout', desc: 'Finishes' },
        { id: 'grind', label: '\uD83C\uDFAE Ausdauer', desc: 'Spielzeit' },
    ];

    const tierStyle = {
        bronze: { bg: 'rgba(205,127,50,0.15)', border: '#cd7f32' },
        silver: { bg: 'rgba(192,192,192,0.15)', border: '#c0c0c0' },
        gold: { bg: 'rgba(255,215,0,0.15)', border: '#ffd700' },
        diamond: { bg: 'rgba(185,242,255,0.15)', border: '#b9f2ff' },
    };

    return (
        <div>
            <div className="page-header">
                <h2>\uD83C\uDFC5 Achievements</h2>
                <p>Schalte Badges frei durch dein Spiel</p>
            </div>

            {/* Player Selector */}
            <div className="card" style={{padding: 12, marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8}}>
                <span style={{fontSize: 13, color: 'var(--text-dim)'}}>Spieler:</span>
                {profiles.map(p => (
                    <button key={p.id} className={'btn ' + (selectedId === p.id ? 'btn-primary' : '')}
                        style={{fontSize: 12, padding: '4px 10px'}}
                        onClick={() => setSelectedId(p.id)}>
                        {p.avatar} {p.name}
                    </button>
                ))}
            </div>

            {/* Progress Bar */}
            {selectedProfile && (
                <div className="card" style={{padding: 16, marginBottom: 16}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 8}}>
                        <span style={{fontWeight: 600}}>{selectedProfile.avatar} {selectedProfile.name}</span>
                        <span style={{color: 'var(--accent)', fontWeight: 700}}>{unlockedCount}/{totalCount} ({progress}%)</span>
                    </div>
                    <div style={{height: 8, background: 'var(--bg)', borderRadius: 4, overflow: 'hidden'}}>
                        <div style={{height: '100%', width: `${progress}%`, background: 'linear-gradient(90deg, #8b5cf6, #3b82f6)', borderRadius: 4, transition: 'width 0.5s ease'}} />
                    </div>
                </div>
            )}

            {profiles.length === 0 && (
                <div className="card" style={{padding: 32, textAlign: 'center', color: 'var(--text-dim)'}}>
                    <div style={{fontSize: 48, marginBottom: 12}}>\uD83C\uDFC5</div>
                    <p>Erstelle zuerst ein Spieler-Profil.</p>
                </div>
            )}

            {/* Achievement Categories */}
            {selectedProfile && categories.map(cat => {
                const catAchs = allAchievements.filter(a => a.category === cat.id);
                if (catAchs.length === 0) return null;
                return (
                    <div key={cat.id} className="card" style={{padding: 16, marginBottom: 12}}>
                        <h4 style={{margin: '0 0 4px'}}>{cat.label}</h4>
                        <small style={{color: 'var(--text-dim)', display: 'block', marginBottom: 12}}>{cat.desc}</small>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(240px, 1fr))', gap: 8}}>
                            {catAchs.map(a => {
                                const isUnlocked = unlocked.includes(a.id);
                                const ts = tierStyle[a.tier] || tierStyle.bronze;
                                return (
                                    <div key={a.id} style={{
                                        display: 'flex', alignItems: 'center', gap: 10, padding: '10px 12px',
                                        borderRadius: 8,
                                        background: isUnlocked ? ts.bg : 'rgba(255,255,255,0.02)',
                                        border: `1px solid ${isUnlocked ? ts.border : 'var(--border)'}`,
                                        opacity: isUnlocked ? 1 : 0.4,
                                    }}>
                                        <span style={{fontSize: 28, filter: isUnlocked ? 'none' : 'grayscale(1)'}}>{a.icon}</span>
                                        <div>
                                            <div style={{fontWeight: 600, fontSize: 13}}>{a.name}</div>
                                            <div style={{fontSize: 11, color: isUnlocked ? ts.border : 'var(--text-dim)'}}>
                                                {a.desc}
                                            </div>
                                            <span style={{
                                                fontSize: 9, fontWeight: 700, textTransform: 'uppercase',
                                                color: isUnlocked ? ts.border : '#555', letterSpacing: 1,
                                            }}>{a.tier}</span>
                                        </div>
                                        {isUnlocked && <span style={{marginLeft: 'auto', fontSize: 16}}>‚úì</span>}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Music Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function MusicPage() {
    const m = useMusicPlayer();
    const [uploading, setUploading] = useState(false);
    const [spotifyCfg, setSpotifyCfg] = useState({ enabled: false, client_id: '', connected: false });
    const toast = useToast();
    const { t } = useI18n();

    useEffect(() => {
        API.get('/api/music/files').then(d => m.setMusicFiles(d?.files || []));
        API.get('/api/spotify/config').then(d => { if (d) setSpotifyCfg(d); });
    }, []);

    const uploadMusic = async (e) => {
        const files = e.target.files;
        if (!files?.length) return;
        setUploading(true);
        for (const file of files) {
            const fd = new FormData();
            fd.append('file', file);
            await fetch('/api/music/upload', { method: 'POST', body: fd });
        }
        setUploading(false);
        API.get('/api/music/files').then(d => m.setMusicFiles(d?.files || []));
        toast(files.length + ' Datei(en) hochgeladen', 'success');
    };

    const deleteFile = async (filename) => {
        await API.del('/api/music/files/' + encodeURIComponent(filename));
        m.setMusicFiles(f => f.filter(x => x.filename !== filename));
        m.setPlaylist(p => p.filter(x => x !== filename));
    };

    const addToPlaylist = (filename) => {
        if (m.playlist.includes(filename)) return;
        const next = [...m.playlist, filename];
        m.setPlaylist(next);
        m.saveConfig({ playlist: next });
    };

    const removeFromPlaylist = (filename) => {
        const next = m.playlist.filter(x => x !== filename);
        m.setPlaylist(next);
        m.saveConfig({ playlist: next });
    };

    const formatSize = (bytes) => {
        if (bytes > 1024*1024) return (bytes / (1024*1024)).toFixed(1) + ' MB';
        return (bytes / 1024).toFixed(0) + ' KB';
    };

    // Spotify helpers
    const saveSpotifyCfg = (updates) => {
        const next = { ...spotifyCfg, ...updates };
        setSpotifyCfg(next);
        API.post('/api/spotify/config', next);
    };

    const connectSpotify = async () => {
        const res = await API.get('/api/spotify/auth-url');
        if (res?.url) window.open(res.url, '_blank', 'width=500,height=700');
        // Poll for connection
        const poll = setInterval(async () => {
            const cfg = await API.get('/api/spotify/config');
            if (cfg?.connected) {
                clearInterval(poll);
                setSpotifyCfg(cfg);
                m.setSource('spotify');
                m.pollSpotify();
                toast('Spotify verbunden!', 'success');
            }
        }, 2000);
        setTimeout(() => clearInterval(poll), 60000);
    };

    const disconnectSpotify = async () => {
        await API.post('/api/spotify/disconnect');
        setSpotifyCfg(s => ({ ...s, connected: false }));
        m.setSource('local');
        toast('Spotify getrennt', 'success');
    };

    return (
        <div>
            <div className="page-header">
                <h2>{'\uD83C\uDFB5'} {t('nav.music', 'Musik-Player')}</h2>
                <p>Hintergrundmusik - spielt weiter beim Seitenwechsel</p>
            </div>

            {/* Source Selector */}
            <div className="card" style={{padding: 12, marginBottom: 12, display: 'flex', gap: 8}}>
                <button className={'btn ' + (m.source === 'local' ? 'btn-primary' : '')}
                    onClick={() => { m.setSource('local'); }}
                    style={{flex: 1}}>
                    {'\uD83D\uDCBE'} Lokale Musik
                </button>
                <button className={'btn ' + (m.source === 'spotify' ? 'btn-primary' : '')}
                    onClick={() => { if (spotifyCfg.connected) { m.setSource('spotify'); m.pollSpotify(); } }}
                    style={{flex: 1, opacity: spotifyCfg.connected ? 1 : 0.5}}
                    disabled={!spotifyCfg.connected}>
                    {'\uD83C\uDFB5'} Spotify {spotifyCfg.connected ? '' : '(nicht verbunden)'}
                </button>
            </div>

            {/* Spotify Section */}
            <div className="card" style={{padding: 16, marginBottom: 12}}>
                <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12}}>
                    <h4 style={{margin: 0}}>{'\uD83C\uDFB5'} Spotify Integration</h4>
                    <span style={{fontSize: 12, color: spotifyCfg.connected ? 'var(--success)' : 'var(--text-dim)'}}>
                        {spotifyCfg.connected ? '\u2022 Verbunden' : '\u2022 Nicht verbunden'}
                    </span>
                </div>

                {!spotifyCfg.connected ? (
                    <div>
                        <div style={{marginBottom: 16}}>
                            <label style={{fontSize: 13, fontWeight: 500}}>Spotify Client ID</label>
                            <div style={{display: 'flex', gap: 8, marginTop: 4}}>
                                <input type="text" value={spotifyCfg.client_id || ''}
                                    onChange={e => saveSpotifyCfg({ client_id: e.target.value })}
                                    placeholder="z.B. a1b2c3d4e5f6..."
                                    className="form-input" style={{flex: 1, fontFamily: 'JetBrains Mono, monospace', fontSize: 13}} />
                                <button className="btn btn-primary" onClick={connectSpotify}
                                    disabled={!spotifyCfg.client_id}>
                                    {'\uD83D\uDD17'} Verbinden
                                </button>
                            </div>
                        </div>

                        <details style={{fontSize: 13, color: 'var(--text-dim)'}}>
                            <summary style={{cursor: 'pointer', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 8}}>
                                {'\uD83D\uDCD6'} Anleitung: Spotify App erstellen (einmalig, 2 Min.)
                            </summary>
                            <div style={{paddingLeft: 8, display: 'flex', flexDirection: 'column', gap: 10, lineHeight: 1.5}}>
                                <div>
                                    <strong>1.</strong> √ñffne{' '}
                                    <a href="https://developer.spotify.com/dashboard" target="_blank"
                                        style={{color: '#1ed760'}}>developer.spotify.com/dashboard</a>{' '}
                                    und logge dich mit deinem Spotify-Konto ein.
                                </div>
                                <div>
                                    <strong>2.</strong> Klicke auf <strong>Create App</strong>. Name und Beschreibung sind egal (z.B. "ThrowSync").
                                </div>
                                <div>
                                    <strong>3.</strong> Bei <strong>Redirect URI</strong> trage ein:{' '}
                                    <code style={{
                                        fontSize: 12, background: 'rgba(139,92,246,0.15)', padding: '2px 6px',
                                        borderRadius: 4, cursor: 'pointer', userSelect: 'all',
                                    }} onClick={e => { navigator.clipboard.writeText(window.location.origin + '/api/spotify/callback'); toast('Kopiert!', 'success'); }}>
                                        {window.location.origin}/api/spotify/callback
                                    </code>
                                    <span style={{fontSize: 11, marginLeft: 4}}>(klicken zum Kopieren)</span>
                                </div>
                                <div>
                                    <strong>4.</strong> W√§hle <strong>Web API</strong> als API-Zugriff und speichere.
                                </div>
                                <div>
                                    <strong>5.</strong> Kopiere die <strong>Client ID</strong> von der App-√úbersicht und f√ºge sie oben ein.
                                </div>
                            </div>
                        </details>
                    </div>
                ) : (
                    <div>
                        {/* Spotify Now Playing */}
                        <div style={{display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12}}>
                            <div style={{width: 56, height: 56, borderRadius: 8, background: 'var(--bg-card)', overflow: 'hidden', flexShrink: 0}}>
                                {m.spotifyState.album_art ? <img src={m.spotifyState.album_art} style={{width:'100%',height:'100%',objectFit:'cover'}} /> :
                                    <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100%',fontSize:28}}>{'\uD83C\uDFB5'}</div>}
                            </div>
                            <div style={{flex: 1, minWidth: 0}}>
                                <div style={{fontWeight: 600, fontSize: 15, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                    {m.spotifyState.track || 'Nichts l√§uft'}
                                </div>
                                <div style={{fontSize: 12, color: 'var(--text-dim)'}}>
                                    {m.spotifyState.artist}
                                    {m.spotifyState.device && <span> {'\u00B7'} {m.spotifyState.device}</span>}
                                </div>
                            </div>
                        </div>
                        <div style={{display: 'flex', gap: 8}}>
                            <button className="btn" style={{fontSize: 11}} onClick={disconnectSpotify}>Trennen</button>
                        </div>
                    </div>
                )}
            </div>

            {/* Transport Controls (unified) */}
            <div className="card" style={{padding: 16, marginBottom: 12, background: m.isPlaying ? 'linear-gradient(135deg, rgba(139,92,246,0.12), rgba(59,130,246,0.06))' : 'var(--bg-card)'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 12}}>
                    <div style={{fontSize: 36}}>{m.isPlaying ? '\uD83C\uDFB6' : '\uD83C\uDFB5'}</div>
                    <div style={{flex: 1}}>
                        <div style={{fontWeight: 600, fontSize: 15}}>
                            {m.currentTrack ? (m.source === 'spotify' ? m.spotifyState.track : m.currentTrack.replace(/\.[^.]+$/, '')) : 'Kein Track ausgew√§hlt'}
                        </div>
                        <div style={{fontSize: 12, color: 'var(--text-dim)'}}>
                            {m.isPlaying ? '\u25B6 Spielt...' : '\u23F8 Pausiert'}
                            {m.source === 'local' && m.playlist.length > 0 && ' \u00B7 ' + m.playlist.length + ' in Playlist'}
                            {' \u00B7 '}<span style={{color: m.source === 'spotify' ? '#1ed760' : 'var(--accent)'}}>{m.source === 'spotify' ? 'Spotify' : 'Lokal'}</span>
                        </div>
                    </div>
                </div>

                <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, marginTop: 12}}>
                    <button onClick={() => { m.setShuffle(!m.shuffle); m.saveConfig({ shuffle: !m.shuffle }); }}
                        className="btn" style={{fontSize: 16, padding: '4px 8px', opacity: m.shuffle ? 1 : 0.4}}>üîÄ</button>
                    <button onClick={m.skipPrev} className="btn" style={{fontSize: 18, padding: '4px 10px'}}>{'\u23EE'}</button>
                    <button onClick={m.togglePlay} className="btn btn-primary" style={{fontSize: 22, padding: '6px 16px', borderRadius: 999}}>
                        {m.isPlaying ? '\u23F8' : '\u25B6'}
                    </button>
                    <button onClick={m.skipNext} className="btn" style={{fontSize: 18, padding: '4px 10px'}}>{'\u23ED'}</button>
                    <button onClick={() => { m.setRepeat(!m.repeat); m.saveConfig({ repeat: !m.repeat }); }}
                        className="btn" style={{fontSize: 16, padding: '4px 8px', opacity: m.repeat ? 1 : 0.4}}>üîÅ</button>
                </div>

                <div style={{display: 'flex', alignItems: 'center', gap: 8, marginTop: 10}}>
                    <span style={{fontSize: 14}}>{'\uD83D\uDD08'}</span>
                    <input type="range" min="0" max="1" step="0.05" value={m.volume}
                        onChange={e => m.changeVolume(parseFloat(e.target.value))}
                        style={{flex: 1, accentColor: 'var(--accent)'}} />
                    <span style={{fontFamily: 'monospace', fontSize: 12, minWidth: 32}}>{Math.round(m.volume * 100)}%</span>
                </div>

                <div style={{marginTop: 10, paddingTop: 10, borderTop: '1px solid var(--border)', display: 'flex', alignItems: 'center', gap: 8}}>
                    <label style={{display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer', fontSize: 13}}>
                        <input type="checkbox" checked={m.duckOnEvent}
                            onChange={e => { m.setDuckOnEvent(e.target.checked); m.saveConfig({ duck_on_event: e.target.checked }); }}
                            style={{accentColor: 'var(--accent)'}} />
                        Musik leiser bei Caller/Crowd
                    </label>
                    {m.duckOnEvent && (
                        <>
                        <input type="range" min="0" max="0.5" step="0.05" value={m.duckLevel}
                            onChange={e => { m.setDuckLevel(parseFloat(e.target.value)); m.saveConfig({ duck_level: parseFloat(e.target.value) }); }}
                            style={{width: 80, accentColor: 'var(--accent)'}} />
                        <span style={{fontFamily: 'monospace', fontSize: 11, color: 'var(--text-dim)'}}>{Math.round(m.duckLevel * 100)}%</span>
                        </>
                    )}
                </div>
            </div>

            {/* Local Files (only when source is local) */}
            {m.source === 'local' && (
                <>
                    <div className="card" style={{padding: 16, marginBottom: 12}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                            <label className="btn btn-primary" style={{cursor: 'pointer'}}>
                                {uploading ? '\u23F3 Hochladen...' : '\uD83D\uDCC1 Musik hochladen'}
                                <input type="file" accept=".mp3,.m4a,.ogg,.wav,.flac,.aac" multiple
                                    onChange={uploadMusic} style={{display: 'none'}} />
                            </label>
                            <span style={{fontSize: 12, color: 'var(--text-dim)'}}>MP3, M4A, OGG, WAV, FLAC, AAC</span>
                        </div>
                    </div>

                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12}}>
                        <div className="card" style={{padding: 16}}>
                            <h4 style={{margin: '0 0 10px'}}>{'\uD83D\uDCC2'} Musikdateien ({m.musicFiles.length})</h4>
                            <div style={{display: 'flex', flexDirection: 'column', gap: 4, maxHeight: 400, overflow: 'auto'}}>
                                {m.musicFiles.map(f => (
                                    <div key={f.filename} style={{
                                        display: 'flex', alignItems: 'center', gap: 6, padding: '6px 8px',
                                        background: m.currentTrack === f.filename ? 'rgba(139,92,246,0.12)' : 'transparent',
                                        borderRadius: 4, border: '1px solid var(--border)',
                                    }}>
                                        <button onClick={() => m.playTrack(f.filename)} style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: 14, color: 'var(--accent)'}}>
                                            {m.currentTrack === f.filename && m.isPlaying ? '\u23F8' : '\u25B6'}
                                        </button>
                                        <div style={{flex: 1, fontSize: 13, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {f.filename.replace(/\.[^.]+$/, '')}
                                        </div>
                                        <span style={{fontSize: 11, color: 'var(--text-dim)'}}>{formatSize(f.size)}</span>
                                        <button onClick={() => addToPlaylist(f.filename)}
                                            style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: 12, color: m.playlist.includes(f.filename) ? 'var(--success)' : 'var(--text-dim)'}}>
                                            {m.playlist.includes(f.filename) ? '\u2713' : '+'}
                                        </button>
                                        <button onClick={() => deleteFile(f.filename)}
                                            style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: 12, color: '#f44'}}>{'\u2715'}</button>
                                    </div>
                                ))}
                                {m.musicFiles.length === 0 && (
                                    <div style={{textAlign: 'center', color: 'var(--text-dim)', padding: 20, fontSize: 13}}>
                                        Keine Musikdateien. Lade oben Dateien hoch.
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="card" style={{padding: 16}}>
                            <h4 style={{margin: '0 0 10px'}}>{'\uD83C\uDFB6'} Playlist ({m.playlist.length})</h4>
                            <div style={{display: 'flex', flexDirection: 'column', gap: 4, maxHeight: 400, overflow: 'auto'}}>
                                {m.playlist.map((filename, idx) => (
                                    <div key={filename + idx} style={{
                                        display: 'flex', alignItems: 'center', gap: 6, padding: '6px 8px',
                                        background: m.currentTrack === filename ? 'rgba(139,92,246,0.12)' : 'transparent',
                                        borderRadius: 4, border: '1px solid var(--border)',
                                    }}>
                                        <span style={{fontSize: 11, color: 'var(--text-dim)', minWidth: 16}}>{idx + 1}.</span>
                                        <button onClick={() => m.playTrack(filename)} style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: 14, color: 'var(--accent)'}}>
                                            {m.currentTrack === filename && m.isPlaying ? '\u23F8' : '\u25B6'}
                                        </button>
                                        <div style={{flex: 1, fontSize: 13, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                            {filename.replace(/\.[^.]+$/, '')}
                                        </div>
                                        <button onClick={() => removeFromPlaylist(filename)}
                                            style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: 12, color: '#f44'}}>{'\u2715'}</button>
                                    </div>
                                ))}
                                {m.playlist.length === 0 && (
                                    <div style={{textAlign: 'center', color: 'var(--text-dim)', padding: 20, fontSize: 13}}>
                                        Leer ‚Äî klicke "+" bei Musikdateien um Songs hinzuzuf√ºgen.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Logs & Debug ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function LogsPage() {
    const [tab, setTab] = useState('logs');
    const [logs, setLogs] = useState([]);
    const [bugs, setBugs] = useState([]);
    const [autoScroll, setAutoScroll] = useState(true);
    const [levelFilter, setLevelFilter] = useState('');
    const [searchFilter, setSearchFilter] = useState('');
    const [paused, setPaused] = useState(false);
    const [newBug, setNewBug] = useState({ title: '', description: '', priority: 'normal' });
    const [showNewBug, setShowNewBug] = useState(false);
    const [selectedBug, setSelectedBug] = useState(null);
    const lastIdRef = useRef(0);
    const logEndRef = useRef(null);
    const pollRef = useRef(null);
    const toast = useToast();

    // Load logs
    const fetchLogs = () => {
        if (paused) return;
        const params = new URLSearchParams();
        if (levelFilter) params.set('level', levelFilter);
        if (searchFilter) params.set('search', searchFilter);
        if (lastIdRef.current > 0) params.set('after_id', lastIdRef.current);
        params.set('limit', '500');
        API.get('/api/logs?' + params.toString()).then(d => {
            if (d?.entries?.length) {
                if (lastIdRef.current === 0) {
                    setLogs(d.entries);
                } else {
                    setLogs(prev => [...prev.slice(-1500), ...d.entries]);
                }
                lastIdRef.current = d.entries[d.entries.length - 1].id;
            } else if (lastIdRef.current === 0 && d?.entries) {
                setLogs(d.entries);
            }
        });
    };

    // Poll every 1.5s
    useEffect(() => {
        fetchLogs();
        pollRef.current = setInterval(fetchLogs, 1500);
        return () => clearInterval(pollRef.current);
    }, [levelFilter, searchFilter, paused]);

    // Reset when filter changes
    useEffect(() => {
        lastIdRef.current = 0;
        setLogs([]);
    }, [levelFilter, searchFilter]);

    // Auto-scroll
    useEffect(() => {
        if (autoScroll && logEndRef.current) {
            logEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
    }, [logs, autoScroll]);

    // Load bugs
    useEffect(() => {
        API.get('/api/bugs').then(d => setBugs(d?.bugs || []));
    }, []);

    const createBug = async () => {
        if (!newBug.title.trim()) return;
        const res = await API.post('/api/bugs', { ...newBug, attach_logs: true });
        if (res?.success) {
            setBugs(prev => [res.bug, ...prev]);
            setNewBug({ title: '', description: '', priority: 'normal' });
            setShowNewBug(false);
            toast('Bug-Report erstellt (inkl. Log-Snapshot)', 'success');
        }
    };

    const updateBug = async (id, data) => {
        const res = await API.put('/api/bugs/' + id, data);
        if (res?.success) {
            setBugs(prev => prev.map(b => b.id === id ? res.bug : b));
        }
    };

    const deleteBug = async (id) => {
        await API.del('/api/bugs/' + id);
        setBugs(prev => prev.filter(b => b.id !== id));
        if (selectedBug?.id === id) setSelectedBug(null);
        toast('Bug gel√∂scht', 'success');
    };

    const downloadLogs = () => {
        window.open('/api/logs/download', '_blank');
    };

    const levelColors = { DEBUG: '#666', INFO: '#3b82f6', WARNING: '#f59e0b', ERROR: '#ef4444', CRITICAL: '#dc2626' };
    const statusColors = { open: '#ef4444', in_progress: '#f59e0b', fixed: '#22c55e', closed: '#666' };
    const statusLabels = { open: 'Offen', in_progress: 'In Arbeit', fixed: 'Gefixt', closed: 'Geschlossen' };
    const prioColors = { low: '#666', normal: '#3b82f6', high: '#f59e0b', critical: '#ef4444' };

    const formatTime = (ts) => {
        const d = new Date(ts * 1000);
        return d.toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    };

    return (
        <div>
            <div className="page-header">
                <h2>{'\uD83D\uDCCB'} Logs & Debug</h2>
                <p>Live-Logs, Bug-Tracker und Diagnose</p>
            </div>

            {/* Tabs */}
            <div className="tabs" style={{marginBottom: 12}}>
                {[
                    { id: 'logs', label: '\uD83D\uDCDC Live-Logs' },
                    { id: 'bugs', label: '\uD83D\uDC1B Bug-Tracker (' + bugs.filter(b => b.status === 'open').length + ')' },
                ].map(t => (
                    <button key={t.id} className={'tab ' + (tab === t.id ? 'active' : '')}
                        onClick={() => setTab(t.id)}>{t.label}</button>
                ))}
            </div>

            {tab === 'logs' && (
                <>
                    {/* Log Controls */}
                    <div className="card" style={{padding: 12, marginBottom: 8, display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap'}}>
                        <select value={levelFilter} onChange={e => setLevelFilter(e.target.value)}
                            style={{padding: '4px 8px', background: 'var(--bg-input)', border: '1px solid var(--border)', borderRadius: 6, color: 'var(--text-primary)', fontSize: 12}}>
                            <option value="">Alle Level</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR,CRITICAL">ERROR+</option>
                        </select>
                        <input type="text" placeholder="Suche..." value={searchFilter}
                            onChange={e => setSearchFilter(e.target.value)}
                            style={{padding: '4px 8px', background: 'var(--bg-input)', border: '1px solid var(--border)', borderRadius: 6, color: 'var(--text-primary)', fontSize: 12, width: 200}} />
                        <button className={'btn btn-sm ' + (paused ? 'btn-primary' : '')} onClick={() => setPaused(!paused)}>
                            {paused ? '\u25B6 Weiter' : '\u23F8 Pause'}
                        </button>
                        <label style={{display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, cursor: 'pointer'}}>
                            <input type="checkbox" checked={autoScroll} onChange={e => setAutoScroll(e.target.checked)}
                                style={{accentColor: 'var(--accent)'}} />
                            Auto-Scroll
                        </label>
                        <div style={{flex: 1}} />
                        <span style={{fontSize: 11, color: 'var(--text-dim)'}}>{logs.length} Eintr√§ge</span>
                        <button className="btn btn-sm" onClick={downloadLogs}>{'\u2B07'} Download</button>
                        <button className="btn btn-sm" onClick={() => { lastIdRef.current = 0; setLogs([]); fetchLogs(); }}>
                            {'\u21BB'} Refresh
                        </button>
                    </div>

                    {/* Log Output */}
                    <div style={{
                        background: '#0d0d12', border: '1px solid var(--border)', borderRadius: 8,
                        fontFamily: "'JetBrains Mono', monospace", fontSize: 11, lineHeight: 1.6,
                        maxHeight: 'calc(100vh - 280px)', overflow: 'auto', padding: 8,
                    }}>
                        {logs.map(e => (
                            <div key={e.id} style={{
                                padding: '1px 4px', borderRadius: 2,
                                background: e.level === 'ERROR' || e.level === 'CRITICAL' ? 'rgba(239,68,68,0.08)' :
                                           e.level === 'WARNING' ? 'rgba(245,158,11,0.05)' : 'transparent',
                            }}>
                                <span style={{color: '#555', marginRight: 6}}>{e.time.split(' - ')[0].split(',')[0].split(' ')[1] || e.time.slice(11,19)}</span>
                                <span style={{color: levelColors[e.level] || '#888', fontWeight: e.level === 'ERROR' ? 700 : 400, marginRight: 6}}>
                                    [{e.level}]
                                </span>
                                <span style={{color: '#7c7c9a', marginRight: 6}}>{e.name}:</span>
                                <span style={{color: e.level === 'ERROR' ? '#fca5a5' : e.level === 'WARNING' ? '#fde68a' : '#c8c8d8'}}>
                                    {e.msg}
                                </span>
                            </div>
                        ))}
                        {logs.length === 0 && (
                            <div style={{textAlign: 'center', color: '#555', padding: 40}}>
                                {paused ? '\u23F8 Pausiert' : 'Warte auf Log-Eintr√§ge...'}
                            </div>
                        )}
                        <div ref={logEndRef} />
                    </div>
                </>
            )}

            {tab === 'bugs' && (
                <>
                    {/* New Bug Button */}
                    <div style={{display: 'flex', gap: 8, marginBottom: 12}}>
                        <button className="btn btn-primary" onClick={() => setShowNewBug(!showNewBug)}>
                            {showNewBug ? '\u2715 Abbrechen' : '+ Neuen Bug melden'}
                        </button>
                    </div>

                    {/* New Bug Form */}
                    {showNewBug && (
                        <div className="card" style={{padding: 16, marginBottom: 12}}>
                            <h4 style={{margin: '0 0 12px'}}>{'\uD83D\uDC1B'} Neuen Bug melden</h4>
                            <div style={{display: 'flex', flexDirection: 'column', gap: 8}}>
                                <input type="text" placeholder="Titel / Kurzbeschreibung"
                                    value={newBug.title} onChange={e => setNewBug(b => ({...b, title: e.target.value}))}
                                    className="form-input" style={{fontSize: 14}} />
                                <textarea placeholder="Beschreibung (was passiert, was erwartet, Schritte zum Reproduzieren)"
                                    value={newBug.description} onChange={e => setNewBug(b => ({...b, description: e.target.value}))}
                                    rows={4} className="form-input" style={{resize: 'vertical'}} />
                                <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
                                    <select value={newBug.priority} onChange={e => setNewBug(b => ({...b, priority: e.target.value}))}
                                        className="form-input" style={{width: 120}}>
                                        <option value="low">Niedrig</option>
                                        <option value="normal">Normal</option>
                                        <option value="high">Hoch</option>
                                        <option value="critical">Kritisch</option>
                                    </select>
                                    <span style={{fontSize: 11, color: 'var(--text-dim)'}}>
                                        {'\u2139\uFE0F'} Die letzten 50 Log-Eintr√§ge werden automatisch angeh√§ngt
                                    </span>
                                    <div style={{flex: 1}} />
                                    <button className="btn btn-primary" onClick={createBug} disabled={!newBug.title.trim()}>
                                        Bug erstellen
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Bug List */}
                    {bugs.length === 0 ? (
                        <div className="card" style={{padding: 40, textAlign: 'center', color: 'var(--text-dim)'}}>
                            {'\uD83C\uDF89'} Keine Bugs gemeldet!
                        </div>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: 8}}>
                            {bugs.map(b => (
                                <div key={b.id} className="card" style={{padding: 12, cursor: 'pointer',
                                    borderLeft: '3px solid ' + (prioColors[b.priority] || '#666'),
                                    opacity: b.status === 'closed' || b.status === 'fixed' ? 0.6 : 1,
                                }} onClick={() => setSelectedBug(selectedBug?.id === b.id ? null : b)}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                                        <span style={{
                                            fontSize: 10, padding: '2px 6px', borderRadius: 4, fontWeight: 600,
                                            background: statusColors[b.status] + '22', color: statusColors[b.status],
                                        }}>
                                            {statusLabels[b.status] || b.status}
                                        </span>
                                        <span style={{
                                            fontSize: 10, padding: '2px 6px', borderRadius: 4,
                                            background: prioColors[b.priority] + '22', color: prioColors[b.priority],
                                        }}>
                                            {b.priority}
                                        </span>
                                        <span style={{fontWeight: 600, fontSize: 14, flex: 1}}>{b.title}</span>
                                        <span style={{fontSize: 11, color: 'var(--text-dim)'}}>{formatTime(b.created_at)}</span>
                                    </div>

                                    {selectedBug?.id === b.id && (
                                        <div style={{marginTop: 12, paddingTop: 12, borderTop: '1px solid var(--border)'}}>
                                            {b.description && (
                                                <div style={{fontSize: 13, color: 'var(--text-secondary)', marginBottom: 12, whiteSpace: 'pre-wrap'}}>
                                                    {b.description}
                                                </div>
                                            )}
                                            <div style={{display: 'flex', gap: 6, flexWrap: 'wrap'}}>
                                                <select value={b.status} onChange={e => { e.stopPropagation(); updateBug(b.id, { status: e.target.value }); }}
                                                    onClick={e => e.stopPropagation()}
                                                    className="form-input" style={{width: 130, fontSize: 12}}>
                                                    <option value="open">Offen</option>
                                                    <option value="in_progress">In Arbeit</option>
                                                    <option value="fixed">Gefixt</option>
                                                    <option value="closed">Geschlossen</option>
                                                </select>
                                                <select value={b.priority} onChange={e => { e.stopPropagation(); updateBug(b.id, { priority: e.target.value }); }}
                                                    onClick={e => e.stopPropagation()}
                                                    className="form-input" style={{width: 110, fontSize: 12}}>
                                                    <option value="low">Niedrig</option>
                                                    <option value="normal">Normal</option>
                                                    <option value="high">Hoch</option>
                                                    <option value="critical">Kritisch</option>
                                                </select>
                                                {b.log_snapshot?.length > 0 && (
                                                    <button className="btn btn-sm" onClick={e => {
                                                        e.stopPropagation();
                                                        const text = b.log_snapshot.map(l => l.time + ' [' + l.level + '] ' + l.name + ': ' + l.msg).join('\n');
                                                        const blob = new Blob([text], {type: 'text/plain'});
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url; a.download = 'bug-' + b.id + '-logs.txt'; a.click();
                                                    }}>
                                                        {'\uD83D\uDCCE'} Logs ({b.log_snapshot.length})
                                                    </button>
                                                )}
                                                <div style={{flex: 1}} />
                                                <button className="btn btn-sm" style={{color: '#f44'}}
                                                    onClick={e => { e.stopPropagation(); deleteBug(b.id); }}>
                                                    {'\uD83D\uDDD1'} L√∂schen
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </>
            )}
        </div>
    );
}


function SettingsPage() {
    const [config, setConfig] = useState({});
    const [updateCheck, setUpdateCheck] = useState(null);
    const [updateConfig, setUpdateConfigState] = useState({});
    const [updateStep, setUpdateStep] = useState(null); // {step, message, percent}
    const [systemInfo, setSystemInfo] = useState(null);
    const toast = useToast();
    const { lastMessage } = useWebSocket();

    useEffect(() => {
        API.get('/api/config').then(data => setConfig(data || {}));
        API.get('/api/update/check').then(data => { if (data && !data.error) setUpdateCheck(data); });
        API.get('/api/update/config').then(data => { if (data) setUpdateConfigState(data); });
        API.get('/api/update/status').then(data => { if (data) setSystemInfo(data); });
    }, []);

    // Listen for update progress via WebSocket
    useEffect(() => {
        if (lastMessage?.type === 'update_status') {
            setUpdateStep(lastMessage);
            if (lastMessage.step === 'error') {
                toast(lastMessage.message, 'error');
            }
            if (lastMessage.step === 'uptodate') {
                toast(lastMessage.message, 'info');
                setUpdateStep(null);
            }
        }
    }, [lastMessage]);

    const save = async () => {
        await API.post('/api/config', config);
        toast('Einstellungen gespeichert!', 'success');
    };

    const exportConfig = async () => {
        const data = await API.post('/api/config/export');
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'throwsync-config.json';
        a.click();
        toast('Konfiguration exportiert', 'success');
    };

    const importConfig = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            const text = await file.text();
            const data = JSON.parse(text);
            await API.post('/api/config/import', data);
            toast('Konfiguration importiert', 'success');
            API.get('/api/config').then(d => setConfig(d || {}));
        };
        input.click();
    };

    // ‚îÄ‚îÄ‚îÄ Update Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const doCheckUpdate = async () => {
        const data = await API.get('/api/update/check');
        if (data) {
            setUpdateCheck(data);
            if (data.error) toast(`Update-Check Fehler: ${data.error}`, 'error');
            else if (data.available) toast(`Update v${data.remote_version} verf√ºgbar!`, 'success');
            else toast(`Kein Update verf√ºgbar (v${data.local_version} ist aktuell)`, 'info');
        }
    };

    const doOneClickUpdate = async () => {
        setUpdateStep({step: 'starting', message: 'Update wird gestartet...'});
        const result = await API.post('/api/update/apply');
        if (!result?.success) {
            toast(result?.message || 'Update konnte nicht gestartet werden', 'error');
            setUpdateStep(null);
        }
        // Progress comes via WebSocket from here on
    };

    const doInstallStaged = async () => {
        setUpdateStep({step: 'installing', message: 'Installiere...'});
        await API.post('/api/update/install');
    };

    const doRollback = async () => {
        if (!confirm('Zur vorherigen Version zur√ºckkehren?\n\nDer Server startet automatisch neu.')) return;
        toast('Rollback wird durchgef√ºhrt...', 'info');
        await API.post('/api/update/rollback');
    };

    const saveUpdateConfig = async () => {
        await API.post('/api/update/config', updateConfig);
        toast('Update-Einstellungen gespeichert', 'success');
    };

    const settings = config.settings || {};
    const hasUpdate = updateCheck?.available;
    const isUpdating = updateStep && !['error', 'uptodate'].includes(updateStep.step);
    const { t, lang, setLang } = useI18n();

    const langOptions = [
        { code: 'de', flag: '\uD83C\uDDE9\uD83C\uDDEA', label: 'Deutsch' },
        { code: 'en', flag: '\uD83C\uDDEC\uD83C\uDDE7', label: 'English' },
        { code: 'nl', flag: '\uD83C\uDDF3\uD83C\uDDF1', label: 'Nederlands' },
        { code: 'fr', flag: '\uD83C\uDDEB\uD83C\uDDF7', label: 'Fran\u00e7ais' },
    ];

    return (
        <div>
            <div className="page-header">
                <h2>{t('nav.settings', 'Einstellungen')}</h2>
                <p>{t('set.display_desc', 'Konfiguration, Updates und Systeminfo')}</p>
            </div>

            {/* ‚ïê‚ïê‚ïê LANGUAGE ‚ïê‚ïê‚ïê */}
            <div className="card" style={{marginBottom: 20}}>
                <div style={{display: 'flex', alignItems: 'center', gap: 12}}>
                    <span style={{fontSize: 28}}>üåç</span>
                    <div style={{flex: 1}}>
                        <div style={{fontWeight: 700, fontSize: 16}}>{t('set.language', 'Sprache')}</div>
                    </div>
                    <div style={{display: 'flex', gap: 4}}>
                        {langOptions.map(l => (
                            <button key={l.code} className="btn"
                                style={{
                                    padding: '6px 12px', fontSize: 14,
                                    background: lang === l.code ? 'var(--accent)' : 'transparent',
                                    color: lang === l.code ? '#fff' : 'var(--text-dim)',
                                    border: lang === l.code ? 'none' : '1px solid var(--border)',
                                }}
                                onClick={() => setLang(l.code)}>
                                {l.flag} {l.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            {/* ‚ïê‚ïê‚ïê UPDATE SECTION ‚ïê‚ïê‚ïê */}
            <div className="card" style={{marginBottom:20, borderColor: hasUpdate ? 'var(--accent)' : 'var(--border)'}}>
                <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:16}}>
                    <span style={{fontSize:28}}>üîÑ</span>
                    <div style={{flex:1}}>
                        <div style={{fontWeight:700,fontSize:16}}>Software-Update</div>
                        <div style={{fontSize:13,color:'var(--text-dim)'}}>
                            Installiert: v{updateCheck?.local_version || '?'}
                        </div>
                    </div>
                    {!isUpdating && (
                        <button className="btn btn-sm btn-primary" onClick={doCheckUpdate}>
                            üîç Pr√ºfen
                        </button>
                    )}
                </div>

                {/* ‚îÄ‚îÄ Live Update Progress ‚îÄ‚îÄ */}
                {isUpdating && (
                    <div style={{
                        background:'rgba(0,150,255,0.08)',borderRadius:8,padding:16,marginBottom:16,
                    }}>
                        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                            <div style={{
                                width:20,height:20,border:'3px solid var(--accent)',borderTopColor:'transparent',
                                borderRadius:'50%',animation:'spin 0.8s linear infinite',
                            }}/>
                            <span style={{fontWeight:600,fontSize:14}}>{updateStep?.message || 'Update l√§uft...'}</span>
                        </div>
                        {updateStep?.percent >= 0 && (
                            <div style={{height:8,background:'var(--border)',borderRadius:4,overflow:'hidden'}}>
                                <div style={{
                                    width:`${updateStep.percent}%`,height:'100%',
                                    background:'linear-gradient(90deg,var(--accent),#00c853)',
                                    borderRadius:4,transition:'width 0.3s ease',
                                }}/>
                            </div>
                        )}
                        {updateStep?.step === 'restarting' && (
                            <div style={{fontSize:12,color:'var(--text-dim)',marginTop:8}}>
                                Seite wird automatisch neu geladen...
                            </div>
                        )}
                    </div>
                )}

                {/* ‚îÄ‚îÄ Update Available ‚îÄ‚îÄ */}
                {hasUpdate && !isUpdating && (
                    <div style={{
                        background:'rgba(0,150,255,0.08)',borderRadius:8,padding:16,marginBottom:16,
                    }}>
                        <div style={{fontWeight:700,fontSize:15,marginBottom:8}}>
                            üÜï Version {updateCheck.remote_version} verf√ºgbar!
                        </div>
                        {updateCheck.changelog && (
                            <div style={{fontSize:13,color:'var(--text-dim)',marginBottom:12,whiteSpace:'pre-line'}}>
                                {updateCheck.changelog.replace(/^#+ /gm, '').replace(/\*\*/g, '')}
                            </div>
                        )}
                        {updateCheck.size > 0 && (
                            <div style={{fontSize:12,color:'var(--text-dim)',marginBottom:12}}>
                                Download: {(updateCheck.size / 1024 / 1024).toFixed(1)} MB
                            </div>
                        )}
                        <button className="btn btn-primary" onClick={doOneClickUpdate}
                            style={{fontSize:15,padding:'10px 24px'}}>
                            üöÄ Jetzt updaten auf v{updateCheck.remote_version}
                        </button>
                        <div style={{fontSize:11,color:'var(--text-dim)',marginTop:8}}>
                            Konfiguration & Sounds bleiben erhalten. Server startet automatisch neu.
                        </div>
                    </div>
                )}

                {/* ‚îÄ‚îÄ Up to date ‚îÄ‚îÄ */}
                {updateCheck && !hasUpdate && !isUpdating && !updateCheck.error && (
                    <div style={{
                        background:'rgba(0,200,0,0.08)',borderRadius:8,padding:12,marginBottom:16,
                        display:'flex',alignItems:'center',gap:8,
                    }}>
                        <span style={{fontSize:20}}>‚úÖ</span>
                        <span style={{fontWeight:600}}>Du hast die neueste Version (v{updateCheck.local_version})</span>
                    </div>
                )}

                {/* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */}
                {updateCheck?.error && !isUpdating && (
                    <div style={{background:'rgba(255,0,0,0.08)',borderRadius:8,padding:12,marginBottom:16,fontSize:13}}>
                        ‚ö†Ô∏è {updateCheck.error}
                    </div>
                )}

                {/* ‚îÄ‚îÄ Rollback ‚îÄ‚îÄ */}
                {!isUpdating && (
                    <div style={{fontSize:12,color:'var(--text-dim)',marginTop:8}}>
                        <button className="btn btn-sm" onClick={doRollback} style={{fontSize:11}}>
                            ‚Ü© Zur vorherigen Version zur√ºckkehren
                        </button>
                    </div>
                )}

                {/* ‚îÄ‚îÄ Update Server Config ‚îÄ‚îÄ */}
                <details style={{marginTop:16}}>
                    <summary style={{cursor:'pointer',fontSize:13,color:'var(--text-dim)',userSelect:'none'}}>
                        ‚öôÔ∏è Update-Server Konfiguration
                    </summary>
                    <div style={{marginTop:12}}>
                        <div className="input-group">
                            <label style={{fontSize:12}}>Manifest-URL</label>
                            <input type="text" value={updateConfig.manifest_url || ''}
                                onChange={e => setUpdateConfigState({...updateConfig, manifest_url: e.target.value})}
                                placeholder="https://..."
                                style={{fontFamily:'JetBrains Mono',fontSize:11}} />
                        </div>
                        <button className="btn btn-sm" onClick={saveUpdateConfig}>Speichern</button>
                    </div>
                </details>
            </div>

            {/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */}
            <div className="grid-2">
                <div className="card">
                    <div className="card-title" style={{marginBottom: 16}}>Allgemein</div>
                    <div className="input-group">
                        <label>Standard-Helligkeit</label>
                        <input type="range" min="0" max="255" value={settings.default_brightness || 128}
                            onChange={e => setConfig({
                                ...config,
                                settings: {...settings, default_brightness: parseInt(e.target.value)}
                            })} />
                        <span style={{fontSize: 12, color: 'var(--text-dim)'}}>{Math.round((settings.default_brightness || 128) / 255 * 100)}%</span>
                    </div>
                    <div className="input-group">
                        <label>√úbergangszeit (0-255)</label>
                        <input type="number" min="0" max="255" value={settings.transition_time || 7}
                            onChange={e => setConfig({
                                ...config,
                                settings: {...settings, transition_time: parseInt(e.target.value)}
                            })} />
                    </div>
                    <div className="input-group">
                        <label>Polling-Intervall (Sekunden)</label>
                        <input type="number" min="2" max="60" value={settings.poll_interval || 10}
                            onChange={e => setConfig({
                                ...config,
                                settings: {...settings, poll_interval: parseInt(e.target.value)}
                            })} />
                    </div>
                    <button className="btn btn-primary" onClick={save}>üíæ Speichern</button>
                </div>

                <div className="card">
                    <div className="card-title" style={{marginBottom: 16}}>Konfiguration</div>
                    <p style={{fontSize: 14, color: 'var(--text-secondary)', marginBottom: 16}}>
                        Exportiere deine gesamte Konfiguration oder importiere eine gespeicherte.
                    </p>
                    <div style={{display: 'flex', gap: 10, flexDirection: 'column'}}>
                        <button className="btn" onClick={exportConfig}>üì• Konfiguration exportieren</button>
                        <button className="btn" onClick={importConfig}>üì§ Konfiguration importieren</button>
                    </div>
                </div>
            </div>

            <div className="card">
                <div className="card-title" style={{marginBottom: 12}}>Display Overlay</div>
                <p style={{color: 'var(--text-dim)', fontSize: 13, marginBottom: 12}}>
                    Zeigt Score-HUD, Clips und Event-Toasts direkt auf der Autodarts/Darthelfer Seite ‚Äî auch im Fullscreen.
                </p>
                <div style={{display: 'flex', gap: 8, flexWrap: 'wrap'}}>
                    <button className="btn btn-primary" onClick={() => {
                        window.open('/bookmarklet', '_blank');
                    }}>
                        üîñ Bookmarklet einrichten
                    </button>
                    <button className="btn" onClick={() => {
                        window.open('/display', 'throwsync-display',
                            'width=800,height=200,menubar=no,toolbar=no,location=no,status=no');
                    }}>
                        üñ• Display Popup
                    </button>
                    <button className="btn" onClick={() => {
                        navigator.clipboard.writeText(window.location.origin + '/display');
                        toast.show('URL kopiert!', 'success');
                    }}>
                        üìã OBS URL kopieren
                    </button>
                    <button className="btn" onClick={() => {
                        window.open('/lobby', '_blank');
                    }}>
                        üè† Lobby Display
                    </button>
                </div>
                <small style={{color: 'var(--text-dim)', marginTop: 8, display: 'block'}}>
                    Bookmarklet: 1 Klick auf Autodarts = HUD + Clips erscheinen. ‚Ä¢ OBS: {window.location.origin}/display als Browser-Source. ‚Ä¢ Lobby: {window.location.origin}/lobby
                </small>

                <div style={{marginTop: 16, paddingTop: 16, borderTop: '1px solid var(--border)'}}>
                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10}}>
                        <span style={{fontWeight: 600, fontSize: 14}}>üß™ Overlay testen</span>
                        <small style={{color: 'var(--text-dim)'}}>Aktiviere das Bookmarklet auf einer Seite, dann klicke hier</small>
                    </div>
                    <div style={{display: 'flex', gap: 6, flexWrap: 'wrap'}}>
                        {[
                            {label: 'üéØ Wurf T20', endpoint: 'throw'},
                            {label: '‚ö° 3-Dart 140', endpoint: 'score_140'},
                            {label: 'üî• 180!', endpoint: '180'},
                            {label: 'üí• Bust', endpoint: 'bust'},
                            {label: 'üéâ Leg Won', endpoint: 'game_won'},
                            {label: 'üèÜ Match Won', endpoint: 'match_won'},
                        ].map(t => (
                            <button key={t.endpoint} className="btn" style={{fontSize: 12, padding: '5px 10px'}}
                                onClick={() => API.post('/api/display/test', {event: t.endpoint}).then(() => toast.show('Test gesendet!', 'info'))}>
                                {t.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            <div className="card">
                <div className="card-title" style={{marginBottom: 16}}>Systeminfo</div>
                <div style={{fontFamily: 'JetBrains Mono', fontSize: 13, color: 'var(--text-secondary)', lineHeight: 2}}>
                    <div>Version: {systemInfo?.local_version || '?'}</div>
                    <div>Python: {systemInfo?.python_version || '?'}</div>
                    <div>Plattform: {systemInfo?.platform || '?'}</div>
                    <div>Ger√§te: {config.devices?.length || 0}</div>
                    <div>Presets: {config.presets?.length || 0}</div>
                </div>
                <div style={{marginTop: 12, paddingTop: 12, borderTop: '1px solid var(--border)'}}>
                    <div style={{fontWeight: 600, fontSize: 14, marginBottom: 8}}>üåê Server-Zugriff</div>
                    <div style={{fontSize: 13, color: 'var(--text-dim)', marginBottom: 8}}>
                        √ñffne ThrowSync auf anderen Ger√§ten im Netzwerk:
                    </div>
                    {(systemInfo?.network_ips || []).map(ip => (
                        <div key={ip} style={{display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4}}>
                            <code style={{background: 'var(--bg-input)', padding: '3px 8px', borderRadius: 4, fontSize: 13}}>
                                http://{ip}:8420
                            </code>
                            <button className="btn" style={{padding: '2px 8px', fontSize: 11}}
                                onClick={() => { navigator.clipboard.writeText(`http://${ip}:8420`); toast.show('URL kopiert!', 'success'); }}>
                                üìã
                            </button>
                        </div>
                    ))}
                    {(!systemInfo?.network_ips || systemInfo.network_ips.length === 0) && (
                        <code style={{background: 'var(--bg-input)', padding: '3px 8px', borderRadius: 4, fontSize: 13}}>
                            {window.location.origin}
                        </code>
                    )}
                </div>
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ Profile Bar Component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ProfileBar() {
    const [profiles, setProfiles] = useState([]);
    const [active, setActive] = useState('default');
    const [showNew, setShowNew] = useState(false);
    const toast = useToast();

    const load = () => API.get('/api/profiles').then(d => {
        if (d?.profiles) setProfiles(d.profiles);
        if (d?.active) setActive(d.active);
    });
    useEffect(() => { load(); }, []);

    const activate = async (id) => {
        await API.post('/api/profiles/activate', { id });
        setActive(id);
        toast(`Profil "${profiles.find(p => p.id === id)?.name || id}" aktiviert`, 'success');
    };

    const saveNew = async (name) => {
        const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
        await API.post('/api/profiles/save', { id, name, icon: 'üéØ', description: '' });
        await activate(id);
        setShowNew(false);
        load();
    };

    const saveCurrent = async () => {
        await API.post('/api/profiles/save', { id: active });
        toast('Profil gespeichert', 'success');
    };

    return (
        <div className="profile-bar">
            {profiles.map(p => (
                <div key={p.id} className={`profile-chip ${active === p.id ? 'active' : ''}`}
                    onClick={() => activate(p.id)}>
                    <span>{p.icon || 'üéØ'}</span>
                    <span>{p.name}</span>
                </div>
            ))}
            <div className="profile-chip" onClick={saveCurrent}
                style={{background: 'rgba(0,200,100,0.1)', borderColor: 'rgba(0,200,100,0.3)'}}>
                üíæ Speichern
            </div>
            <div className="profile-chip" onClick={() => {
                const name = prompt('Name fuer neues Profil:');
                if (name) saveNew(name);
            }} style={{borderStyle: 'dashed'}}>
                + Neu
            </div>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Player Colors Component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function PlayerColorsEditor() {
    const [config, setConfig] = useState(null);
    const toast = useToast();

    useEffect(() => { API.get('/api/player-colors').then(d => setConfig(d)); }, []);

    const save = async () => {
        await API.post('/api/player-colors', config);
        toast('Spielerfarben gespeichert', 'success');
    };

    if (!config) return null;

    const updatePlayer = (idx, key, val) => {
        const players = [...config.players];
        players[idx] = {...players[idx], [key]: val};
        setConfig({...config, players});
    };

    const hexToRgb = (hex) => [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
    const rgbToHex = (rgb) => '#' + rgb.map(c => c.toString(16).padStart(2,'0')).join('');

    return (
        <div className="card" style={{marginTop: 20}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <div className="card-title">üé® Spielerfarben</div>
                <div className="toggle-row">
                    <div className={`toggle ${config.enabled ? 'active' : ''}`}
                        onClick={() => setConfig({...config, enabled: !config.enabled})} />
                    <span style={{fontSize: 12}}>{config.enabled ? 'Aktiv' : 'Aus'}</span>
                </div>
            </div>

            {config.enabled && (
                <div>
                    <div style={{display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap'}}>
                        <span style={{fontSize: 12, color: 'var(--text-dim)', lineHeight: '32px'}}>Modus:</span>
                        {[['turn', 'Bei Spielerwechsel'], ['idle', 'Im Leerlauf'], ['always', 'Immer']].map(([m, l]) => (
                            <button key={m} className="btn btn-sm"
                                style={{background: config.mode === m ? 'var(--accent)' : 'var(--bg-input)', fontSize: 12}}
                                onClick={() => setConfig({...config, mode: m})}>{l}</button>
                        ))}
                    </div>

                    <div style={{display: 'grid', gap: 10, gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))'}}>
                        {config.players.map((player, idx) => (
                            <div key={idx} style={{
                                display: 'flex', gap: 10, alignItems: 'center', padding: '10px 12px',
                                background: 'rgba(0,0,0,0.2)', borderRadius: 10,
                                border: `2px solid rgb(${player.color.join(',')})`,
                                opacity: player.enabled ? 1 : 0.4,
                            }}>
                                <input type="color" value={rgbToHex(player.color)}
                                    onChange={e => updatePlayer(idx, 'color', hexToRgb(e.target.value))}
                                    style={{width: 36, height: 36, borderRadius: '50%', border: 'none', cursor: 'pointer'}} />
                                <div style={{flex: 1}}>
                                    <input type="text" value={player.name} placeholder={`Spieler ${idx+1}`}
                                        onChange={e => updatePlayer(idx, 'name', e.target.value)}
                                        style={{background: 'transparent', border: 'none', color: 'var(--text-primary)',
                                            fontSize: 14, width: '100%', outline: 'none'}} />
                                </div>
                                <div className={`toggle ${player.enabled ? 'active' : ''}`}
                                    onClick={() => updatePlayer(idx, 'enabled', !player.enabled)} />
                            </div>
                        ))}
                    </div>

                    <div style={{display: 'flex', gap: 8, marginTop: 12}}>
                        <button className="btn btn-primary btn-sm" onClick={save}>Speichern</button>
                        {config.players.length < 8 && (
                            <button className="btn btn-sm" onClick={() => setConfig({
                                ...config,
                                players: [...config.players, {name: `Spieler ${config.players.length+1}`,
                                    color: [[255,0,255],[0,255,255],[255,128,0],[128,255,0]][config.players.length % 4],
                                    enabled: true}]
                            })}>+ Spieler</button>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Effect Chain Builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function EffectChainBuilder({ chain, onChange }) {
    const addStep = () => onChange([...(chain || []), {
        effect: {fx: 0, col: [[255,255,255]], bri: 200}, duration: 1.0
    }]);

    const updateStep = (idx, key, val) => {
        const c = [...chain]; c[idx] = {...c[idx], [key]: val}; onChange(c);
    };

    const removeStep = (idx) => onChange(chain.filter((_, i) => i !== idx));

    const moveStep = (idx, dir) => {
        const c = [...chain]; const ni = idx + dir;
        if (ni < 0 || ni >= c.length) return;
        [c[idx], c[ni]] = [c[ni], c[idx]]; onChange(c);
    };

    if (!chain || chain.length === 0) {
        return (
            <div style={{textAlign: 'center', padding: '12px 0'}}>
                <button className="btn btn-sm" onClick={addStep}
                    style={{borderStyle: 'dashed'}}>
                    ‚õì Effekt-Kette erstellen (mehrere Effekte nacheinander)
                </button>
            </div>
        );
    }

    return (
        <div>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                <span style={{fontSize: 12, fontWeight: 600, color: 'var(--text-secondary)'}}>
                    ‚õì Effekt-Kette ({chain.length} Schritte)
                </span>
                <button className="btn btn-sm" onClick={() => onChange(null)} style={{fontSize: 11}}>
                    Kette entfernen
                </button>
            </div>
            <div style={{display: 'grid', gap: 8}}>
                {chain.map((step, idx) => {
                    const col = step.effect?.col?.[0] || [255,255,255];
                    return (
                        <div key={idx} className="chain-step">
                            <div style={{
                                width: 32, height: 32, borderRadius: 6, flexShrink: 0,
                                background: `rgb(${col.join(',')})`,
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: 11, color: 'white', fontWeight: 700,
                            }}>{idx + 1}</div>
                            <div style={{flex: 1, display: 'grid', gridTemplateColumns: '1fr 1fr 80px', gap: 6, alignItems: 'center'}}>
                                <select value={step.effect?.fx ?? 0} style={{fontSize: 12}}
                                    onChange={e => updateStep(idx, 'effect', {...step.effect, fx: parseInt(e.target.value)})}>
                                    {Object.entries(WLED_EFFECTS).map(([k,v]) => (
                                        <option key={k} value={k}>{v}</option>
                                    ))}
                                </select>
                                <input type="color"
                                    value={'#' + col.map(c => c.toString(16).padStart(2,'0')).join('')}
                                    onChange={e => {
                                        const r = parseInt(e.target.value.slice(1,3),16);
                                        const g = parseInt(e.target.value.slice(3,5),16);
                                        const b = parseInt(e.target.value.slice(5,7),16);
                                        updateStep(idx, 'effect', {...step.effect, col: [[r,g,b]]});
                                    }}
                                    style={{height: 28}} />
                                <div style={{display: 'flex', alignItems: 'center', gap: 4}}>
                                    <input type="number" min="0.1" step="0.5" value={step.duration || 1}
                                        style={{width: 50, fontSize: 12}}
                                        onChange={e => updateStep(idx, 'duration', parseFloat(e.target.value))} />
                                    <span style={{fontSize: 10, color: 'var(--text-dim)'}}>s</span>
                                </div>
                            </div>
                            <div style={{display: 'flex', flexDirection: 'column', gap: 2}}>
                                <button className="btn btn-sm" style={{padding: '2px 6px', fontSize: 10}}
                                    onClick={() => moveStep(idx, -1)}>‚ñ≤</button>
                                <button className="btn btn-sm" style={{padding: '2px 6px', fontSize: 10, color: 'var(--danger)'}}
                                    onClick={() => removeStep(idx)}>‚úï</button>
                                <button className="btn btn-sm" style={{padding: '2px 6px', fontSize: 10}}
                                    onClick={() => moveStep(idx, 1)}>‚ñº</button>
                            </div>
                        </div>
                    );
                })}
            </div>
            <button className="btn btn-sm" onClick={addStep} style={{marginTop: 8, width: '100%', borderStyle: 'dashed'}}>
                + Schritt hinzufuegen
            </button>
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Favorites Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function FavoritesPanel({ currentEffect, currentDuration, onApply }) {
    const [favorites, setFavorites] = useState([]);
    const [showFavs, setShowFavs] = useState(false);
    const toast = useToast();

    useEffect(() => { API.get('/api/favorites').then(d => setFavorites(d?.favorites || [])); }, []);

    const saveFav = async () => {
        const name = prompt('Name fuer den Favorit:');
        if (!name) return;
        const result = await API.post('/api/favorites', {name, effect: currentEffect, duration: currentDuration});
        if (result?.favorite) {
            setFavorites(prev => [...prev.filter(f => f.id !== result.favorite.id), result.favorite]);
            toast(`"${name}" gespeichert`, 'success');
        }
    };

    const deleteFav = async (id) => {
        await API.del(`/api/favorites/${id}`);
        setFavorites(prev => prev.filter(f => f.id !== id));
    };

    return (
        <div style={{marginBottom: 16}}>
            <div style={{display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap'}}>
                <button className="btn btn-sm" onClick={saveFav}
                    style={{background: 'rgba(255,215,0,0.1)', borderColor: 'rgba(255,215,0,0.3)', fontSize: 11}}>
                    ‚òÖ Als Favorit speichern
                </button>
                {favorites.length > 0 && (
                    <button className="btn btn-sm" onClick={() => setShowFavs(!showFavs)}
                        style={{fontSize: 11}}>
                        {showFavs ? '‚ñ≤' : '‚ñº'} Favoriten ({favorites.length})
                    </button>
                )}
            </div>

            {showFavs && favorites.length > 0 && (
                <div style={{display: 'flex', gap: 6, marginTop: 8, flexWrap: 'wrap'}}>
                    {favorites.map(fav => {
                        const col = fav.effect?.col?.[0] || [100,100,100];
                        return (
                            <div key={fav.id} style={{
                                display: 'flex', alignItems: 'center', gap: 6, padding: '6px 10px',
                                background: 'rgba(0,0,0,0.3)', borderRadius: 8, cursor: 'pointer',
                                border: '1px solid var(--border)',
                            }}>
                                <div style={{
                                    width: 16, height: 16, borderRadius: 4,
                                    background: `rgb(${col.join(',')})`, flexShrink: 0,
                                }} />
                                <span style={{fontSize: 12}} onClick={() => onApply(fav.effect, fav.duration)}>
                                    {fav.name}
                                </span>
                                <span style={{fontSize: 10, color: 'var(--danger)', cursor: 'pointer'}}
                                    onClick={(e) => { e.stopPropagation(); deleteFav(fav.id); }}>‚úï</span>
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Brightness Schedule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function BrightnessScheduleEditor() {
    const [schedule, setSchedule] = useState(null);
    const toast = useToast();

    useEffect(() => { API.get('/api/schedule').then(d => setSchedule(d)); }, []);

    const save = async () => {
        await API.post('/api/schedule', schedule);
        toast('Zeitplan gespeichert', 'success');
    };

    if (!schedule) return null;

    const updateEntry = (idx, key, val) => {
        const entries = [...schedule.entries];
        entries[idx] = {...entries[idx], [key]: val};
        setSchedule({...schedule, entries});
    };

    const addEntry = () => setSchedule({
        ...schedule,
        entries: [...schedule.entries, {time: '12:00', brightness: 150, label: 'Neu'}]
    });

    const removeEntry = (idx) => setSchedule({
        ...schedule, entries: schedule.entries.filter((_, i) => i !== idx)
    });

    return (
        <div className="card" style={{marginTop: 20}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <div className="card-title">üïê Helligkeitsplan</div>
                <div className={`toggle ${schedule.enabled ? 'active' : ''}`}
                    onClick={() => setSchedule({...schedule, enabled: !schedule.enabled})} />
            </div>

            {schedule.enabled && (
                <div>
                    <p style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 12}}>
                        LEDs dimmen sich automatisch nach Uhrzeit
                    </p>

                    {/* Visual timeline */}
                    <div style={{
                        display: 'flex', height: 40, borderRadius: 8, overflow: 'hidden',
                        marginBottom: 16, border: '1px solid var(--border)',
                    }}>
                        {schedule.entries.sort((a,b) => a.time.localeCompare(b.time)).map((entry, idx) => {
                            const bri = entry.brightness / 255;
                            return (
                                <div key={idx} style={{
                                    flex: 1,
                                    background: `rgba(108,92,231,${0.1 + bri * 0.6})`,
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    fontSize: 10, color: 'var(--text-primary)',
                                    borderRight: idx < schedule.entries.length - 1 ? '1px solid var(--border)' : 'none',
                                }}>
                                    {entry.time}<br/>{Math.round(bri * 100)}%
                                </div>
                            );
                        })}
                    </div>

                    <div style={{display: 'grid', gap: 8}}>
                        {schedule.entries.map((entry, idx) => (
                            <div key={idx} className="schedule-entry">
                                <input type="time" value={entry.time}
                                    onChange={e => updateEntry(idx, 'time', e.target.value)}
                                    style={{width: 100}} />
                                <div style={{flex: 1}}>
                                    <input type="text" value={entry.label} placeholder="Label"
                                        onChange={e => updateEntry(idx, 'label', e.target.value)}
                                        style={{background: 'transparent', border: 'none', color: 'var(--text-primary)',
                                            width: '100%', outline: 'none', fontSize: 13}} />
                                </div>
                                <div style={{display: 'flex', alignItems: 'center', gap: 6, minWidth: 100}}>
                                    <input type="range" min="0" max="255" value={entry.brightness}
                                        onChange={e => updateEntry(idx, 'brightness', parseInt(e.target.value))}
                                        style={{width: 70}} />
                                    <span style={{fontSize: 11, color: 'var(--text-dim)', minWidth: 30}}>
                                        {Math.round(entry.brightness / 255 * 100)}%
                                    </span>
                                </div>
                                <button className="btn btn-sm" style={{padding: '4px 8px', color: 'var(--danger)'}}
                                    onClick={() => removeEntry(idx)}>‚úï</button>
                            </div>
                        ))}
                    </div>

                    <div style={{display: 'flex', gap: 8, marginTop: 12}}>
                        <button className="btn btn-sm" onClick={addEntry} style={{borderStyle: 'dashed'}}>+ Zeitpunkt</button>
                        <button className="btn btn-primary btn-sm" onClick={save}>Speichern</button>
                    </div>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Segment Zones Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SegmentZonesEditor() {
    const [config, setConfig] = useState(null);
    const toast = useToast();

    useEffect(() => { API.get('/api/segments').then(d => setConfig(d)); }, []);

    const save = async () => {
        await API.post('/api/segments', config);
        toast('Segmentzonen gespeichert', 'success');
    };

    if (!config) return null;

    const updateZone = (idx, key, val) => {
        const zones = [...config.zones];
        zones[idx] = {...zones[idx], [key]: val};
        setConfig({...config, zones});
    };

    const hexToRgb = (hex) => [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
    const rgbToHex = (rgb) => '#' + rgb.map(c => c.toString(16).padStart(2,'0')).join('');

    return (
        <div className="card" style={{marginTop: 20}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <div className="card-title">üìê Segment-Zonen</div>
                <div className={`toggle ${config.enabled ? 'active' : ''}`}
                    onClick={() => setConfig({...config, enabled: !config.enabled})} />
            </div>

            {config.enabled && (
                <div>
                    <p style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 12}}>
                        Teile deinen LED-Strip in Zonen (z.B. oben/rechts/unten/links um das Board)
                    </p>

                    {/* Visual ring preview */}
                    <div style={{position: 'relative', width: 180, height: 180, margin: '0 auto 16px'}}>
                        <svg viewBox="0 0 200 200" style={{width: '100%', height: '100%'}}>
                            {config.zones.map((zone, idx) => {
                                const startAngle = (zone.start_pct / 100) * 360 - 90;
                                const endAngle = (zone.end_pct / 100) * 360 - 90;
                                const startRad = startAngle * Math.PI / 180;
                                const endRad = endAngle * Math.PI / 180;
                                const r = 85;
                                const large = (endAngle - startAngle) > 180 ? 1 : 0;
                                const x1 = 100 + r * Math.cos(startRad);
                                const y1 = 100 + r * Math.sin(startRad);
                                const x2 = 100 + r * Math.cos(endRad);
                                const y2 = 100 + r * Math.sin(endRad);
                                return (
                                    <path key={idx}
                                        d={`M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`}
                                        stroke={`rgb(${zone.color.join(',')})`}
                                        strokeWidth="14" fill="none" strokeLinecap="round" opacity="0.9"
                                    />
                                );
                            })}
                            <text x="100" y="98" textAnchor="middle" fill="rgba(255,255,255,0.3)" fontSize="12">Board</text>
                            <text x="100" y="114" textAnchor="middle" fill="rgba(255,255,255,0.15)" fontSize="10">Surround</text>
                        </svg>
                    </div>

                    <div style={{display: 'grid', gap: 8}}>
                        {config.zones.map((zone, idx) => (
                            <div key={idx} style={{
                                display: 'flex', gap: 8, alignItems: 'center', padding: '8px 12px',
                                background: 'rgba(0,0,0,0.2)', borderRadius: 8,
                                borderLeft: `4px solid rgb(${zone.color.join(',')})`,
                            }}>
                                <input type="color" value={rgbToHex(zone.color)}
                                    onChange={e => updateZone(idx, 'color', hexToRgb(e.target.value))}
                                    style={{width: 30, height: 30}} />
                                <input type="text" value={zone.name}
                                    onChange={e => updateZone(idx, 'name', e.target.value)}
                                    style={{flex: 1, background: 'transparent', border: 'none', color: 'var(--text-primary)',
                                        outline: 'none', fontSize: 13}} />
                                <span style={{fontSize: 11, color: 'var(--text-dim)'}}>
                                    {zone.start_pct}%-{zone.end_pct}%
                                </span>
                                <input type="number" min="0" max="100" value={zone.start_pct}
                                    onChange={e => updateZone(idx, 'start_pct', parseInt(e.target.value))}
                                    style={{width: 50, fontSize: 12}} />
                                <input type="number" min="0" max="100" value={zone.end_pct}
                                    onChange={e => updateZone(idx, 'end_pct', parseInt(e.target.value))}
                                    style={{width: 50, fontSize: 12}} />
                            </div>
                        ))}
                    </div>

                    <div style={{display: 'flex', gap: 8, marginTop: 12}}>
                        <button className="btn btn-sm" style={{borderStyle: 'dashed'}} onClick={() => setConfig({
                            ...config, zones: [...config.zones,
                                {name: 'Neue Zone', start_pct: 0, end_pct: 25, color: [255,255,255]}]
                        })}>+ Zone</button>
                        <button className="btn btn-primary btn-sm" onClick={save}>Speichern</button>
                    </div>
                </div>
            )}
        </div>
    );
}


// ‚îÄ‚îÄ‚îÄ Stats Ambient Display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function StatsAmbientConfig() {
    const [config, setConfig] = useState({
        enabled: false,
        mode: 'average',
        thresholds: [
            { min: 0, max: 30, color: [255, 0, 0], label: 'Schlecht' },
            { min: 30, max: 50, color: [255, 150, 0], label: 'Unterdurchschnittlich' },
            { min: 50, max: 70, color: [255, 255, 0], label: 'Durchschnitt' },
            { min: 70, max: 90, color: [100, 255, 0], label: 'Gut' },
            { min: 90, max: 200, color: [0, 255, 50], label: 'Sehr gut' },
        ],
    });
    const toast = useToast();

    useEffect(() => { API.get('/api/config').then(d => {
        if (d?.stats_ambient) setConfig(d.stats_ambient);
    }); }, []);

    const save = async () => {
        await API.post('/api/config', { stats_ambient: config });
        toast('Stats-Ambient gespeichert', 'success');
    };

    return (
        <div className="card" style={{marginTop: 20}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16}}>
                <div className="card-title">üìä Statistik-Ambient</div>
                <div className={`toggle ${config.enabled ? 'active' : ''}`}
                    onClick={() => setConfig({...config, enabled: !config.enabled})} />
            </div>

            {config.enabled && (
                <div>
                    <p style={{fontSize: 12, color: 'var(--text-dim)', marginBottom: 12}}>
                        Hintergrundfarbe spiegelt deinen Average wider
                    </p>
                    <div style={{display: 'flex', gap: 4, marginBottom: 12}}>
                        {config.thresholds.map((t, idx) => (
                            <div key={idx} style={{
                                flex: 1, height: 30, borderRadius: 4, display: 'flex',
                                alignItems: 'center', justifyContent: 'center',
                                background: `rgb(${t.color.join(',')})`, fontSize: 10, color: '#000',
                                fontWeight: 600,
                            }}>{t.min}-{t.max}</div>
                        ))}
                    </div>
                    <button className="btn btn-primary btn-sm" onClick={save}>Speichern</button>
                </div>
            )}
        </div>
    );
}

// ‚îÄ‚îÄ‚îÄ Caller Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function CallerPage() {
    const [config, setConfig] = useState(null);
    const [sounds, setSounds] = useState({});
    const [categories, setCategories] = useState({});
    const [files, setFiles] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedCats, setExpandedCats] = useState({});
    const [search, setSearch] = useState('');
    const [filterCat, setFilterCat] = useState('all');
    const [showUpload, setShowUpload] = useState(false);
    const [uploading, setUploading] = useState(false);
    const [showFileManager, setShowFileManager] = useState(false);
    // Bulk
    const [bulkMode, setBulkMode] = useState(false);
    const [selected, setSelected] = useState(new Set());
    const [bulkSound, setBulkSound] = useState('');
    // Dirty tracking
    const [dirty, setDirty] = useState(new Set());
    const toast = useToast();
    const fileInputRef = useRef(null);

    const loadAll = async () => {
        setLoading(true);
        const [cfgData, sndData, fileData] = await Promise.all([
            API.get('/api/caller/config'),
            API.get('/api/caller/sounds'),
            API.get('/api/caller/files'),
        ]);
        if (cfgData) setConfig(cfgData);
        if (sndData) {
            setSounds(sndData.sounds || {});
            setCategories(sndData.categories || {});
        }
        if (fileData) setFiles(fileData.files || []);
        setLoading(false);
    };

    useEffect(() => { loadAll(); }, []);

    // ‚îÄ‚îÄ‚îÄ Config Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const saveConfig = async (updates) => {
        const newCfg = { ...config, ...updates };
        setConfig(newCfg);
        await API.post('/api/caller/config', updates);
    };

    // ‚îÄ‚îÄ‚îÄ Sound Assignment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const updateSound = (key, field, value) => {
        setSounds(prev => ({
            ...prev,
            [key]: { ...prev[key], [field]: value }
        }));
        setDirty(prev => new Set([...prev, key]));
    };

    const saveDirty = async () => {
        if (dirty.size === 0) return;
        const updates = {};
        dirty.forEach(key => {
            if (sounds[key]) {
                updates[key] = {
                    sound: sounds[key].sound || null,
                    volume: sounds[key].volume ?? 1.0,
                    enabled: sounds[key].enabled ?? true,
                };
            }
        });
        await API.post('/api/caller/sounds', updates);
        setDirty(new Set());
        toast(`${Object.keys(updates).length} Sound(s) gespeichert`, 'success');
    };

    // ‚îÄ‚îÄ‚îÄ File Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const handleUpload = async (e) => {
        const uploadFiles = Array.from(e.target.files || []);
        if (uploadFiles.length === 0) return;
        setUploading(true);
        let ok = 0, fail = 0;
        for (const file of uploadFiles) {
            const form = new FormData();
            form.append('file', file);
            try {
                const res = await fetch('/api/caller/upload', { method: 'POST', body: form });
                if (res.ok) ok++; else fail++;
            } catch { fail++; }
        }
        setUploading(false);
        if (ok > 0) toast(`${ok} Sound(s) hochgeladen`, 'success');
        if (fail > 0) toast(`${fail} Upload(s) fehlgeschlagen`, 'error');
        const fileData = await API.get('/api/caller/files');
        if (fileData) setFiles(fileData.files || []);
        if (fileInputRef.current) fileInputRef.current.value = '';
    };

    const deleteFile = async (filename) => {
        await API.del(`/api/caller/files/${encodeURIComponent(filename)}`);
        toast(`"${filename}" gel√∂scht`, 'success');
        const fileData = await API.get('/api/caller/files');
        if (fileData) setFiles(fileData.files || []);
    };

    // ‚îÄ‚îÄ‚îÄ Test Sound ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const testSound = async (key) => {
        const entry = sounds[key];
        if (!entry?.sound) {
            // Play locally if file exists
            toast('Kein Sound zugewiesen', 'info');
            return;
        }
        // Direct local playback for instant feedback
        try {
            const url = entry.sound.startsWith('http') ? entry.sound : `/sounds/${entry.sound}`;
            const audio = new Audio(url);
            audio.volume = Math.min(1, (config?.volume || 0.8) * (entry.volume || 1.0));
            await audio.play();
        } catch (e) {
            toast('Fehler beim Abspielen', 'error');
        }
    };

    // ‚îÄ‚îÄ‚îÄ Bulk Operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const toggleSelect = (key) => {
        setSelected(prev => {
            const next = new Set(prev);
            next.has(key) ? next.delete(key) : next.add(key);
            return next;
        });
    };

    const selectAllInCat = (catKey) => {
        const keys = Object.keys(sounds).filter(k => sounds[k].category === catKey);
        setSelected(prev => {
            const next = new Set(prev);
            const allIn = keys.every(k => next.has(k));
            keys.forEach(k => allIn ? next.delete(k) : next.add(k));
            return next;
        });
    };

    const bulkAssignSound = async () => {
        if (selected.size === 0) return;
        const updates = {};
        selected.forEach(key => {
            updates[key] = { sound: bulkSound || null };
        });
        await API.post('/api/caller/sounds', updates);
        toast(`Sound auf ${selected.size} Events gesetzt`, 'success');
        await loadAll();
        setBulkMode(false);
        setSelected(new Set());
    };

    const bulkToggle = async (enabled) => {
        if (selected.size === 0) return;
        const updates = {};
        selected.forEach(key => { updates[key] = { enabled }; });
        await API.post('/api/caller/sounds', updates);
        toast(`${selected.size} Events ${enabled ? 'aktiviert' : 'deaktiviert'}`, 'success');
        await loadAll();
    };

    // ‚îÄ‚îÄ‚îÄ Group & Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const catOrder = Object.entries(categories)
        .sort(([,a],[,b]) => (a.order||99) - (b.order||99))
        .map(([k]) => k);

    const filteredSounds = useMemo(() => {
        return Object.entries(sounds).filter(([key, val]) => {
            if (filterCat !== 'all' && val.category !== filterCat) return false;
            if (search) {
                const q = search.toLowerCase();
                return key.toLowerCase().includes(q) || (val.label || '').toLowerCase().includes(q);
            }
            return true;
        });
    }, [sounds, filterCat, search]);

    const grouped = useMemo(() => {
        const g = {};
        filteredSounds.forEach(([key, val]) => {
            const cat = val.category || 'other';
            if (!g[cat]) g[cat] = [];
            g[cat].push({ key, ...val });
        });
        return g;
    }, [filteredSounds]);

    const toggleCat = (cat) => {
        setExpandedCats(prev => ({ ...prev, [cat]: !prev[cat] }));
    };

    const assignedCount = Object.values(sounds).filter(s => s.sound).length;
    const totalCount = Object.keys(sounds).length;

    if (loading) return (
        <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:300}}>
            <div style={{textAlign:'center'}}>
                <div style={{fontSize:48,marginBottom:16,animation:'pulse 1.5s infinite'}}>üéôÔ∏è</div>
                <p style={{color:'var(--text-dim)'}}>Caller wird geladen...</p>
            </div>
        </div>
    );

    return (
        <div>
            {/* ‚îÄ‚îÄ‚îÄ Master Controls ‚îÄ‚îÄ‚îÄ */}
            <div className="card" style={{marginBottom:20, borderColor: config?.enabled ? 'var(--success)' : 'var(--border)'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:12}}>
                    <div style={{display:'flex',alignItems:'center',gap:12}}>
                        <span style={{fontSize:28}}>üéôÔ∏è</span>
                        <div>
                            <div style={{fontWeight:700,fontSize:16}}>Caller {config?.enabled ? 'AKTIV' : 'AUS'}</div>
                            <div style={{fontSize:12,color:'var(--text-dim)'}}>
                                {assignedCount} / {totalCount} Sounds zugewiesen
                            </div>
                        </div>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:16,flexWrap:'wrap'}}>
                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                            <span style={{fontSize:12,color:'var(--text-dim)'}}>üîä</span>
                            <input type="range" min="0" max="100" value={Math.round((config?.volume || 0.8) * 100)}
                                onChange={e => saveConfig({ volume: parseInt(e.target.value) / 100 })}
                                style={{width:100}} />
                            <span style={{fontSize:12,minWidth:32}}>{Math.round((config?.volume || 0.8) * 100)}%</span>
                        </div>
                        <button className={`btn btn-sm ${config?.enabled ? 'btn-success' : 'btn-primary'}`}
                            onClick={() => saveConfig({ enabled: !config?.enabled })}>
                            {config?.enabled ? '‚úì AN' : '‚óã AUS'}
                        </button>
                    </div>
                </div>

                {config?.enabled && (
                    <div style={{marginTop:16,display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:12}}>
                        <label style={{display:'flex',alignItems:'center',gap:8,fontSize:13,cursor:'pointer'}}>
                            <input type="checkbox" checked={config?.call_score_after_turn ?? true}
                                onChange={e => saveConfig({ call_score_after_turn: e.target.checked })} />
                            Score nach Aufnahme ansagen
                        </label>
                        <label style={{display:'flex',alignItems:'center',gap:8,fontSize:13,cursor:'pointer'}}>
                            <input type="checkbox" checked={config?.ambient_sounds ?? true}
                                onChange={e => saveConfig({ ambient_sounds: e.target.checked })} />
                            Ambient/Feier-Sounds
                        </label>
                        <label style={{display:'flex',alignItems:'center',gap:8,fontSize:13,cursor:'pointer'}}>
                            <input type="checkbox" checked={config?.checkout_call ?? true}
                                onChange={e => saveConfig({ checkout_call: e.target.checked })} />
                            Checkout ansagen
                        </label>
                        <div style={{display:'flex',alignItems:'center',gap:8,fontSize:13}}>
                            <span>Jeden Dart callen:</span>
                            <select value={config?.call_every_dart ?? 0}
                                onChange={e => saveConfig({ call_every_dart: parseInt(e.target.value) })}
                                style={{background:'var(--bg-card)',color:'var(--text)',border:'1px solid var(--border)',borderRadius:4,padding:'2px 6px',fontSize:13}}>
                                <option value={0}>Aus</option>
                                <option value={1}>Score (z.B. "60")</option>
                                <option value={2}>Feldname (z.B. "Triple 20")</option>
                                <option value={3}>Effekt-Sound</option>
                            </select>
                        </div>
                    </div>
                )}
            </div>

            {/* ‚îÄ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ‚îÄ */}
            <div style={{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap',alignItems:'center'}}>
                <input type="text" placeholder="üîç Suchen..." value={search}
                    onChange={e => setSearch(e.target.value)}
                    style={{flex:'1 1 200px',minWidth:150}} />
                <select value={filterCat} onChange={e => setFilterCat(e.target.value)}
                    style={{background:'var(--bg-card)',color:'var(--text)',border:'1px solid var(--border)',borderRadius:6,padding:'8px 12px',fontSize:13}}>
                    <option value="all">Alle Kategorien</option>
                    {catOrder.map(cat => (
                        <option key={cat} value={cat}>{categories[cat]?.label || cat}</option>
                    ))}
                </select>
                <button className="btn btn-sm" onClick={() => setShowUpload(!showUpload)}>
                    üì§ Sounds hochladen
                </button>
                <button className="btn btn-sm" onClick={() => setShowFileManager(!showFileManager)}>
                    üìÅ Dateien ({files.length})
                </button>
                <button className={`btn btn-sm ${bulkMode ? 'btn-primary' : ''}`}
                    onClick={() => { setBulkMode(!bulkMode); setSelected(new Set()); }}>
                    {bulkMode ? '‚úï Bulk beenden' : '‚òê Bulk'}
                </button>
                {dirty.size > 0 && (
                    <button className="btn btn-sm btn-success" onClick={saveDirty}>
                        üíæ {dirty.size} speichern
                    </button>
                )}
            </div>

            {/* ‚îÄ‚îÄ‚îÄ Upload Area ‚îÄ‚îÄ‚îÄ */}
            {showUpload && (
                <div className="card" style={{marginBottom:16,borderColor:'var(--accent)',borderStyle:'dashed'}}>
                    <div style={{textAlign:'center',padding:16}}>
                        <div style={{fontSize:36,marginBottom:8}}>üì§</div>
                        <p style={{marginBottom:12,color:'var(--text-dim)',fontSize:13}}>
                            MP3, WAV, OGG, M4A, FLAC ‚Äî max. 10MB pro Datei
                        </p>
                        <input ref={fileInputRef} type="file" accept=".mp3,.wav,.ogg,.m4a,.webm,.flac"
                            multiple onChange={handleUpload} style={{display:'none'}} />
                        <button className="btn btn-primary" disabled={uploading}
                            onClick={() => fileInputRef.current?.click()}>
                            {uploading ? '‚è≥ Wird hochgeladen...' : 'Dateien w√§hlen'}
                        </button>
                        <p style={{marginTop:12,fontSize:12,color:'var(--text-dim)'}}>
                            üí° Tipp: Lade ein komplettes Caller-Soundpack hoch! Benenne die Dateien z.B.
                            "1.mp3" bis "180.mp3" f√ºr Score-Ansagen.
                        </p>
                    </div>
                </div>
            )}

            {/* ‚îÄ‚îÄ‚îÄ File Manager ‚îÄ‚îÄ‚îÄ */}
            {showFileManager && (
                <div className="card" style={{marginBottom:16}}>
                    <div style={{fontWeight:600,marginBottom:12}}>üìÅ Hochgeladene Sounds ({files.length})</div>
                    {files.length === 0 ? (
                        <p style={{color:'var(--text-dim)',fontSize:13}}>Keine Sound-Dateien vorhanden. Lade welche hoch!</p>
                    ) : (
                        <div style={{maxHeight:300,overflowY:'auto'}}>
                            <table style={{width:'100%',fontSize:13,borderCollapse:'collapse'}}>
                                <thead>
                                    <tr style={{borderBottom:'1px solid var(--border)',textAlign:'left'}}>
                                        <th style={{padding:'4px 8px'}}>Datei</th>
                                        <th style={{padding:'4px 8px'}}>Gr√∂√üe</th>
                                        <th style={{padding:'4px 8px',width:100}}>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {files.map(f => (
                                        <tr key={f.filename} style={{borderBottom:'1px solid var(--border)'}}>
                                            <td style={{padding:'4px 8px',fontFamily:'monospace',fontSize:12}}>{f.filename}</td>
                                            <td style={{padding:'4px 8px',color:'var(--text-dim)'}}>{(f.size/1024).toFixed(0)} KB</td>
                                            <td style={{padding:'4px 8px'}}>
                                                <div style={{display:'flex',gap:4}}>
                                                    <button className="btn btn-sm" title="Abspielen"
                                                        onClick={() => { const a = new Audio(`/sounds/${f.filename}`); a.volume = config?.volume || 0.8; a.play(); }}>
                                                        ‚ñ∂
                                                    </button>
                                                    <button className="btn btn-sm btn-danger" title="L√∂schen"
                                                        onClick={() => deleteFile(f.filename)}>
                                                        ‚úï
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            )}

            {/* ‚îÄ‚îÄ‚îÄ Bulk Toolbar ‚îÄ‚îÄ‚îÄ */}
            {bulkMode && (
                <div className="card" style={{marginBottom:16,borderColor:'var(--accent)',background:'rgba(var(--accent-rgb),0.05)'}}>
                    <div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap'}}>
                        <span style={{fontSize:13,fontWeight:600}}>{selected.size} ausgew√§hlt</span>
                        <select value={bulkSound} onChange={e => setBulkSound(e.target.value)}
                            style={{background:'var(--bg-card)',color:'var(--text)',border:'1px solid var(--border)',borderRadius:4,padding:'4px 8px',fontSize:13,flex:'1 1 150px'}}>
                            <option value="">‚Äî Kein Sound ‚Äî</option>
                            {files.map(f => <option key={f.filename} value={f.filename}>{f.filename}</option>)}
                        </select>
                        <button className="btn btn-sm btn-primary" onClick={bulkAssignSound} disabled={selected.size===0}>
                            Sound zuweisen
                        </button>
                        <button className="btn btn-sm btn-success" onClick={() => bulkToggle(true)} disabled={selected.size===0}>
                            ‚úì Aktivieren
                        </button>
                        <button className="btn btn-sm" onClick={() => bulkToggle(false)} disabled={selected.size===0}>
                            ‚óã Deaktivieren
                        </button>
                        <button className="btn btn-sm" onClick={() => setSelected(new Set())}>
                            Auswahl aufheben
                        </button>
                    </div>
                </div>
            )}

            {/* ‚îÄ‚îÄ‚îÄ Sound Events by Category ‚îÄ‚îÄ‚îÄ */}
            {catOrder.filter(cat => grouped[cat] && grouped[cat].length > 0).map(cat => {
                const catInfo = categories[cat] || {};
                const items = grouped[cat] || [];
                const expanded = expandedCats[cat] !== false; // default open
                const assignedInCat = items.filter(i => i.sound).length;
                const isScoreCategory = cat === 'score_calling' || cat === 'checkout';
                const defaultCollapsed = isScoreCategory && !search;

                // Auto-collapse large categories unless searching
                const isOpen = search ? true : (expandedCats[cat] ?? !defaultCollapsed);

                return (
                    <div key={cat} className="card" style={{marginBottom:12}}>
                        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',cursor:'pointer',userSelect:'none'}}
                            onClick={() => setExpandedCats(prev => ({...prev, [cat]: !isOpen}))}>
                            <div style={{display:'flex',alignItems:'center',gap:8}}>
                                {bulkMode && (
                                    <input type="checkbox"
                                        checked={items.every(i => selected.has(i.key))}
                                        onChange={() => selectAllInCat(cat)}
                                        onClick={e => e.stopPropagation()} />
                                )}
                                <span style={{fontSize:18}}>{catInfo.label?.split(' ')[0] || 'üì¶'}</span>
                                <div>
                                    <div style={{fontWeight:600,fontSize:14}}>
                                        {catInfo.label || cat}
                                    </div>
                                    <div style={{fontSize:11,color:'var(--text-dim)'}}>
                                        {items.length} Events ¬∑ {assignedInCat} mit Sound
                                    </div>
                                </div>
                            </div>
                            <span style={{fontSize:18,transition:'transform 0.2s',transform:isOpen?'rotate(0)':'rotate(-90deg)'}}>‚ñº</span>
                        </div>

                        {isOpen && (
                            <div style={{marginTop:12}}>
                                {/* Smart auto-assign hint for score categories */}
                                {cat === 'score_calling' && files.length > 0 && assignedInCat === 0 && (
                                    <div style={{padding:'8px 12px',background:'rgba(0,150,255,0.08)',borderRadius:6,marginBottom:12,fontSize:13}}>
                                        üí° <strong>Auto-Zuweisen:</strong> Wenn deine Sound-Dateien "0.mp3" bis "180.mp3" hei√üen,
                                        <button className="btn btn-sm btn-primary" style={{marginLeft:8}}
                                            onClick={async () => {
                                                const updates = {};
                                                for (let i = 0; i <= 180; i++) {
                                                    const match = files.find(f => f.filename === `${i}.mp3` || f.filename === `${i}.wav` || f.filename === `${i}.ogg`);
                                                    if (match) updates[`caller_score_${i}`] = { sound: match.filename };
                                                }
                                                const count = Object.keys(updates).length;
                                                if (count > 0) {
                                                    await API.post('/api/caller/sounds', updates);
                                                    toast(`${count} Score-Sounds automatisch zugewiesen!`, 'success');
                                                    await loadAll();
                                                } else {
                                                    toast('Keine passenden Dateien gefunden (0.mp3 ‚Äì 180.mp3)', 'info');
                                                }
                                            }}>
                                            Auto-Zuweisen
                                        </button>
                                    </div>
                                )}

                                {/* Auto-assign hint for single dart names */}
                                {cat === 'single_dart_name' && files.length > 0 && assignedInCat === 0 && (
                                    <div style={{padding:'8px 12px',background:'rgba(0,150,255,0.08)',borderRadius:6,marginBottom:12,fontSize:13}}>
                                        üí° <strong>Auto-Zuweisen:</strong> Dateien wie "s1.mp3"‚Äì"s20.mp3", "d1.mp3"‚Äì"d20.mp3", "t1.mp3"‚Äì"t20.mp3"?
                                        <button className="btn btn-sm btn-primary" style={{marginLeft:8}}
                                            onClick={async () => {
                                                const updates = {};
                                                ['s','d','t'].forEach(prefix => {
                                                    for (let n = 1; n <= 20; n++) {
                                                        const match = files.find(f => f.filename === `${prefix}${n}.mp3` || f.filename === `${prefix}${n}.wav`);
                                                        if (match) updates[`caller_${prefix}${n}`] = { sound: match.filename };
                                                    }
                                                });
                                                ['bull','bullseye','miss'].forEach(name => {
                                                    const match = files.find(f => f.filename === `${name}.mp3` || f.filename === `${name}.wav`);
                                                    if (match) updates[`caller_${name}`] = { sound: match.filename };
                                                });
                                                const count = Object.keys(updates).length;
                                                if (count > 0) {
                                                    await API.post('/api/caller/sounds', updates);
                                                    toast(`${count} Feld-Sounds automatisch zugewiesen!`, 'success');
                                                    await loadAll();
                                                } else {
                                                    toast('Keine passenden Dateien gefunden', 'info');
                                                }
                                            }}>
                                            Auto-Zuweisen
                                        </button>
                                    </div>
                                )}

                                {items.map(item => (
                                    <div key={item.key} style={{
                                        display:'flex',alignItems:'center',gap:8,padding:'6px 0',
                                        borderBottom:'1px solid var(--border)',flexWrap:'wrap',
                                        opacity: item.enabled === false ? 0.4 : 1,
                                    }}>
                                        {bulkMode && (
                                            <input type="checkbox" checked={selected.has(item.key)}
                                                onChange={() => toggleSelect(item.key)} />
                                        )}

                                        {/* Enable toggle */}
                                        <button style={{
                                            background:'none',border:'none',cursor:'pointer',fontSize:16,padding:0,
                                            color: item.enabled !== false ? 'var(--success)' : 'var(--text-dim)',
                                        }} title={item.enabled !== false ? 'Aktiv' : 'Deaktiviert'}
                                            onClick={() => updateSound(item.key, 'enabled', !(item.enabled !== false))}>
                                            {item.enabled !== false ? '‚óè' : '‚óã'}
                                        </button>

                                        {/* Label */}
                                        <div style={{flex:'1 1 140px',minWidth:100}}>
                                            <div style={{fontSize:13,fontWeight:500}}>{item.label}</div>
                                            <div style={{fontSize:10,color:'var(--text-dim)',fontFamily:'monospace'}}>{item.key}</div>
                                        </div>

                                        {/* Sound selector */}
                                        <select value={item.sound || ''}
                                            onChange={e => updateSound(item.key, 'sound', e.target.value || null)}
                                            style={{
                                                flex:'1 1 160px',minWidth:120,maxWidth:250,
                                                background:'var(--bg-card)',color:'var(--text)',
                                                border:`1px solid ${item.sound ? 'var(--success)' : 'var(--border)'}`,
                                                borderRadius:4,padding:'4px 6px',fontSize:12,
                                            }}>
                                            <option value="">‚Äî Kein Sound ‚Äî</option>
                                            {files.map(f => (
                                                <option key={f.filename} value={f.filename}>{f.filename}</option>
                                            ))}
                                        </select>

                                        {/* Volume */}
                                        <div style={{display:'flex',alignItems:'center',gap:4,flex:'0 0 auto'}}>
                                            <input type="range" min="0" max="100"
                                                value={Math.round((item.volume ?? 1.0) * 100)}
                                                onChange={e => updateSound(item.key, 'volume', parseInt(e.target.value) / 100)}
                                                style={{width:60}} />
                                            <span style={{fontSize:10,minWidth:28,color:'var(--text-dim)'}}>
                                                {Math.round((item.volume ?? 1.0) * 100)}%
                                            </span>
                                        </div>

                                        {/* Test button */}
                                        <button className="btn btn-sm" onClick={() => testSound(item.key)}
                                            title="Abspielen" disabled={!item.sound}
                                            style={{padding:'2px 8px',fontSize:14}}>
                                            ‚ñ∂
                                        </button>

                                        {/* Dirty indicator */}
                                        {dirty.has(item.key) && (
                                            <span style={{color:'var(--accent)',fontSize:10}}>‚óè</span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            })}

            {/* ‚îÄ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ‚îÄ */}
            {filteredSounds.length === 0 && (
                <div className="card" style={{textAlign:'center',padding:48}}>
                    <div style={{fontSize:48,marginBottom:16}}>üîá</div>
                    <h3 style={{marginBottom:8}}>Keine Treffer</h3>
                    <p style={{color:'var(--text-dim)'}}>Passe die Suche oder den Filter an.</p>
                </div>
            )}

            {/* ‚îÄ‚îÄ‚îÄ Save All ‚îÄ‚îÄ‚îÄ */}
            {dirty.size > 0 && (
                <div style={{position:'sticky',bottom:16,zIndex:50,display:'flex',justifyContent:'center',marginTop:20}}>
                    <button className="btn btn-primary" onClick={saveDirty}
                        style={{padding:'12px 32px',fontSize:16,borderRadius:24,boxShadow:'0 4px 20px rgba(0,0,0,0.3)'}}>
                        üíæ {dirty.size} √Ñnderung(en) speichern
                    </button>
                </div>
            )}

            {/* ‚îÄ‚îÄ‚îÄ Test Center ‚îÄ‚îÄ‚îÄ */}
            <div className="card" style={{marginTop:20}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
                    <div style={{fontWeight:700,fontSize:15}}>üß™ Test-Center</div>
                    <span style={{fontSize:12,color:'var(--text-dim)'}}>
                        Simuliert echte Spielereignisse durch die komplette Caller-Pipeline
                    </span>
                </div>

                {/* Throw Simulator */}
                <div style={{marginBottom:16}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:8,color:'var(--text-secondary)'}}>üéØ Einzelwurf simulieren</div>
                    <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                        {[
                            {label:'S20', n:20, m:1},
                            {label:'D20', n:20, m:2},
                            {label:'T20', n:20, m:3},
                            {label:'S1', n:1, m:1},
                            {label:'D16', n:16, m:2},
                            {label:'T19', n:19, m:3},
                            {label:'Bull', n:25, m:1},
                            {label:'Bullseye', n:25, m:2},
                            {label:'Miss', n:0, m:0},
                        ].map(t => (
                            <button key={t.label} className="btn btn-sm"
                                style={{fontSize:12,minWidth:60}}
                                onClick={async () => {
                                    const r = await API.post('/api/caller/test-scenario', {
                                        scenario:'throw', params:{number:t.n, multiplier:t.m, ring: t.n===0?'Miss':''}
                                    });
                                    if (r?.success) toast(`üéØ ${t.label} gesendet (${r.sounds_sent.length} Sounds)`, 'info');
                                    else toast(`Kein Sound f√ºr ${t.label}`, 'warning');
                                }}>
                                {t.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Round Scores */}
                <div style={{marginBottom:16}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:8,color:'var(--text-secondary)'}}>üìä Rundenscore simulieren</div>
                    <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                        {[0, 3, 26, 41, 60, 85, 100, 120, 140, 160, 180].map(s => (
                            <button key={s} className="btn btn-sm"
                                style={{
                                    fontSize:12, minWidth:48,
                                    borderColor: s >= 180 ? 'var(--success)' : s >= 100 ? 'var(--accent)' : s < 20 ? 'var(--danger)' : undefined,
                                    color: s >= 180 ? 'var(--success)' : s >= 100 ? 'var(--accent)' : s < 20 ? 'var(--danger)' : undefined,
                                }}
                                onClick={async () => {
                                    const r = await API.post('/api/caller/test-scenario', {
                                        scenario:'round_score', params:{round_score: s, score: s}
                                    });
                                    if (r?.success) toast(`üìä Score ${s} (${r.sounds_sent.length} Sounds)`, 'info');
                                }}>
                                {s}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Game Events */}
                <div style={{marginBottom:16}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:8,color:'var(--text-secondary)'}}>üèÜ Spielereignisse</div>
                    <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                        {[
                            {label:'üé¨ Game On', scenario:'game_on'},
                            {label:'üèÜ Game Won', scenario:'game_won'},
                            {label:'ü•á Match Won', scenario:'match_won'},
                            {label:'üí• Busted', scenario:'busted'},
                            {label:'üìã Board Ready', scenario:'board_ready'},
                            {label:'üéØ Takeout', scenario:'board_takeout'},
                        ].map(e => (
                            <button key={e.scenario} className="btn btn-sm"
                                style={{fontSize:12}}
                                onClick={async () => {
                                    const r = await API.post('/api/caller/test-scenario', {scenario: e.scenario, params:{}});
                                    if (r?.success) toast(`${e.label} (${r.sounds_sent.length} Sounds)`, 'info');
                                }}>
                                {e.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Checkout */}
                <div style={{marginBottom:8}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:8,color:'var(--text-secondary)'}}>üéØ Checkout-Ansage</div>
                    <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                        {[170, 120, 80, 60, 40, 32, 16, 8, 2].map(c => (
                            <button key={c} className="btn btn-sm"
                                style={{fontSize:12,minWidth:48}}
                                onClick={async () => {
                                    const r = await API.post('/api/caller/test-scenario', {
                                        scenario:'checkout', params:{rest: c}
                                    });
                                    if (r?.success) toast(`üéØ Checkout ${c} (${r.sounds_sent.length} Sounds)`, 'info');
                                }}>
                                {c}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Full Leg Simulation */}
                <div style={{borderTop:'1px solid var(--border)',marginTop:16,paddingTop:12}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:8,color:'var(--text-secondary)'}}>üîÅ Komplettes Leg simulieren</div>
                    <p style={{fontSize:12,color:'var(--text-dim)',marginBottom:8}}>
                        Spielt eine realistische Spielsequenz ab: Game On ‚Üí 3 W√ºrfe ‚Üí Rundenscore ‚Üí Checkout ‚Üí Game Won
                    </p>
                    <button className="btn btn-primary btn-sm" style={{fontSize:12}}
                        onClick={async () => {
                            toast('üîÅ Leg-Simulation gestartet...', 'info');
                            const delay = ms => new Promise(r => setTimeout(r, ms));
                            // Game On
                            await API.post('/api/caller/test-scenario', {scenario:'game_on', params:{}});
                            await delay(2000);
                            // 3 throws: T20, T20, T20
                            for (const t of [{n:20,m:3},{n:20,m:3},{n:20,m:3}]) {
                                await API.post('/api/caller/test-scenario', {scenario:'throw', params:{number:t.n, multiplier:t.m}});
                                await delay(1500);
                            }
                            // Round score 180
                            await API.post('/api/caller/test-scenario', {scenario:'round_score', params:{score:180}});
                            await delay(3000);
                            // Checkout call
                            await API.post('/api/caller/test-scenario', {scenario:'checkout', params:{rest:141}});
                            await delay(2500);
                            // T20, T19, D12 ‚Üí finish
                            for (const t of [{n:20,m:3},{n:19,m:3},{n:12,m:2}]) {
                                await API.post('/api/caller/test-scenario', {scenario:'throw', params:{number:t.n, multiplier:t.m}});
                                await delay(1500);
                            }
                            // Game Won
                            await API.post('/api/caller/test-scenario', {scenario:'game_won', params:{}});
                            toast('üèÜ Leg-Simulation beendet!', 'success');
                        }}>
                        ‚ñ∂ Leg-Simulation starten
                    </button>
                </div>

                <div style={{fontSize:11,color:'var(--text-dim)',marginTop:12,fontStyle:'italic'}}>
                    üí° Die Tests nutzen die echte Pipeline ‚Äî Caller muss aktiviert sein und Sounds m√ºssen zugewiesen sein.
                    Der aktive Dart-Modus (Score / Feldname / Effekt) bestimmt welche Sounds bei Einzelw√ºrfen gespielt werden.
                </div>
            </div>

            {/* ‚îÄ‚îÄ‚îÄ Info Box ‚îÄ‚îÄ‚îÄ */}
            <div className="card" style={{marginTop:20,fontSize:13,color:'var(--text-dim)'}}>
                <div style={{fontWeight:600,marginBottom:8}}>‚ÑπÔ∏è So funktioniert der Caller</div>
                <p style={{marginBottom:6}}>
                    Sounds werden direkt im Browser abgespielt. Das Ger√§t mit dem offenen LED Manager
                    muss also Lautsprecher haben (Handy, Tablet, Laptop oder Bluetooth-Box).
                </p>
                <p style={{marginBottom:6}}>
                    <strong>Score-Ansage (0‚Äì180):</strong> Lade f√ºr jeden Rundenscore eine Sound-Datei hoch.
                    Benenne sie "0.mp3" bis "180.mp3" f√ºr Auto-Zuweisung.
                </p>
                <p style={{marginBottom:6}}>
                    <strong>Feld-Ansage:</strong> F√ºr jeden Einzelwurf (S1‚ÄìS20, D1‚ÄìD20, T1‚ÄìT20, Bull, Bullseye).
                    Dateien: "s1.mp3"‚Äì"s20.mp3", "d1.mp3"‚Äì"d20.mp3", "t1.mp3"‚Äì"t20.mp3".
                </p>
                <p>
                    <strong>Priorit√§t:</strong> Spezifischer Sound ‚Üí Generischer Fallback ‚Üí Kein Sound.
                    Mehrere Sounds pro Event werden nacheinander abgespielt (z.B. Score + Ambient).
                </p>
            </div>
        </div>
    );
}


function App() {
    const [activePage, setActivePage] = useState('dashboard');
    window.__setPage = setActivePage;
    const [devices, setDevices] = useState([]);
    const [autodartsConnected, setAutodartsConnected] = useState(false);
    const [boardCount, setBoardCount] = useState(0);
    const [updateInfo, setUpdateInfo] = useState(null);
    const [updateStep, setUpdateStep] = useState(null); // live progress from WS
    const [appVersion, setAppVersion] = useState('');
    const { lastMessage } = useWebSocket();

    const refreshDevices = async () => {
        const data = await API.get('/api/devices');
        if (data?.devices) setDevices(data.devices);
    };

    const checkAutodarts = async () => {
        const data = await API.get('/api/autodarts/status');
        if (data) {
            setAutodartsConnected(data.any_connected || false);
            setBoardCount(data.boards?.length || 0);
        }
    };

    const checkUpdate = async () => {
        const data = await API.get('/api/update/check');
        if (data && !data.error) setUpdateInfo(data);
    };

    useEffect(() => {
        refreshDevices();
        checkAutodarts();
        checkUpdate();
        API.get('/api/update/check').then(d => { if (d?.local_version) setAppVersion(d.local_version); });
        const interval = setInterval(() => {
            refreshDevices();
            checkAutodarts();
        }, 10000);
        const updateInterval = setInterval(checkUpdate, 30 * 60 * 1000);
        return () => { clearInterval(interval); clearInterval(updateInterval); };
    }, []);

    // ‚îÄ‚îÄ‚îÄ Caller Audio Engine (v2 ‚Äî Priority, Preload, Interrupt) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const audioCache = useRef({});
    const audioQueue = useRef([]);
    const audioPlaying = useRef(false);
    const currentAudio = useRef(null);
    const preloaded = useRef(false);

    // Preload all assigned sounds on first load
    useEffect(() => {
        if (preloaded.current) return;
        preloaded.current = true;
        API.get('/api/caller/sounds').then(data => {
            if (!data?.sounds) return;
            const files = new Set();
            Object.values(data.sounds).forEach(s => { if (s.sound) files.add(s.sound); });
            files.forEach(f => {
                const url = f.startsWith('http') ? f : `/sounds/${f}`;
                const a = new Audio();
                a.preload = 'auto';
                a.src = url;
                audioCache.current[url] = a;
            });
            console.log(`Caller: ${files.size} Sounds vorgeladen`);
        });
    }, []);

    const playCallerQueue = useCallback(async () => {
        if (audioPlaying.current) return;
        audioPlaying.current = true;
        // Duck music while caller speaks
        window.dispatchEvent(new Event('throwsync-duck'));
        while (audioQueue.current.length > 0) {
            const item = audioQueue.current.shift();
            try {
                let audio = audioCache.current[item.url];
                if (!audio) {
                    audio = new Audio(item.url);
                    audioCache.current[item.url] = audio;
                }
                audio.volume = Math.min(1, Math.max(0, (item.globalVol || 0.8) * (item.vol || 1.0)));
                audio.currentTime = 0;
                currentAudio.current = audio;
                await new Promise((resolve, reject) => {
                    // Timeout: skip sound if it takes >4s
                    const timeout = setTimeout(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        resolve();
                    }, 4000);
                    audio.onended = () => { clearTimeout(timeout); resolve(); };
                    audio.onerror = () => { clearTimeout(timeout); resolve(); }; // Don't reject, just skip
                    audio.play().catch(() => { clearTimeout(timeout); resolve(); });
                });
                currentAudio.current = null;
            } catch (e) {
                console.warn('Caller audio error:', e);
            }
        }
        audioPlaying.current = false;
        // Restore music volume
        window.dispatchEvent(new Event('throwsync-restore'));
    }, []);

    // ‚îÄ‚îÄ‚îÄ Video/Clip Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const [activeClip, setActiveClip] = useState(null); // {url, duration}

    // Listen for test-clip events from ClipsTab
    useEffect(() => {
        const handler = (e) => {
            const { clip, duration } = e.detail;
            const clipUrl = clip.startsWith('http') ? clip : `/clips/${clip}`;
            setActiveClip({ url: clipUrl, duration: duration || 5 });
            setTimeout(() => setActiveClip(null), (duration || 5) * 1000);
        };
        window.addEventListener('throwsync-test-clip', handler);
        return () => window.removeEventListener('throwsync-test-clip', handler);
    }, []);

    useEffect(() => {
        if (lastMessage) {
            if (lastMessage.type === 'device_added' || lastMessage.type === 'device_removed') {
                refreshDevices();
            }
            // Caller sound playback
            if (lastMessage.type === 'caller_play' && lastMessage.sounds) {
                const globalVol = lastMessage.volume || 0.8;
                const priority = lastMessage.priority || 0; // 0=normal, 1=high (score), 2=critical (game won)

                // High priority: flush queue and interrupt current sound
                if (priority >= 1 && audioPlaying.current) {
                    audioQueue.current = [];
                    if (currentAudio.current) {
                        currentAudio.current.pause();
                        currentAudio.current.currentTime = 0;
                        currentAudio.current = null;
                    }
                    audioPlaying.current = false;
                }

                // Limit queue to 3 sounds max
                if (audioQueue.current.length > 3) {
                    audioQueue.current = audioQueue.current.slice(-2);
                }

                const sorted = [...lastMessage.sounds].sort((a, b) => (a.priority || 1) - (b.priority || 1));
                sorted.forEach(s => {
                    if (s.sound) {
                        const url = s.sound.startsWith('http') ? s.sound : `/sounds/${s.sound}`;
                        audioQueue.current.push({ url, vol: s.volume || 1.0, globalVol });
                    }
                });
                playCallerQueue();
            }

            // Video clip playback
            if (lastMessage.type === 'caller_clip' && lastMessage.clip) {
                const clipUrl = lastMessage.clip.startsWith('http') ? lastMessage.clip : `/clips/${lastMessage.clip}`;
                const duration = lastMessage.clip_duration || 5;
                setActiveClip({ url: clipUrl, duration });
                setTimeout(() => setActiveClip(null), duration * 1000);
            }

            // Crowd sound playback (separate channel, plays alongside caller)
            if (lastMessage.type === 'crowd_play' && lastMessage.sounds) {
                const globalVol = lastMessage.volume || 0.5;
                // Duck music for crowd sounds too
                window.dispatchEvent(new Event('throwsync-duck'));
                let maxDuration = 0;
                lastMessage.sounds.forEach(s => {
                    if (s.sound) {
                        const url = s.sound.startsWith('http') ? s.sound : `/sounds/${s.sound}`;
                        const audio = new Audio(url);
                        audio.volume = Math.min(1, Math.max(0, globalVol * (s.volume || 0.5)));
                        audio.onended = () => { maxDuration--; if (maxDuration <= 0) window.dispatchEvent(new Event('throwsync-restore')); };
                        audio.onerror = () => { maxDuration--; if (maxDuration <= 0) window.dispatchEvent(new Event('throwsync-restore')); };
                        maxDuration++;
                        audio.play().catch(() => { maxDuration--; if (maxDuration <= 0) window.dispatchEvent(new Event('throwsync-restore')); });
                    }
                });
                // Safety: restore after 6s if onended doesn't fire
                if (maxDuration > 0) setTimeout(() => window.dispatchEvent(new Event('throwsync-restore')), 6000);
            }

            // Achievement unlocked notification
            if (lastMessage.type === 'achievement_unlocked') {
                const a = lastMessage.achievement;
                if (a) {
                    // Show as persistent toast-style notification
                    const el = document.createElement('div');
                    el.innerHTML = `<div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:99999;
                        background:linear-gradient(135deg,rgba(139,92,246,0.95),rgba(59,130,246,0.95));
                        color:#fff;padding:16px 24px;border-radius:12px;display:flex;align-items:center;gap:12px;
                        box-shadow:0 8px 32px rgba(0,0,0,0.4);animation:slideDown 0.5s ease;font-family:system-ui">
                        <span style="font-size:36px">${a.icon}</span>
                        <div>
                            <div style="font-weight:800;font-size:11px;text-transform:uppercase;letter-spacing:2px;opacity:0.7">
                                üèÖ Achievement Unlocked!</div>
                            <div style="font-weight:700;font-size:18px">${a.name}</div>
                            <div style="font-size:12px;opacity:0.8">${lastMessage.player_name} ‚Äî ${a.desc}</div>
                        </div>
                    </div>`;
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 5000);
                }
            }

            // Update progress from background task
            if (lastMessage.type === 'update_status') {
                setUpdateStep(lastMessage);
                // Clear banner once restarting (page will auto-reload via WS reconnect)
                if (lastMessage.step === 'restarting') {
                    setUpdateInfo(null);
                }
                if (lastMessage.step === 'uptodate' || lastMessage.step === 'error') {
                    setTimeout(() => setUpdateStep(null), 5000);
                }
            }
        }
    }, [lastMessage]);

    const renderPage = () => {
        switch (activePage) {
            case 'dashboard': return <DashboardPage devices={devices} autodartsConnected={autodartsConnected} />;
            case 'devices': return <DevicesPage devices={devices} refreshDevices={refreshDevices} />;
            case 'leds': return <LEDControlPage devices={devices} />;
            case 'autodarts': return <AutodartsPage autodartsConnected={autodartsConnected} devices={devices} />;
            case 'events': return <EventsPage devices={devices} />;
            case 'players': return <PlayersPage />;
            case 'stats': return <StatsPage />;
            case 'achievements': return <AchievementsPage />;
            case 'music': return <MusicPage />;
            case 'led-designer': return <LEDDesignerPage />;
            case 'integrations': return <IntegrationsPage />;
            case 'flash': return <FlashPage devices={devices} />;
            case 'presets': return <PresetsPage devices={devices} />;
            case 'logs': return <LogsPage />;
            case 'settings': return <SettingsPage />;
            default: return <DashboardPage devices={devices} autodartsConnected={autodartsConnected} />;
        }
    };

    return (
        <ToastProvider>
            <MusicProvider>
            <div className="app-container">
                <Sidebar activePage={activePage} setActivePage={setActivePage} autodartsStatus={autodartsConnected} boardCount={boardCount} version={appVersion} />
                <main className="main-content" style={{paddingBottom: 72}}>
                    {/* Update Restart Overlay */}
                    {updateStep?.step === 'restarting' && (
                        <div style={{
                            position:'fixed',inset:0,zIndex:9999,
                            background:'rgba(0,0,0,0.85)',display:'flex',alignItems:'center',justifyContent:'center',
                        }}>
                            <div style={{textAlign:'center',color:'#fff'}}>
                                <div style={{fontSize:64,marginBottom:24,animation:'pulse 1.5s infinite'}}>üîÑ</div>
                                <h2 style={{marginBottom:12}}>Update wird installiert...</h2>
                                <p style={{color:'#999',marginBottom:24}}>Server startet neu. Seite aktualisiert sich automatisch.</p>
                                <div style={{width:200,height:4,background:'#333',borderRadius:2,margin:'0 auto'}}>
                                    <div style={{width:'60%',height:'100%',background:'var(--accent)',borderRadius:2,animation:'pulse 1.5s infinite'}}/>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Update Progress Banner (downloading/installing) */}
                    {updateStep && ['checking','downloading','installing','starting'].includes(updateStep.step) && (
                        <div style={{
                            background:'linear-gradient(135deg, rgba(0,150,255,0.12), rgba(0,200,100,0.08))',
                            border:'1px solid rgba(0,150,255,0.3)',borderRadius:10,
                            padding:'12px 16px',marginBottom:16,display:'flex',alignItems:'center',gap:12,
                        }}>
                            <div style={{
                                width:20,height:20,border:'3px solid var(--accent)',borderTopColor:'transparent',
                                borderRadius:'50%',animation:'spin 0.8s linear infinite',flexShrink:0,
                            }}/>
                            <div style={{flex:1,minWidth:0}}>
                                <div style={{fontWeight:600,fontSize:13}}>{updateStep.message}</div>
                                {updateStep.percent >= 0 && (
                                    <div style={{height:4,background:'var(--border)',borderRadius:2,marginTop:6,overflow:'hidden'}}>
                                        <div style={{width:`${updateStep.percent}%`,height:'100%',background:'var(--accent)',borderRadius:2,transition:'width 0.3s'}}/>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Update Available Banner */}
                    {updateInfo?.available && !updateStep && (
                        <div style={{
                            background:'linear-gradient(135deg, rgba(0,150,255,0.12), rgba(0,200,100,0.08))',
                            border:'1px solid rgba(0,150,255,0.3)',borderRadius:10,
                            padding:'12px 16px',marginBottom:16,display:'flex',alignItems:'center',gap:12,flexWrap:'wrap',
                        }}>
                            <span style={{fontSize:24}}>üÜï</span>
                            <div style={{flex:1,minWidth:200}}>
                                <div style={{fontWeight:700,fontSize:14}}>
                                    Update verf√ºgbar: v{updateInfo.remote_version}
                                </div>
                                <div style={{fontSize:12,color:'var(--text-dim)'}}>
                                    Installiert: v{updateInfo.local_version}
                                </div>
                            </div>
                            <button className="btn btn-sm btn-primary"
                                onClick={async () => {
                                    setUpdateStep({step:'starting',message:'Update wird gestartet...'});
                                    const r = await API.post('/api/update/apply');
                                    if (!r?.success) setUpdateStep(null);
                                }}>
                                üöÄ Jetzt updaten
                            </button>
                        </div>
                    )}

                    {renderPage()}
                </main>

                {/* Video/GIF Clip Overlay */}
                {activeClip && (
                    <div style={{
                        position: 'fixed', inset: 0, zIndex: 9998,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        background: 'rgba(0,0,0,0.75)', cursor: 'pointer',
                        animation: 'fadeIn 0.2s ease-out',
                    }} onClick={() => setActiveClip(null)}>
                        {activeClip.url.match(/\.(mp4|webm|mov)$/i) ? (
                            <video src={activeClip.url} autoPlay muted={false}
                                style={{maxWidth: '80vw', maxHeight: '80vh', borderRadius: 16, boxShadow: '0 0 60px rgba(0,0,0,0.5)'}}
                                onEnded={() => setActiveClip(null)} />
                        ) : (
                            <img src={activeClip.url}
                                style={{maxWidth: '80vw', maxHeight: '80vh', borderRadius: 16, boxShadow: '0 0 60px rgba(0,0,0,0.5)'}} />
                        )}
                    </div>
                )}

                {/* Persistent Mini Player */}
                <MiniPlayer />
            </div>
            </MusicProvider>
        </ToastProvider>
    );
}

ReactDOM.render(<I18nProvider><App /></I18nProvider>, document.getElementById('root'));

// Register PWA Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
